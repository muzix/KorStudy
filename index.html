<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blebleble</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #5782BB;
      --secondary-color: #e8f0fe;
      --text-color: #333;
      --light-gray: #f8f9fa;
      --border-color: #dee2e6;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Noto Sans KR', Arial, sans-serif;
      color: var(--text-color);
      line-height: 1.5;
      background-color: #f5f7fa;
    }
    
    .app-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Sidebar Styles */
    .sidebar {
      width: 200px;
      background-color: var(--primary-color);
      color: white;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    .app-logo {
      padding: 0 20px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: bold;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 20px;
    }
    
    .nav-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .nav-item:hover, .nav-item.active {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .dropdown {
      margin-top: 5px;
      margin-left: 20px;
      display: none;
    }
    
    .dropdown.active {
      display: block;
    }
    
    .dropdown-item {
      padding: 8px 20px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .dropdown-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    /* Main Content Styles */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .content-section {
      display: none;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .content-section.active {
      display: block;
    }
    
    /* Header Styles */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .section-header h2 {
      color: var(--primary-color);
      font-size: 22px;
    }
    
    /* Dictionary Styles */
    .search-bar {
      margin-bottom: 20px;
      width: 100%;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .filter {
      background-color: var(--secondary-color);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-color);
    }
    
    .filter.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .dictionary-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .word-card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
      transition: transform 0.2s ease;
      border: 1px solid var(--border-color);
    }
    
    .word-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .korean {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .pronunciation {
      color: #666;
      font-style: italic;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .translation {
      font-size: 16px;
      margin-bottom: 15px;
      color: #444;
    }
    
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .tag {
      background-color: var(--secondary-color);
      color: var(--primary-color);
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    
    .controls {
      display: flex;
      justify-content: space-between;
    }
    
    .listen-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .listen-btn:hover {
      background-color: #4a6d9d;
    }
    
    .audio-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      background-color: #4CAF50;
    }
    
    .audio-indicator.playing {
      background-color: #2196F3;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
    
    .stats {
      margin-bottom: 15px;
      color: #666;
      font-size: 14px;
    }
    
    .example {
      background-color: var(--light-gray);
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .example-korean {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .example-translation {
      color: #666;
      font-style: italic;
    }
    
    /* Study Section Styles */
    .study-options {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .study-card {
      flex: 1;
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      border: 1px solid var(--border-color);
    }
    
    .study-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .study-card h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    .flashcard-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }
    
    .flashcard {
      width: 100%;
      max-width: 500px;
      height: 300px;
      perspective: 1000px;
      margin-bottom: 20px;
    }
    
    .flashcard-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.6s;
      transform-style: preserve-3d;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    
    .flashcard.flipped .flashcard-inner {
      transform: rotateY(180deg);
    }
    
    .flashcard-front, .flashcard-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 20px;
      border-radius: 10px;
    }
    
    .flashcard-front {
      background-color: white;
      border: 1px solid var(--border-color);
    }
    
    .flashcard-back {
      background-color: var(--secondary-color);
      transform: rotateY(180deg);
      border: 1px solid var(--border-color);
    }
    
    .flashcard-word {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    
    .flashcard-hint {
      font-size: 16px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .flashcard-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px;
      font-size: 16px;
    }
    
    .flashcard-btn:hover {
      background-color: #4a6d9d;
    }
    
    .flashcard-controls {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    /* Settings Section Styles */
    .settings-container {
      max-width: 600px;
    }
    
    .settings-group {
      margin-bottom: 20px;
    }
    
    .settings-group h3 {
      margin-bottom: 10px;
      color: var(--primary-color);
    }
    
    .settings-option {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .settings-option label {
      margin-left: 10px;
    }
    
    .level-select {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      margin-top: 5px;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        padding: 10px;
      }
      
      .app-logo {
        padding: 10px;
        margin-bottom: 10px;
      }
      
      .dictionary-container {
        grid-template-columns: 1fr;
      }
      
      .study-options {
        flex-direction: column;
      }
    }
    
    /* Add new styles for study progress tracking */
    
    /* Add styles after the existing flashcard styles */
    
    .study-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      width: 100%;
      max-width: 500px;
    }
    
    .back-btn {
      background-color: transparent;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      font-size: 14px;
      padding: 5px 0;
    }
    
    #progress-counter {
      font-size: 14px;
      color: #666;
    }
    
    .card-counter {
      margin-bottom: 10px;
      color: #666;
      font-size: 14px;
      text-align: center;
      width: 100%;
      max-width: 500px;
    }
    
    .flashcard-progress {
      margin-top: 15px;
      padding: 8px 15px;
      background-color: #e8f5e9;
      border-radius: 5px;
      font-size: 14px;
      color: #388e3c;
    }
    
    .flashcard-progress.new {
      background-color: #e3f2fd;
      color: #1565c0;
    }
    
    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    /* Count bug fix */
    .stats {
      margin-bottom: 15px;
      color: #666;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }
    
    .dictionary-info {
      color: #5782BB;
      font-weight: bold;
    }
    
    /* Quiz Styles */
    .quiz-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    
    .quiz-card {
      width: 100%;
      max-width: 600px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    
    .question-container {
      margin-bottom: 20px;
      text-align: center;
    }
    
    .question-text {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .question-audio {
      margin: 10px 0;
    }
    
    .audio-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
    }
    
    .answers-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .answer-option {
      padding: 15px;
      background-color: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
    }
    
    .answer-option:hover {
      background-color: #e9e9e9;
    }
    
    .answer-option.selected {
      background-color: #d4e6f9;
      border-color: var(--primary-color);
    }
    
    .answer-option.correct {
      background-color: #d4edda;
      border-color: #28a745;
    }
    
    .answer-option.incorrect {
      background-color: #f8d7da;
      border-color: #dc3545;
    }
    
    .quiz-controls {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .quiz-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .quiz-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    
    .quiz-score {
      font-size: 16px;
      margin-bottom: 10px;
      font-weight: bold;
      align-self: flex-end;
      margin-right: 20px;
    }
    
    .quiz-feedback {
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    
    .quiz-feedback.correct {
      background-color: #d4edda;
      color: #155724;
      display: block;
    }
    
    .quiz-feedback.incorrect {
      background-color: #f8d7da;
      color: #721c24;
      display: block;
    }
    
    .quiz-results {
      width: 100%;
      max-width: 500px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 30px;
      text-align: center;
      border: 1px solid var(--border-color);
    }
    
    .quiz-results h3 {
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    
    .final-score {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    
    .quiz-stats {
      margin-bottom: 30px;
    }
    
    /* Writing Practice Styles */
    .writing-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    
    .writing-card {
      width: 100%;
      max-width: 500px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    
    .writing-prompt {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .writing-character {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .writing-pronunciation {
      font-size: 16px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .writing-area {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    #writing-canvas {
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fff;
      margin-bottom: 10px;
    }
    
    .writing-tools {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .writing-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .writing-controls {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .writing-feedback {
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    
    .progress-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .stats-card, .word-of-day-card, .recent-activity, .export-import {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .progress-stats {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    .activity-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .activity-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }

    .action-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      width: 100%;
    }

    .action-btn:hover {
      background: #4a6d9d;
    }

    .progress-bar-container {
      width: 100%;
      height: 20px;
      background-color: #f0f0f0;
      border-radius: 10px;
      margin-top: 15px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background-color: var(--primary-color);
      width: 0%;
      transition: width 0.3s ease;
    }

    .word-of-day-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .word-of-day-card .korean {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .word-of-day-card .pronunciation {
      font-size: 18px;
      color: #666;
      margin-bottom: 10px;
    }

    .word-of-day-card .translation {
      font-size: 20px;
      margin-bottom: 15px;
    }

    /* Grammar Section Styles */
    .grammar-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .grammar-lesson {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .grammar-explanation {
      margin-bottom: 30px;
    }

    .grammar-content {
      background-color: var(--light-gray);
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .sentence-practice {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .sentence-builder {
      margin-top: 20px;
    }

    .sentence-prompt {
      font-size: 18px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: var(--secondary-color);
      border-radius: 8px;
    }

    .word-bank {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: var(--light-gray);
      border-radius: 8px;
    }

    .word-item {
      background-color: white;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      border: 1px solid var(--border-color);
      transition: all 0.2s;
    }

    .word-item:hover {
      background-color: var(--primary-color);
      color: white;
    }

    .sentence-construction {
      min-height: 60px;
      padding: 15px;
      background-color: var(--light-gray);
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .sentence-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .grammar-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .grammar-btn:hover {
      background-color: #4a6d9d;
    }

    .sentence-feedback {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }

    .sentence-feedback.correct {
      background-color: #e8f5e9;
      color: #2e7d32;
      display: block;
    }

    .sentence-feedback.incorrect {
      background-color: #ffebee;
      color: #c62828;
      display: block;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="app-logo">
        <span>Blebleble</span>
      </div>
      
      <div class="nav-item active" data-section="dictionary">Dictionary</div>
      <div class="nav-item" data-section="study">Study</div>
      <div class="nav-item" data-section="settings">Settings</div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <!-- Dictionary Section -->
      <div id="dictionary-section" class="content-section active">
        <div class="section-header">
          <h2>Korean Dictionary</h2>
        </div>
        
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search for Korean words, English meanings, or pronunciation...">
        </div>
        
        <div class="filters-wrapper" style="position: relative; margin-bottom: 15px;">
          <div class="filters" id="main-filters" style="display: flex; overflow-x: auto; white-space: nowrap; padding-bottom: 10px; scrollbar-width: thin;">
            <div class="filter active" data-category="All">All</div>
            <div class="filter" data-category="Common">Common</div>
            <div class="filter" data-category="Greetings">Greetings</div>
            <div class="filter" data-category="Food">Food</div>
            <div class="filter" data-category="Places">Places</div>
            <div class="filter" data-category="Family">Family</div>
            <div class="filter" data-category="Time">Time</div>
            <div class="filter" data-category="Verbs">Verbs</div>
            <div class="filter" data-category="Adjectives">Adjectives</div>
            <div class="filter" data-category="Numbers">Numbers</div>
            <div class="filter" data-category="Transportation">Transportation</div>
            <div class="filter" data-category="Emotions">Emotions</div>
            <div class="filter" data-category="Weather">Weather</div>
            <div class="filter" data-category="Education">Education</div>
            <div class="filter" data-category="Technology">Technology</div>
            <div class="filter" data-category="Shopping">Shopping</div>
            <div class="filter" data-category="Travel">Travel</div>
            <div class="filter" data-category="Health">Health</div>
            <div class="filter" data-category="MZ">Modern Slang</div>
            <div class="filter" data-category="Responses">Responses</div>
          </div>
          <div class="scroll-indicators" style="position: absolute; top: 0; right: 0; bottom: 10px; pointer-events: none; display: flex; align-items: center;">
            <div class="scroll-right-indicator" style="background: linear-gradient(to right, transparent, white); width: 30px; height: 100%;"></div>
          </div>
        </div>
        
        <div class="stats">
          <span><span id="word-count">0</span> words found</span>
          <span class="dictionary-info">Total: <span id="total-words"></span> words in dictionary</span>
        </div>
        
        <div class="dictionary-container" id="dictionary-container">
          <!-- Words will be added here dynamically -->
        </div>
      </div>
      
      <!-- Study Section -->
      <div id="study-section" class="content-section">
        <div class="section-header">
          <h2>Study Korean</h2>
        </div>
        
        <div class="study-options">
          <div class="study-card" id="flashcards-option">
            <h3>Flashcards</h3>
            <p>Practice vocabulary with interactive flashcards</p>
          </div>
          
          <div class="study-card" id="quiz-option">
            <h3>Quiz</h3>
            <p>Test your knowledge with multiple choice questions</p>
          </div>
          
          <div class="study-card" id="new-words-quiz-option">
            <h3>New Words Quiz</h3>
            <p>Test your memory of recently learned words</p>
          </div>
          
          <div class="study-card" id="writing-option">
            <h3>Writing Practice</h3>
            <p>Practice writing Korean characters</p>
          </div>
          
          <div class="study-card" id="numbers-option">
            <h3>Numbers</h3>
            <p>Learn and practice Korean number systems</p>
          </div>
        </div>

        <!-- Add New Words Quiz Container -->
        <div class="new-words-quiz-container" style="display: none;">
          <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
            <div class="study-header">
              <button class="back-btn" id="back-from-new-words-quiz">‚Üê Back to Study Options</button>
            </div>
            
            <div class="quiz-card" style="margin: 20px 0; text-align: center;">
              <div class="question-container">
                <div class="question-text" id="new-words-question-text" style="font-size: 32px; font-weight: bold; margin-bottom: 15px;"></div>
                <div class="question-hint" id="new-words-question-hint" style="color: #666; font-style: italic; margin: 10px 0; font-size: 16px;"></div>
                <div class="question-audio" style="margin: 15px 0;">
                  <button id="new-words-audio-btn" class="audio-btn" style="width: 50px; height: 50px; font-size: 24px;">üîä</button>
                </div>
              </div>
              
              <div class="answers-container" id="new-words-answers-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px auto; max-width: 600px; padding: 0 20px;">
                <!-- Answer options will be added here dynamically -->
              </div>
            </div>
            
            <div class="quiz-controls" style="text-align: center; margin-top: 20px;">
              <button class="quiz-btn" id="check-new-words-answer-btn">Check Answer</button>
              <button class="quiz-btn" id="next-new-words-btn" style="margin-left: 10px;">Next Word</button>
            </div>
            
            <div class="quiz-feedback" id="new-words-quiz-feedback" style="max-width: 600px; margin: 20px auto;"></div>
          </div>
        </div>

        <div class="flashcard-container" style="display: none;">
          <div class="study-header">
            <button class="back-btn" id="back-to-study">‚Üê Back to Study Options</button>
            <div id="progress-counter">0/0 words studied</div>
          </div>
          
          <div class="card-counter" id="card-counter">Card 1 of 0</div>
          
          <div class="flashcard">
            <div class="flashcard-inner">
              <div class="flashcard-front">
                <div class="flashcard-word" id="flashcard-front-word"></div>
                <div class="flashcard-hint" id="flashcard-front-hint">Click to reveal answer</div>
              </div>
              <div class="flashcard-back">
                <div class="flashcard-word" id="flashcard-back-word"></div>
                <div class="flashcard-hint" id="flashcard-back-hint"></div>
                <div class="flashcard-progress" id="flashcard-progress-status">New Word</div>
              </div>
            </div>
          </div>
          
          <div class="flashcard-controls">
            <button class="flashcard-btn" id="prev-btn">Previous</button>
            <button class="flashcard-btn" id="flip-btn">Flip Card</button>
            <button class="flashcard-btn" id="play-audio-btn">üîä Play Audio</button>
            <button class="flashcard-btn" id="next-btn">Next</button>
          </div>
        </div>
        
        <div class="quiz-container" style="display: none;">
          <div class="study-header">
            <button class="back-btn" id="back-from-quiz">‚Üê Back to Study Options</button>
            <div id="quiz-progress">Question 1 of 10</div>
          </div>
          
          <div class="quiz-score">Score: <span id="quiz-score">0</span>/10</div>
          
          <div class="quiz-card">
            <div class="question-container">
              <div class="question-text" id="question-text"></div>
              <div class="question-image" id="question-image"></div>
              <div class="question-audio">
                <button id="question-audio-btn" class="audio-btn">üîä</button>
              </div>
            </div>
            
            <div class="answers-container" id="answers-container">
              <!-- Answer options will be added here dynamically -->
            </div>
          </div>
          
          <div class="quiz-controls">
            <button class="quiz-btn" id="check-answer-btn">Check Answer</button>
            <button class="quiz-btn" id="next-question-btn" disabled>Next Question</button>
          </div>
          
          <div class="quiz-feedback" id="quiz-feedback"></div>
          
          <div class="quiz-results" style="display: none;" id="quiz-results">
            <h3>Quiz Complete!</h3>
            <div class="final-score">Your score: <span id="final-score">0</span>/10</div>
            <div class="quiz-stats">
              <div>Correct answers: <span id="correct-answers">0</span></div>
              <div>Time taken: <span id="time-taken">0:00</span></div>
            </div>
            <button class="quiz-btn" id="restart-quiz-btn">Take Another Quiz</button>
          </div>
        </div>

        <div class="writing-container" style="display: none;">
          <div class="study-header">
            <button class="back-btn" id="back-from-writing">‚Üê Back to Study Options</button>
            <div id="writing-progress">Character 1 of 10</div>
          </div>
          
          <div class="writing-card">
            <div class="writing-prompt">
              <div class="writing-character" id="writing-character"></div>
              <div class="writing-pronunciation" id="writing-pronunciation"></div>
              <button id="writing-audio-btn" class="audio-btn">üîä</button>
            </div>
            
            <div class="writing-area">
              <canvas id="writing-canvas" width="400" height="400"></canvas>
              <div class="writing-tools">
                <button id="clear-canvas-btn" class="writing-btn">Clear</button>
                <button id="check-writing-btn" class="writing-btn">Check</button>
              </div>
            </div>
          </div>
          
          <div class="writing-controls">
            <button class="writing-btn" id="prev-char-btn">Previous</button>
            <button class="writing-btn" id="next-char-btn">Next</button>
          </div>
          
          <div class="writing-feedback" id="writing-feedback"></div>
        </div>
        
        <div class="numbers-container" style="display: none;">
          <div class="study-header">
            <button class="back-btn" id="back-from-numbers">‚Üê Back to Study Options</button>
          </div>
          
          <!-- Rest of the numbers content (from the numbers section) -->
          <div class="numbers-explanation" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p>Korean has two number systems:</p>
            <ol>
              <li><strong>Native Korean numbers</strong> (ÌïòÎÇò, Îëò, ÏÖã...) - Used for counting items, age, time, etc.</li>
              <li><strong>Sino-Korean numbers</strong> (Ïùº, Ïù¥, ÏÇº...) - Used for dates, money, phone numbers, etc.</li>
            </ol>
          </div>
          
          <div class="numbers-tables" style="display: flex; gap: 20px; flex-wrap: wrap;">
            <!-- Native Korean Numbers -->
            <div class="number-table" style="flex: 1; min-width: 280px;">
              <h3>Native Korean Numbers</h3>
              <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                  <tr style="background-color: #5782BB; color: white;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Korean</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Pronunciation</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Number</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">Listen</th>
                  </tr>
                </thead>
                <tbody id="native-numbers-body">
                  <!-- Will be filled dynamically -->
                </tbody>
              </table>
            </div>
            
            <!-- Sino-Korean Numbers -->
            <div class="number-table" style="flex: 1; min-width: 280px;">
              <h3>Sino-Korean Numbers</h3>
              <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                  <tr style="background-color: #5782BB; color: white;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Korean</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Pronunciation</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Number</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">Listen</th>
                  </tr>
                </thead>
                <tbody id="sino-numbers-body">
                  <!-- Will be filled dynamically -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="numbers-counters" style="margin-top: 30px;">
            <h3>Common Counters</h3>
            <p>Korean uses counters (also called measure words) after numbers when counting objects.</p>
            
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
              <thead>
                <tr style="background-color: #5782BB; color: white;">
                  <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Counter</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Pronunciation</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Usage</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Example</th>
                  <th style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">Listen</th>
                </tr>
              </thead>
              <tbody id="counters-body">
                <!-- Will be filled dynamically -->
              </tbody>
            </table>
          </div>
          
          <div class="numbers-practice" style="margin-top: 30px;">
            <h3>Practice with Numbers</h3>
            <div class="numbers-practice-container" style="display: flex; gap: 20px; flex-wrap: wrap;">
              <div class="practice-card" style="flex: 1; min-width: 250px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #dee2e6;">
                <h4>Number to Korean</h4>
                <div id="number-practice-display" style="font-size: 48px; text-align: center; margin: 20px 0;">42</div>
                <div id="number-practice-answer" style="font-size: 24px; text-align: center; margin-bottom: 20px; color: #666; height: 30px;"></div>
                <button id="show-number-answer" style="background-color: #5782BB; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%;">Show Answer</button>
                <button id="next-number-practice" style="background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px;">Next Number</button>
              </div>
              
              <div class="practice-card" style="flex: 1; min-width: 250px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #dee2e6;">
                <h4>Korean to Number</h4>
                <div id="korean-practice-display" style="font-size: 36px; text-align: center; margin: 20px 0;">ÎßàÌùîÎëò</div>
                <div id="korean-practice-answer" style="font-size: 24px; text-align: center; margin-bottom: 20px; color: #666; height: 30px;"></div>
                <button id="show-korean-answer" style="background-color: #5782BB; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%;">Show Answer</button>
                <button id="next-korean-practice" style="background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px;">Next Word</button>
              </div>
            </div>
          </div>
        </div>

        <div class="grammar-container" style="display: none;">
          <div class="study-header">
            <a href="#" class="back-btn" id="back-from-grammar">‚Üê Back to Study Options</a>
            <div id="grammar-progress">Lesson 1 of 10</div>
          </div>
          <div class="grammar-lesson">
            <div class="grammar-explanation">
              <h3 id="grammar-title">Basic Sentence Structure</h3>
              <div class="grammar-content" id="grammar-content">
                <!-- Grammar content will be loaded dynamically -->
              </div>
            </div>
            <div class="sentence-practice">
              <h3>Practice Making Sentences</h3>
              <div class="sentence-builder">
                <div class="sentence-prompt" id="sentence-prompt">
                  <!-- Sentence prompt will be shown here -->
                </div>
                <div class="word-bank" id="word-bank">
                  <!-- Available words will be shown here -->
                </div>
                <div class="sentence-construction" id="sentence-construction">
                  <!-- User's sentence will be built here -->
                </div>
                <div class="sentence-controls">
                  <button class="grammar-btn" id="check-sentence-btn">Check Sentence</button>
                  <button class="grammar-btn" id="clear-sentence-btn">Clear</button>
                  <button class="grammar-btn" id="next-sentence-btn">Next Practice</button>
                </div>
                <div class="sentence-feedback" id="sentence-feedback"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Settings Section -->
      <div id="settings-section" class="content-section">
        <div class="section-header">
          <h2>Settings</h2>
        </div>
        
        <div class="settings-container">
          <div class="settings-group">
            <h3>Proficiency Level</h3>
            <select class="level-select" id="proficiency-level">
              <option value="beginner">Beginner</option>
              <option value="intermediate">Intermediate</option>
              <option value="advanced">Advanced</option>
            </select>
          </div>
          
          <div class="settings-group">
            <h3>Audio Settings</h3>
            <div class="settings-option">
              <input type="checkbox" id="auto-play" checked>
              <label for="auto-play">Auto-play pronunciation when viewing words</label>
            </div>
          </div>
          
          <div class="settings-group">
            <h3>Display Settings</h3>
            <div class="settings-option">
              <input type="checkbox" id="show-translations" checked>
              <label for="show-translations">Show translations for example sentences</label>
            </div>
            <div class="settings-option">
              <input type="checkbox" id="show-romanization" checked>
              <label for="show-romanization">Show romanization</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Include the Korean words dictionary -->
  <script>
    // Initialize dictionary
    window.koreanDictionary = [];
    
    // Load dictionary
    fetch('korean-words.js')
      .then(response => response.text())
      .then(text => {
        // Remove "const koreanDictionary = " from the start and evaluate
        const dictText = text.replace('const koreanDictionary = ', '');
        window.koreanDictionary = JSON.parse(dictText);
        console.log('Dictionary loaded successfully with', window.koreanDictionary.length, 'words');
        
        // Initialize the app after dictionary is loaded
        if (document.readyState === 'complete') {
          initializeProgress();
        }
      })
      .catch(error => console.error('Error loading dictionary:', error));
  </script>
  
  <script>
    // Initialize dictionary
    document.addEventListener('DOMContentLoaded', () => {
      // Display total word count
      const totalWords = koreanDictionary.length;
      document.getElementById('total-words').textContent = totalWords;
      console.log(`Loaded ${totalWords} words`);
      
      // Initial dictionary display
      filterDictionary();
      
      // ... rest of the initialization code ...
    });
    
    // Navigation
    const navItems = document.querySelectorAll('.nav-item');
    const contentSections = document.querySelectorAll('.content-section');
    
    navItems.forEach(item => {
      item.addEventListener('click', () => {
        // Update active nav item
        navItems.forEach(navItem => navItem.classList.remove('active'));
        item.classList.add('active');
        
        // Show corresponding section
        const sectionId = item.getAttribute('data-section');
        contentSections.forEach(section => {
          section.classList.remove('active');
          if (section.id === `${sectionId}-section`) {
            section.classList.add('active');
          }
        });
      });
    });
    
    // Dictionary Functionality
    function playAudio(text, button) {
      console.log('Starting playAudio for text:', text);
      
      // If no button is provided, use playPlainAudio instead
      if (!button) {
        console.log('No button provided, using playPlainAudio');
        return playPlainAudio(text);
      }
      
      // Update button state
      console.log('Updating button state...');
      const indicator = button.querySelector('.audio-indicator');
      if (!indicator) {
        console.error('Could not find audio indicator in button');
        return;
      }
      
      // Reset button state
      const resetButton = () => {
        indicator.classList.remove('playing');
        button.innerHTML = '<span class="audio-indicator"></span>Listen';
        button.disabled = false;
      };

      // Update button to playing state
      indicator.classList.add('playing');
      button.textContent = 'Playing...';
      button.disabled = true;

      // Create audio element
      const audio = new Audio();
      
      // Use Google Translate TTS API
      const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=ko-KR&client=tw-ob`;
      console.log('Audio URL:', url);
      audio.src = url;
      
      // Handle completion
      audio.onended = () => {
        console.log('Audio playback completed successfully');
        resetButton();
      };

      // Handle errors
      audio.onerror = (error) => {
        console.error('Error playing audio:', error);
        resetButton();
      };

      // Play the audio
      console.log('Starting audio playback...');
      audio.play()
        .then(() => {
          console.log('Audio playback started');
        })
        .catch(error => {
          console.error('Error starting audio:', error);
          resetButton();
        });
    }
    
    // Separate function for playing audio without button UI updates
    function playPlainAudio(text) {
      console.log('Starting playPlainAudio for text:', text);
      
      // Create audio element
      const audio = new Audio();
      
      // Use Google Translate TTS API
      const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=ko-KR&client=tw-ob`;
      console.log('Audio URL:', url);
      audio.src = url;
      
      // Play the audio
      audio.play()
        .catch(error => {
          console.error('Error playing audio:', error);
        });
    }
    
    // Helper: detect if a word is a verb (ends with 'Îã§')
    function isVerb(word) {
      return word.korean && word.korean.endsWith('Îã§');
    }
    // Helper: conjugate verb (very basic, regular verbs only)
    function conjugateVerb(base) {
      // Remove 'Îã§'
      const stem = base.slice(0, -1);
      // Present: -Ïñ¥Ïöî/-ÏïÑÏöî
      let present = '';
      if (stem.endsWith('Ìïò')) {
        present = stem + 'Ïó¨Ïöî';
      } else if (/[„Öè„Öó]$/.test(stem[stem.length - 1])) {
        present = stem + 'ÏïÑÏöî';
      } else {
        present = stem + 'Ïñ¥Ïöî';
      }
      // Past: -ÏóàÏñ¥Ïöî/-ÏïòÏñ¥Ïöî
      let past = '';
      if (stem.endsWith('Ìïò')) {
        past = stem + 'ÏòÄÏñ¥Ïöî';
      } else if (/[„Öè„Öó]$/.test(stem[stem.length - 1])) {
        past = stem + 'ÏïòÏñ¥Ïöî';
      } else {
        past = stem + 'ÏóàÏñ¥Ïöî';
      }
      // Future: -(Ïúº)„Ñπ Í±∞ÏòàÏöî
      let future = '';
      if (/[„Ñπ]$/.test(stem[stem.length - 1])) {
        future = stem + ' Í±∞ÏòàÏöî';
      } else if (/[aeiou]$/.test(stem)) {
        future = stem + '„Ñπ Í±∞ÏòàÏöî';
      } else {
        future = stem + 'ÏùÑ Í±∞ÏòàÏöî';
      }
      return { present, past, future };
    }
    // Helper: generate a simple example sentence
    function generateExample(word) {
      if (isVerb(word)) {
        // Use present tense for example
        const conj = conjugateVerb(word.korean);
        return `${conj.present} (I ${word.translation})`;
      } else if (word.categories && word.categories.includes('Adjectives')) {
        return `${word.korean} ÏÇ¨ÎûåÏù¥ÏóêÏöî. (He/She is ${word.translation})`;
      } else {
        // Noun or other
        return `${word.korean}Ïù¥/Í∞Ä ÏûàÏñ¥Ïöî. (There is a ${word.translation})`;
      }
    }

    function createWordCard(word) {
      const card = document.createElement('div');
      card.className = 'word-card';
      
      // Korean word
      const korean = document.createElement('div');
      korean.className = 'korean';
      korean.textContent = word.korean;
      
      // Pronunciation
      const pronunciation = document.createElement('div');
      pronunciation.className = 'pronunciation';
      pronunciation.textContent = word.pronunciation;
      
      // Translation
      const translation = document.createElement('div');
      translation.className = 'translation';
      translation.textContent = word.translation;
      
      // Categories as tags
      const tags = document.createElement('div');
      tags.className = 'tags';
      
      word.categories.forEach(category => {
        const tag = document.createElement('span');
        tag.className = 'tag';
        tag.textContent = category;
        tags.appendChild(tag);
      });
      
      // Example if available, or auto-generate
      let example = null;
      let exampleText = word.example;
      if (!exampleText || exampleText.trim() === '') {
        exampleText = generateExample(word);
      }
      if (exampleText) {
        example = document.createElement('div');
        example.className = 'example';
        // Parse Korean and translation parts
        let koreanText = exampleText;
        let translationText = '';
        if (exampleText.includes('(') && exampleText.includes(')')) {
          const parts = exampleText.split(/\(|\)/);
          koreanText = parts[0].trim();
          translationText = parts[1].trim();
        }
        const exampleKorean = document.createElement('div');
        exampleKorean.className = 'example-korean';
        exampleKorean.textContent = koreanText;
        const exampleTranslation = document.createElement('div');
        exampleTranslation.className = 'example-translation';
        exampleTranslation.textContent = translationText;
        example.appendChild(exampleKorean);
        example.appendChild(exampleTranslation);
      }
      
      // Conjugations for verbs
      let conjugationDiv = null;
      if (isVerb(word)) {
        const conj = conjugateVerb(word.korean);
        conjugationDiv = document.createElement('div');
        conjugationDiv.className = 'conjugations';
        conjugationDiv.style.margin = '10px 0';
        conjugationDiv.innerHTML = `<b>Present:</b> ${conj.present}<br><b>Past:</b> ${conj.past}<br><b>Future:</b> ${conj.future}`;
      }
      
      // Controls
      const controls = document.createElement('div');
      controls.className = 'controls';
      
      const listenBtn = document.createElement('button');
      listenBtn.className = 'listen-btn';
      listenBtn.innerHTML = '<span class="audio-indicator"></span>Listen';
      listenBtn.addEventListener('click', () => {
        playAudio(word.korean, listenBtn);
      });
      
      controls.appendChild(listenBtn);
      
      // Assemble the card
      card.appendChild(korean);
      card.appendChild(pronunciation);
      card.appendChild(translation);
      card.appendChild(tags);
      if (conjugationDiv) card.appendChild(conjugationDiv);
      if (example) card.appendChild(example);
      card.appendChild(controls);
      
      // Add to study feature - click to add to flashcards
      card.addEventListener('dblclick', () => {
        // Logic to add to study list would go here
        alert(`Added "${word.korean}" to your study list!`);
      });
      
      return card;
    }
    
    function filterDictionary() {
      const container = document.getElementById('dictionary-container');
      container.innerHTML = '';
      
      const searchTerm = document.querySelector('.search-input').value.toLowerCase();
      const activeFilter = document.querySelector('.filter.active');
      const selectedCategory = activeFilter.getAttribute('data-category');
      
      // Filter words
      const filteredWords = koreanDictionary.filter(word => {
        // Check if matches search term
        const matchesSearch = 
          !searchTerm || 
          word.korean.toLowerCase().includes(searchTerm) ||
          word.pronunciation.toLowerCase().includes(searchTerm) ||
          word.translation.toLowerCase().includes(searchTerm);
        
        // Check if matches category
        const matchesCategory = 
          selectedCategory === 'All' ||
          word.categories.includes(selectedCategory);
        
        return matchesSearch && matchesCategory;
      });
      
      // Sort by difficulty level from beginner to master
      filteredWords.sort((a, b) => {
        // Define categories in order of difficulty (beginner to master)
        const difficultyOrder = [
          "Greetings", 
          "Common", 
          "Numbers", 
          "Food", 
          "Family", 
          "Places", 
          "Time", 
          "Responses", 
          "Transportation", 
          "Weather", 
          "Shopping", 
          "Emotions", 
          "Education", 
          "Travel", 
          "Verbs", 
          "Adjectives", 
          "Health", 
          "Technology", 
          "MZ"
        ];
        
        // If we're filtering by a specific category, prioritize words where the 
        // selected category is their primary (first) category
        if (selectedCategory !== 'All') {
          const aPrimaryCategory = a.categories[0];
          const bPrimaryCategory = b.categories[0];
          
          const aHasSelectedAsPrimary = aPrimaryCategory === selectedCategory;
          const bHasSelectedAsPrimary = bPrimaryCategory === selectedCategory;
          
          if (aHasSelectedAsPrimary && !bHasSelectedAsPrimary) return -1;
          if (!aHasSelectedAsPrimary && bHasSelectedAsPrimary) return 1;
        }
        
        // Get the most basic category for each word (first match in difficultyOrder)
        let aDifficultyCategory = a.categories.find(cat => difficultyOrder.includes(cat));
        let bDifficultyCategory = b.categories.find(cat => difficultyOrder.includes(cat));
        
        // If no matching categories, default to the end
        const aDifficultyIndex = aDifficultyCategory ? difficultyOrder.indexOf(aDifficultyCategory) : 999;
        const bDifficultyIndex = bDifficultyCategory ? difficultyOrder.indexOf(bDifficultyCategory) : 999;
        
        // Sort by difficulty index
        if (aDifficultyIndex !== bDifficultyIndex) {
          return aDifficultyIndex - bDifficultyIndex;
        }
        
        // If same difficulty, sort by length of Korean word (shorter is usually simpler)
        if (a.korean.length !== b.korean.length) {
          return a.korean.length - b.korean.length;
        }
        
        // If same length, sort alphabetically
        return a.korean.localeCompare(b.korean);
      });
      
      // Display count
      document.getElementById('word-count').textContent = filteredWords.length;
      
      // Create cards
      filteredWords.forEach(word => {
        const card = createWordCard(word);
        container.appendChild(card);
      });
      
      // If no words found, show message
      if (filteredWords.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.style.textAlign = 'center';
        noResults.style.padding = '40px';
        noResults.style.color = '#666';
        noResults.textContent = 'No words matching your search or filter were found.';
        container.appendChild(noResults);
      }
    }
    
    // Study Functionality
    let currentCardIndex = 0;
    let studyWords = [];
    let studyProgress = {};
    
    // Try to load saved progress from localStorage
    function loadProgress() {
      const savedProgress = localStorage.getItem('koreanStudyProgress');
      if (savedProgress) {
        studyProgress = JSON.parse(savedProgress);
      }
    }
    
    // Save progress to localStorage
    function saveProgress() {
      localStorage.setItem('koreanStudyProgress', JSON.stringify(studyProgress));
    }
    
    function initializeFlashcards() {
      // Load progress first
      loadProgress();
      
      // Get all words from dictionary
      studyWords = [...koreanDictionary];
      
      // Sort by progress (unlearned first, then by last review date)
      studyWords.sort((a, b) => {
        const progressA = studyProgress[a.korean] || { count: 0, lastReview: 0 };
        const progressB = studyProgress[b.korean] || { count: 0, lastReview: 0 };
        
        if (progressA.count === 0 && progressB.count > 0) return -1;
        if (progressA.count > 0 && progressB.count === 0) return 1;
        
        return progressA.lastReview - progressB.lastReview;
      });
      
      currentCardIndex = 0;
      updateFlashcard();
      
      // Update progress counter
      updateProgressCounter();
    }
    
    function updateProgressCounter() {
      const totalWords = koreanDictionary.length;
      const studiedWords = Object.keys(studyProgress).length;
      document.getElementById('progress-counter').textContent = `${studiedWords}/${totalWords} words studied`;
    }
    
    function updateFlashcard() {
      if (studyWords.length === 0) return;
      
      const currentWord = studyWords[currentCardIndex];
      
      // Update front
      document.getElementById('flashcard-front-word').textContent = currentWord.korean;
      
      // Update back
      document.getElementById('flashcard-back-word').textContent = currentWord.translation;
      document.getElementById('flashcard-back-hint').textContent = currentWord.pronunciation;
      
      // Update progress info
      const progress = studyProgress[currentWord.korean] || { count: 0, lastReview: 0 };
      const progressStatus = document.getElementById('flashcard-progress-status');
      
      if (progress.count === 0) {
        progressStatus.textContent = 'New Word';
        progressStatus.className = 'flashcard-progress new';
      } else {
        const lastReviewed = new Date(progress.lastReview);
        const today = new Date();
        const daysDiff = Math.floor((today - lastReviewed) / (1000 * 60 * 60 * 24));
        
        progressStatus.textContent = `Studied ${progress.count} time${progress.count > 1 ? 's' : ''}, last ${daysDiff === 0 ? 'today' : daysDiff === 1 ? 'yesterday' : daysDiff + ' days ago'}`;
        progressStatus.className = 'flashcard-progress';
      }
      
      // Reset flip state
      document.querySelector('.flashcard').classList.remove('flipped');
      
      // Update current card counter
      document.getElementById('card-counter').textContent = `Card ${currentCardIndex + 1} of ${studyWords.length}`;
    }
    
    function markAsReviewed() {
      if (studyWords.length === 0) return;
      
      const currentWord = studyWords[currentCardIndex];
      
      // Update progress for this word
      if (!studyProgress[currentWord.korean]) {
        studyProgress[currentWord.korean] = { count: 0, lastReview: 0 };
      }
      
      studyProgress[currentWord.korean].count++;
      studyProgress[currentWord.korean].lastReview = Date.now();
      
      // Save progress
      saveProgress();
    }
    
    function nextCard() {
      if (studyWords.length === 0) return;
      
      markAsReviewed();
      
      currentCardIndex = (currentCardIndex + 1) % studyWords.length;
      updateFlashcard();
    }
    
    function prevCard() {
      if (studyWords.length === 0) return;
      
      currentCardIndex = (currentCardIndex - 1 + studyWords.length) % studyWords.length;
      updateFlashcard();
    }
    
    function flipCard() {
      const flashcard = document.querySelector('.flashcard');
      flashcard.classList.toggle('flipped');
      
      // Play audio when flipping to back (showing Korean word)
      if (!flashcard.classList.contains('flipped')) {
        const currentWord = studyWords[currentCardIndex];
        playCardAudio(currentWord.korean);
      }
    }
    
    function playCardAudio(text) {
      const audio = new Audio();
      audio.src = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=ko-KR&client=tw-ob`;
      
      audio.play()
        .catch(error => {
          console.error('Error playing audio:', error);
        });
    }
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize speech synthesis
      if ('speechSynthesis' in window) {
        // Load voices
        function loadVoices() {
          return new Promise((resolve) => {
            let voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
              resolve(voices);
            } else {
              window.speechSynthesis.onvoiceschanged = () => {
                voices = window.speechSynthesis.getVoices();
                resolve(voices);
              };
            }
          });
        }

        // Load voices and set up fallback
        loadVoices().then(voices => {
          const koreanVoices = voices.filter(voice => voice.lang.includes('ko-'));
          console.log('Available voices:', voices.length);
          console.log('Korean voices:', koreanVoices.map(v => v.name));
          
          // If no Korean voices, use Microsoft Azure or Amazon Polly
          if (koreanVoices.length === 0) {
            console.log('No Korean voices found, will use alternative TTS service');
            // The audio will still work, just with a non-Korean voice
          }
        });
      }

      // Display total word count
      document.getElementById('total-words').textContent = koreanDictionary.length;
      
      // Set up dictionary search and filters
      const searchInput = document.querySelector('.search-input');
      searchInput.addEventListener('input', filterDictionary);
      
      const filters = document.querySelectorAll('.filter');
      filters.forEach(filter => {
        filter.addEventListener('click', () => {
          // Update active filter
          document.querySelector('.filter.active').classList.remove('active');
          filter.classList.add('active');
          
          // Refilter the dictionary
          filterDictionary();
        });
      });
      
      // Horizontal scroll for filters with mouse wheel
      const filtersContainer = document.getElementById('main-filters');
      filtersContainer.addEventListener('wheel', (e) => {
        if (e.deltaY !== 0) {
          e.preventDefault();
          filtersContainer.scrollLeft += e.deltaY;
        }
      });
      
      // Initial dictionary display - filter immediately to load words
      filterDictionary();
      
      // Display word count in dictionary section
      document.getElementById('word-count').textContent = koreanDictionary.length;
      
      // Add keyboard shortcut for search
      document.addEventListener('keydown', function(e) {
        // Ctrl+F or Cmd+F opens and focuses the search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          // If we're in the dictionary section
          if (document.getElementById('dictionary-section').classList.contains('active')) {
            e.preventDefault(); // Prevent the browser's find functionality
            searchInput.focus();
          }
        }
      });
      
      // Initialize numbers section
      initializeNumbersSection();
      
      // Set up flashcards
      document.getElementById('flashcards-option').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'none';
        document.querySelector('.flashcard-container').style.display = 'flex';
        document.querySelector('.quiz-container').style.display = 'none';
        document.querySelector('.writing-container').style.display = 'none';
        document.querySelector('.numbers-container').style.display = 'none';
        initializeFlashcards();
      });
      
      // Set up back button for flashcards
      document.getElementById('back-to-study').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'flex';
        document.querySelector('.flashcard-container').style.display = 'none';
      });
      
      document.getElementById('flip-btn').addEventListener('click', flipCard);
      document.getElementById('next-btn').addEventListener('click', nextCard);
      document.getElementById('prev-btn').addEventListener('click', prevCard);
      document.getElementById('play-audio-btn').addEventListener('click', () => {
        const currentWord = studyWords[currentCardIndex];
        playCardAudio(currentWord.korean);
      });
      
      document.querySelector('.flashcard').addEventListener('click', flipCard);
      
      // Set up quiz
      document.getElementById('quiz-option').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'none';
        document.querySelector('.quiz-container').style.display = 'flex';
        document.querySelector('.flashcard-container').style.display = 'none';
        document.querySelector('.writing-container').style.display = 'none';
        document.querySelector('.numbers-container').style.display = 'none';
        initializeQuiz();
      });
      
      // Set up back button for quiz
      document.getElementById('back-from-quiz').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'flex';
        document.querySelector('.quiz-container').style.display = 'none';
      });
      
      // Quiz buttons
      document.getElementById('check-answer-btn').addEventListener('click', checkAnswer);
      document.getElementById('next-question-btn').addEventListener('click', nextQuestion);
      document.getElementById('restart-quiz-btn').addEventListener('click', initializeQuiz);
      
      // Set up writing practice
      document.getElementById('writing-option').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'none';
        document.querySelector('.writing-container').style.display = 'flex';
        document.querySelector('.flashcard-container').style.display = 'none';
        document.querySelector('.quiz-container').style.display = 'none';
        document.querySelector('.numbers-container').style.display = 'none';
        initializeWriting();
      });
      
      // Set up back button for writing
      document.getElementById('back-from-writing').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'flex';
        document.querySelector('.writing-container').style.display = 'none';
      });
      
      // Writing buttons
      document.getElementById('clear-canvas-btn').addEventListener('click', clearCanvas);
      document.getElementById('check-writing-btn').addEventListener('click', checkWriting);
      document.getElementById('prev-char-btn').addEventListener('click', prevCharacter);
      document.getElementById('next-char-btn').addEventListener('click', nextCharacter);
      document.getElementById('writing-audio-btn').addEventListener('click', playWritingAudio);
      
      // Set up numbers practice
      document.getElementById('numbers-option').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'none';
        document.querySelector('.numbers-container').style.display = 'block';
        document.querySelector('.flashcard-container').style.display = 'none';
        document.querySelector('.quiz-container').style.display = 'none';
        document.querySelector('.writing-container').style.display = 'none';
      });
      
      // Set up back button for numbers
      document.getElementById('back-from-numbers').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'flex';
        document.querySelector('.numbers-container').style.display = 'none';
      });
    });
    
    // Quiz variables
    let quizWords = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let selectedAnswer = null;
    let quizStartTime;
    let quizTimer;
    
    // Quiz types
    const quizTypes = [
      { type: 'translate-korean', question: 'What does this Korean word mean?', answerField: 'translation' },
      { type: 'translate-english', question: 'What is the Korean word for:', answerField: 'korean' },
      { type: 'pronunciation', question: 'How do you pronounce this Korean word?', answerField: 'pronunciation' },
      { type: 'listening', question: 'Listen and select the correct Korean word:', answerField: 'korean' },
      { type: 'sentence-meaning', question: 'What does this Korean sentence mean?', answerField: 'translation' },
      { type: 'word-in-context', question: 'Choose the best word to complete this sentence:', answerField: 'korean' }
    ];
    
    // Add sentences for sentence-based quizzes
    const koreanSentences = [
      {
        korean: "Ïò§Îäò ÎÇ†Ïî®Í∞Ä Ï¢ãÏïÑÏöî.",
        pronunciation: "oneul nalsiga joayo",
        translation: "Today's weather is good.",
        words: [
          { korean: "Ïò§Îäò", pronunciation: "oneul", translation: "today" },
          { korean: "ÎÇ†Ïî®", pronunciation: "nalssi", translation: "weather" },
          { korean: "Í∞Ä", pronunciation: "ga", translation: "subject particle" },
          { korean: "Ï¢ãÏïÑÏöî", pronunciation: "joayo", translation: "is good" }
        ]
      },
      {
        korean: "ÌïôÍµêÏóê Í∞ôÏù¥ Í∞ÄÏöî.",
        pronunciation: "hakgyoe gachi gayo",
        translation: "Let's go to school together.",
        words: [
          { korean: "ÌïôÍµê", pronunciation: "hakgyo", translation: "school" },
          { korean: "Ïóê", pronunciation: "e", translation: "to (direction particle)" },
          { korean: "Í∞ôÏù¥", pronunciation: "gachi", translation: "together" },
          { korean: "Í∞ÄÏöî", pronunciation: "gayo", translation: "let's go" }
        ]
      },
      {
        korean: "Ïù¥ ÏùåÏãùÏùÄ ÎßõÏûàÏñ¥Ïöî.",
        pronunciation: "i eumsigen massisseoyo",
        translation: "This food is delicious.",
        words: [
          { korean: "Ïù¥", pronunciation: "i", translation: "this" },
          { korean: "ÏùåÏãù", pronunciation: "eumsik", translation: "food" },
          { korean: "ÏùÄ", pronunciation: "eun", translation: "topic particle" },
          { korean: "ÎßõÏûàÏñ¥Ïöî", pronunciation: "massisseoyo", translation: "is delicious" }
        ]
      },
      {
        korean: "Ïª§ÌîºÎ•º ÎßàÏÖîÏöî.",
        pronunciation: "keopireul masyeoyo",
        translation: "I drink coffee.",
        words: [
          { korean: "Ïª§Ìîº", pronunciation: "keopi", translation: "coffee" },
          { korean: "Î•º", pronunciation: "reul", translation: "object particle" },
          { korean: "ÎßàÏÖîÏöî", pronunciation: "masyeoyo", translation: "drink" }
        ]
      },
      {
        korean: "Ï±ÖÏùÑ ÏùΩÍ≥† ÏûàÏñ¥Ïöî.",
        pronunciation: "chaekeul ilkgo isseoyo",
        translation: "I am reading a book.",
        words: [
          { korean: "Ï±Ö", pronunciation: "chaek", translation: "book" },
          { korean: "ÏùÑ", pronunciation: "eul", translation: "object particle" },
          { korean: "ÏùΩÍ≥†", pronunciation: "ilkgo", translation: "reading" },
          { korean: "ÏûàÏñ¥Ïöî", pronunciation: "isseoyo", translation: "am (progressive)" }
        ]
      },
      {
        korean: "ÎÇ¥Ïùº ÏπúÍµ¨Î•º ÎßåÎÇòÏöî.",
        pronunciation: "naeil chingureul mannayo",
        translation: "I'm meeting a friend tomorrow.",
        words: [
          { korean: "ÎÇ¥Ïùº", pronunciation: "naeil", translation: "tomorrow" },
          { korean: "ÏπúÍµ¨", pronunciation: "chingu", translation: "friend" },
          { korean: "Î•º", pronunciation: "reul", translation: "object particle" },
          { korean: "ÎßåÎÇòÏöî", pronunciation: "mannayo", translation: "meet" }
        ]
      },
      {
        korean: "ÌïúÍµ≠Ïñ¥Î•º Î∞∞Ïö∞Í≥† ÏûàÏñ¥Ïöî.",
        pronunciation: "hangugeo-reul baeugo isseoyo",
        translation: "I am learning Korean.",
        words: [
          { korean: "ÌïúÍµ≠Ïñ¥", pronunciation: "hangugeo", translation: "Korean language" },
          { korean: "Î•º", pronunciation: "reul", translation: "object particle" },
          { korean: "Î∞∞Ïö∞Í≥†", pronunciation: "baeugo", translation: "learning" },
          { korean: "ÏûàÏñ¥Ïöî", pronunciation: "isseoyo", translation: "am (progressive)" }
        ]
      },
      {
        korean: "Ï†ÄÎäî ÌïôÏÉùÏù¥ÏóêÏöî.",
        pronunciation: "jeoneun haksaeng-ieyo",
        translation: "I am a student.",
        words: [
          { korean: "Ï†Ä", pronunciation: "jeo", translation: "I (formal)" },
          { korean: "Îäî", pronunciation: "neun", translation: "topic particle" },
          { korean: "ÌïôÏÉù", pronunciation: "haksaeng", translation: "student" },
          { korean: "Ïù¥ÏóêÏöî", pronunciation: "ieyo", translation: "am (formal)" }
        ]
      },
      {
        korean: "ÏßëÏóê Í∞ÄÍ≥† Ïã∂Ïñ¥Ïöî.",
        pronunciation: "jibe gago sipeoyo",
        translation: "I want to go home.",
        words: [
          { korean: "Ïßë", pronunciation: "jip", translation: "home" },
          { korean: "Ïóê", pronunciation: "e", translation: "to (direction particle)" },
          { korean: "Í∞ÄÍ≥†", pronunciation: "gago", translation: "go" },
          { korean: "Ïã∂Ïñ¥Ïöî", pronunciation: "sipeoyo", translation: "want to" }
        ]
      },
      {
        korean: "Î™á ÏãúÏóê ÎßåÎÇ†ÍπåÏöî?",
        pronunciation: "myeot sie mannalkayo",
        translation: "What time shall we meet?",
        words: [
          { korean: "Î™á Ïãú", pronunciation: "myeot si", translation: "what time" },
          { korean: "Ïóê", pronunciation: "e", translation: "at (time particle)" },
          { korean: "ÎßåÎÇ†ÍπåÏöî", pronunciation: "mannalkayo", translation: "shall we meet" }
        ]
      }
    ];
    
    function initializeQuiz() {
      // Reset quiz state
      document.getElementById('quiz-results').style.display = 'none';
      document.querySelector('.quiz-card').style.display = 'block';
      document.querySelector('.quiz-controls').style.display = 'flex';
      document.getElementById('quiz-feedback').style.display = 'none';
      document.getElementById('quiz-feedback').className = 'quiz-feedback';
      
      // Reset variables
      quizWords = getRandomWords(10);
      currentQuestionIndex = 0;
      score = 0;
      quizStartTime = new Date();
      
      // Update display
      document.getElementById('quiz-score').textContent = score;
      
      // Start the quiz
      showQuestion();
    }
    
    function getRandomWords(count) {
      // Create a copy of the dictionary and shuffle it
      const shuffled = [...koreanDictionary];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      
      // Return the specified number of words
      return shuffled.slice(0, count);
    }
    
    function showQuestion() {
      // Get current question data
      const word = quizWords[currentQuestionIndex];
      
      // Randomly select quiz type, but give higher weight to basic types for newer users
      let quizType;
      const randomValue = Math.random();
      
      if (randomValue < 0.7) {
        // 70% chance for basic quiz types (first 4 types)
        const basicTypeIndex = Math.floor(Math.random() * 4);
        quizType = quizTypes[basicTypeIndex];
      } else {
        // 30% chance for advanced quiz types (sentence types)
        const advancedTypeIndex = Math.floor(Math.random() * 2) + 4; // indices 4 and 5
        quizType = quizTypes[advancedTypeIndex];
      }
      
      // Update question text
      document.getElementById('quiz-progress').textContent = `Question ${currentQuestionIndex + 1} of ${quizWords.length}`;
      
      // Clear previous selections
      selectedAnswer = null;
      document.getElementById('next-question-btn').disabled = true;
      document.getElementById('check-answer-btn').disabled = false;
      
      // Clear previous feedback
      document.getElementById('quiz-feedback').style.display = 'none';
      
      // Create question based on quiz type
      const questionText = document.getElementById('question-text');
      
      // Set up audio button for all question types
      const questionAudioBtn = document.getElementById('question-audio-btn');
      questionAudioBtn.style.display = 'inline-block';
      
      // Handle different quiz types
      if (quizType.type === 'listening') {
        questionText.textContent = quizType.question;
        
        // Set audio playback for listening questions
        questionAudioBtn.onclick = function() {
          playPlainAudio(word.korean);
        };
        
        // Play audio automatically after a short delay
        setTimeout(() => {
          playPlainAudio(word.korean);
        }, 500);
        
      } else if (quizType.type === 'translate-english') {
        questionText.textContent = `${quizType.question} "${word.translation}"`;
        
        // Set audio button for English-to-Korean
        questionAudioBtn.onclick = function() {
          // Play pronunciation of the correct Korean answer
          playPlainAudio(word.korean);
        };
        
      } else if (quizType.type === 'sentence-meaning') {
        // Get a random sentence
        const sentenceIndex = Math.floor(Math.random() * koreanSentences.length);
        const sentence = koreanSentences[sentenceIndex];
        currentQuizSentence = sentence; // Store for explanation later
        
        // Create Korean text with pronunciation
        const koreanWithPronunciation = document.createElement('div');
        koreanWithPronunciation.innerHTML = `
          <div style="font-size: 22px; font-weight: bold; margin-bottom: 5px;">${sentence.korean}</div>
          <div style="color: #666; font-size: 14px; margin-bottom: 15px;">${sentence.pronunciation}</div>
        `;
        
        questionText.textContent = quizType.question;
        questionText.appendChild(koreanWithPronunciation);
        
        // Set audio button for sentence
        questionAudioBtn.onclick = function() {
          playPlainAudio(sentence.korean);
        };
        
        // Play audio automatically after a short delay
        setTimeout(() => {
          playPlainAudio(sentence.korean);
        }, 500);
        
        // Get incorrect options (other sentence translations)
        const otherSentences = koreanSentences
          .filter((s, i) => i !== sentenceIndex)
          .map(s => s.translation);
        
        // Shuffle and take 3
        const incorrectOptions = shuffleArray(otherSentences).slice(0, 3);
        
        // Combine correct and incorrect answers
        const allOptions = [sentence.translation, ...incorrectOptions];
        const shuffledOptions = shuffleArray(allOptions);
        
        // Create answer buttons
        createAnswerOptions(shuffledOptions);
        
        return; // We've handled this special case
        
      } else if (quizType.type === 'word-in-context') {
        // Get a random sentence and a word to remove
        const sentenceIndex = Math.floor(Math.random() * koreanSentences.length);
        const sentence = koreanSentences[sentenceIndex];
        currentQuizSentence = sentence; // Store for explanation later
        
        // Choose a word to blank out (excluding particles if possible)
        const contentWords = sentence.words.filter(w => 
          !['Í∞Ä', 'Îäî', 'ÏùÑ', 'Î•º', 'Ïóê', 'Ïùò', 'Ïù¥', 'Í≥º', 'ÏôÄ'].includes(w.korean)
        );
        
        // If no content words, use any word
        const wordsToChooseFrom = contentWords.length > 0 ? contentWords : sentence.words;
        const blankWordIndex = Math.floor(Math.random() * wordsToChooseFrom.length);
        const blankWord = wordsToChooseFrom[blankWordIndex];
        currentQuizBlankWord = blankWord; // Store for explanation later
        
        // Create the sentence with a blank
        const sentenceWithBlank = sentence.korean.replace(blankWord.korean, "_____");
        const pronunciationWithBlank = sentence.pronunciation.replace(blankWord.pronunciation, "_____");
        
        // Create Korean text with pronunciation
        const koreanWithPronunciation = document.createElement('div');
        koreanWithPronunciation.innerHTML = `
          <div style="font-size: 22px; font-weight: bold; margin-bottom: 5px;">${sentenceWithBlank}</div>
          <div style="color: #666; font-size: 14px; margin-bottom: 15px;">${pronunciationWithBlank}</div>
        `;
        
        questionText.textContent = quizType.question;
        questionText.appendChild(koreanWithPronunciation);
        
        // Set audio button for sentence
        questionAudioBtn.onclick = function() {
          // Play full sentence even though we show with blank
          playPlainAudio(sentence.korean);
        };
        
        // Play audio of the full sentence after a short delay
        setTimeout(() => {
          playPlainAudio(sentence.korean);
        }, 500);
        
        // Get incorrect options (other words that could fit grammatically)
        const incorrectOptions = koreanDictionary
          .filter(w => w.korean !== blankWord.korean)
          .filter(w => w.categories.some(cat => blankWord.korean.length < 2 || cat === "Common"))
          .map(w => w.korean);
        
        // Shuffle and take 3
        const shuffledIncorrectOptions = shuffleArray(incorrectOptions).slice(0, 3);
        
        // Combine correct and incorrect answers
        const allOptions = [blankWord.korean, ...shuffledIncorrectOptions];
        const shuffledOptions = shuffleArray(allOptions);
        
        // Create answer buttons
        createAnswerOptions(shuffledOptions);
        
        return; // We've handled this special case
      } else {
        // Create Korean text with pronunciation for standard questions
        const koreanWithPronunciation = document.createElement('div');
        
        if (quizType.type === 'translate-korean') {
          koreanWithPronunciation.innerHTML = `
            <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${word.korean}</div>
            <div style="color: #666; font-size: 14px; margin-bottom: 15px;">${word.pronunciation}</div>
          `;
          
          questionText.textContent = quizType.question;
          questionText.appendChild(koreanWithPronunciation);
          
          // Set audio button for Korean word
          questionAudioBtn.onclick = function() {
            playPlainAudio(word.korean);
          };
          
          // Play audio automatically after a short delay
          setTimeout(() => {
            playPlainAudio(word.korean);
          }, 500);
        } else {
          questionText.textContent = `${quizType.question} "${word.korean}"`;
          
          // Set audio button for Korean word
          questionAudioBtn.onclick = function() {
            playPlainAudio(word.korean);
          };
          
          // Play audio automatically after a short delay
          setTimeout(() => {
            playPlainAudio(word.korean);
          }, 500);
        }
      }
      
      // Get incorrect options
      const otherWords = getIncorrectOptions(word, quizType.answerField);
      
      // Combine correct answer with incorrect options and shuffle
      const allOptions = [word[quizType.answerField], ...otherWords];
      const shuffledOptions = shuffleArray(allOptions);
      
      // Create answer buttons
      createAnswerOptions(shuffledOptions);
    }
    
    // Helper function to create answer options
    function createAnswerOptions(options) {
      const answersContainer = document.getElementById('answers-container');
      answersContainer.innerHTML = '';
      
      options.forEach((option, index) => {
        const answerBtn = document.createElement('div');
        answerBtn.className = 'answer-option';
        answerBtn.textContent = option;
        answerBtn.dataset.value = option;
        answerBtn.addEventListener('click', () => selectAnswer(answerBtn));
        answersContainer.appendChild(answerBtn);
      });
    }
    
    // Helper function to shuffle array
    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }
    
    // Add variables to track current sentence quiz data
    let currentQuizSentence = null;
    let currentQuizBlankWord = null;
    
    function checkAnswer() {
      if (!selectedAnswer) {
        alert('Please select an answer');
        return;
      }
      
      // Get current question data
      const word = quizWords[currentQuestionIndex];
      const quizType = quizTypes.find(type => {
        if (type.type === 'listening') {
          return document.getElementById('question-text').textContent === type.question;
        } else if (type.type === 'translate-english') {
          return document.getElementById('question-text').textContent.includes(type.question);
        } else if (type.type === 'sentence-meaning') {
          return document.getElementById('question-text').textContent.includes(type.question);
        } else if (type.type === 'word-in-context') {
          return document.getElementById('question-text').textContent.includes(type.question);
        } else {
          return document.getElementById('question-text').textContent.includes(type.question);
        }
      });
      
      // Check if the answer is correct
      let isCorrect = false;
      let correctAnswer = '';
      
      if (quizType.type === 'sentence-meaning') {
        correctAnswer = currentQuizSentence.translation;
        isCorrect = selectedAnswer === correctAnswer;
      } else if (quizType.type === 'word-in-context') {
        correctAnswer = currentQuizBlankWord.korean;
        isCorrect = selectedAnswer === correctAnswer;
      } else {
        correctAnswer = word[quizType.answerField];
        isCorrect = selectedAnswer === correctAnswer;
      }
      
      // Update UI
      document.querySelectorAll('.answer-option').forEach(opt => {
        if (opt.dataset.value === correctAnswer) {
          opt.classList.add('correct');
        } else if (opt.dataset.value === selectedAnswer && !isCorrect) {
          opt.classList.add('incorrect');
        }
      });
      
      // Show feedback
      const feedback = document.getElementById('quiz-feedback');
      
      if (isCorrect) {
        feedback.className = 'quiz-feedback correct';
        feedback.textContent = 'Correct! üëç';
        score++;
        document.getElementById('quiz-score').textContent = score;
      } else {
        feedback.className = 'quiz-feedback incorrect';
        feedback.textContent = `Incorrect. The correct answer is: ${correctAnswer}`;
      }
      
      // Add detailed feedback with pronunciation for all quiz types
      const detailedDiv = document.createElement('div');
      detailedDiv.className = 'detailed-feedback';
      detailedDiv.style.marginTop = '15px';
      detailedDiv.style.backgroundColor = '#f8f9fa';
      detailedDiv.style.padding = '15px';
      detailedDiv.style.borderRadius = '5px';
      
      if (quizType.type === 'sentence-meaning' || quizType.type === 'word-in-context') {
        // Sentence breakdown explanation
        const explanationTitle = document.createElement('div');
        explanationTitle.textContent = 'Sentence Breakdown:';
        explanationTitle.style.fontWeight = 'bold';
        explanationTitle.style.marginBottom = '10px';
        
        detailedDiv.appendChild(explanationTitle);
        
        // Add each word with its meaning
        currentQuizSentence.words.forEach(word => {
          const wordDiv = document.createElement('div');
          wordDiv.style.margin = '8px 0';
          wordDiv.style.padding = '5px';
          wordDiv.style.borderRadius = '4px';
          
          const koreanSpan = document.createElement('span');
          koreanSpan.textContent = word.korean;
          koreanSpan.style.fontWeight = 'bold';
          koreanSpan.style.fontSize = '18px';
          
          const pronunciationSpan = document.createElement('span');
          pronunciationSpan.textContent = ` (${word.pronunciation}) `;
          pronunciationSpan.style.color = '#666';
          
          const translationSpan = document.createElement('span');
          translationSpan.textContent = `- ${word.translation}`;
          
          const soundButton = document.createElement('button');
          soundButton.textContent = 'üîä';
          soundButton.style.marginLeft = '8px';
          soundButton.style.background = 'transparent';
          soundButton.style.border = 'none';
          soundButton.style.cursor = 'pointer';
          soundButton.style.fontSize = '16px';
          soundButton.addEventListener('click', (e) => {
            e.stopPropagation();
            playPlainAudio(word.korean);
          });
          
          wordDiv.appendChild(koreanSpan);
          wordDiv.appendChild(pronunciationSpan);
          wordDiv.appendChild(translationSpan);
          wordDiv.appendChild(soundButton);
          
          // Highlight the blank word in word-in-context quiz
          if (quizType.type === 'word-in-context' && word.korean === currentQuizBlankWord.korean) {
            wordDiv.style.backgroundColor = '#e8f0fe';
          }
          
          detailedDiv.appendChild(wordDiv);
        });
        
        // Play full sentence audio
        const sentenceAudioDiv = document.createElement('div');
        sentenceAudioDiv.style.marginTop = '15px';
        sentenceAudioDiv.style.textAlign = 'center';
        
        const sentenceAudioBtn = document.createElement('button');
        sentenceAudioBtn.innerHTML = 'üîä Play Full Sentence';
        sentenceAudioBtn.style.padding = '8px 15px';
        sentenceAudioBtn.style.backgroundColor = '#5782BB';
        sentenceAudioBtn.style.color = 'white';
        sentenceAudioBtn.style.border = 'none';
        sentenceAudioBtn.style.borderRadius = '5px';
        sentenceAudioBtn.style.cursor = 'pointer';
        sentenceAudioBtn.addEventListener('click', () => {
          playPlainAudio(currentQuizSentence.korean);
        });
        
        sentenceAudioDiv.appendChild(sentenceAudioBtn);
        detailedDiv.appendChild(sentenceAudioDiv);
        
      } else {
        // Standard word explanation
        const wordInfoTitle = document.createElement('div');
        wordInfoTitle.textContent = 'Word Information:';
        wordInfoTitle.style.fontWeight = 'bold';
        wordInfoTitle.style.marginBottom = '10px';
        
        const wordInfoContainer = document.createElement('div');
        wordInfoContainer.style.display = 'flex';
        wordInfoContainer.style.alignItems = 'center';
        wordInfoContainer.style.gap = '10px';
        wordInfoContainer.style.padding = '10px';
        wordInfoContainer.style.backgroundColor = 'white';
        wordInfoContainer.style.borderRadius = '5px';
        wordInfoContainer.style.border = '1px solid #e0e0e0';
        wordInfoContainer.style.marginBottom = '15px';
        
        const koreanText = document.createElement('div');
        koreanText.textContent = word.korean;
        koreanText.style.fontWeight = 'bold';
        koreanText.style.fontSize = '24px';
        
        const pronunciationText = document.createElement('div');
        pronunciationText.textContent = `(${word.pronunciation})`;
        pronunciationText.style.color = '#666';
        pronunciationText.style.fontSize = '16px';
        
        const translationText = document.createElement('div');
        translationText.textContent = word.translation;
        translationText.style.fontSize = '16px';
        
        const soundButton = document.createElement('button');
        soundButton.textContent = 'üîä';
        soundButton.style.marginLeft = 'auto';
        soundButton.style.background = 'transparent';
        soundButton.style.border = 'none';
        soundButton.style.cursor = 'pointer';
        soundButton.style.fontSize = '20px';
        soundButton.addEventListener('click', (e) => {
          e.stopPropagation();
          playPlainAudio(word.korean);
        });
        
        wordInfoContainer.appendChild(koreanText);
        wordInfoContainer.appendChild(pronunciationText);
        wordInfoContainer.appendChild(translationText);
        wordInfoContainer.appendChild(soundButton);
        
        detailedDiv.appendChild(wordInfoTitle);
        detailedDiv.appendChild(wordInfoContainer);
        
        // Add example if available
        if (word.example) {
          const exampleTitle = document.createElement('div');
          exampleTitle.textContent = 'Example:';
          exampleTitle.style.fontWeight = 'bold';
          exampleTitle.style.marginBottom = '5px';
          exampleTitle.style.marginTop = '10px';
          
          const exampleContainer = document.createElement('div');
          exampleContainer.style.backgroundColor = '#f5f5f5';
          exampleContainer.style.padding = '10px';
          exampleContainer.style.borderRadius = '5px';
          
          // Parse Korean and translation parts
          let koreanText = word.example;
          let translationText = '';
          
          if (word.example.includes('(') && word.example.includes(')')) {
            const parts = word.example.split(/\(|\)/);
            koreanText = parts[0].trim();
            translationText = parts[1].trim();
          }
          
          const exampleKorean = document.createElement('div');
          exampleKorean.textContent = koreanText;
          exampleKorean.style.fontWeight = 'bold';
          exampleKorean.style.marginBottom = '5px';
          
          const exampleTranslation = document.createElement('div');
          exampleTranslation.textContent = translationText;
          exampleTranslation.style.fontStyle = 'italic';
          exampleTranslation.style.color = '#666';
          
          const exampleAudioBtn = document.createElement('button');
          exampleAudioBtn.textContent = 'üîä';
          exampleAudioBtn.style.marginLeft = '10px';
          exampleAudioBtn.style.background = 'transparent';
          exampleAudioBtn.style.border = 'none';
          exampleAudioBtn.style.cursor = 'pointer';
          exampleAudioBtn.style.fontSize = '16px';
          exampleAudioBtn.addEventListener('click', () => {
            playPlainAudio(koreanText);
          });
          
          const exampleKoreanContainer = document.createElement('div');
          exampleKoreanContainer.style.display = 'flex';
          exampleKoreanContainer.style.alignItems = 'center';
          exampleKoreanContainer.appendChild(exampleKorean);
          exampleKoreanContainer.appendChild(exampleAudioBtn);
          
          exampleContainer.appendChild(exampleKoreanContainer);
          exampleContainer.appendChild(exampleTranslation);
          
          detailedDiv.appendChild(exampleTitle);
          detailedDiv.appendChild(exampleContainer);
        }
        
        // Add categories
        if (word.categories && word.categories.length > 0) {
          const categoriesTitle = document.createElement('div');
          categoriesTitle.textContent = 'Categories:';
          categoriesTitle.style.fontWeight = 'bold';
          categoriesTitle.style.marginBottom = '5px';
          categoriesTitle.style.marginTop = '10px';
          
          const categoriesContainer = document.createElement('div');
          categoriesContainer.style.display = 'flex';
          categoriesContainer.style.flexWrap = 'wrap';
          categoriesContainer.style.gap = '5px';
          
          word.categories.forEach(category => {
            const categoryTag = document.createElement('span');
            categoryTag.textContent = category;
            categoryTag.style.backgroundColor = '#e8f0fe';
            categoryTag.style.color = '#5782BB';
            categoryTag.style.padding = '3px 10px';
            categoryTag.style.borderRadius = '12px';
            categoryTag.style.fontSize = '12px';
            
            categoriesContainer.appendChild(categoryTag);
          });
          
          detailedDiv.appendChild(categoriesTitle);
          detailedDiv.appendChild(categoriesContainer);
        }
      }
      
      // Automatically play the audio
      setTimeout(() => {
        if (quizType.type === 'sentence-meaning' || quizType.type === 'word-in-context') {
          playPlainAudio(currentQuizSentence.korean);
        } else {
          playPlainAudio(word.korean);
        }
      }, 500);
      
      feedback.appendChild(detailedDiv);
      feedback.style.display = 'block';
      
      // Disable check button and enable next button
      document.getElementById('check-answer-btn').disabled = true;
      document.getElementById('next-question-btn').disabled = false;
    }
    
    function nextQuestion() {
      currentQuestionIndex++;
      
      // Check if the quiz is complete
      if (currentQuestionIndex >= quizWords.length) {
        finishQuiz();
        return;
      }
      
      // Show next question
      showQuestion();
    }
    
    function finishQuiz() {
      // Calculate time taken
      const endTime = new Date();
      const timeTaken = Math.floor((endTime - quizStartTime) / 1000); // in seconds
      const minutes = Math.floor(timeTaken / 60);
      const seconds = timeTaken % 60;
      
      // Update results
      document.getElementById('final-score').textContent = score;
      document.getElementById('correct-answers').textContent = score;
      document.getElementById('time-taken').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Show results
      document.querySelector('.quiz-card').style.display = 'none';
      document.querySelector('.quiz-controls').style.display = 'none';
      document.getElementById('quiz-results').style.display = 'block';
      
      // Save progress
      for (let i = 0; i < quizWords.length; i++) {
        const word = quizWords[i];
        if (!studyProgress[word.korean]) {
          studyProgress[word.korean] = { count: 0, lastReview: 0 };
        }
        studyProgress[word.korean].count++;
        studyProgress[word.korean].lastReview = Date.now();
      }
      saveProgress();
      
      // Add activity
      addActivity(`Completed quiz with score: ${score}/${quizWords.length}`);
    }
    
    // Writing practice variables
    let characters = [];
    let currentCharIndex = 0;
    let canvas, ctx;
    
    function initializeWriting() {
      // Set up canvas
      canvas = document.getElementById('writing-canvas');
      ctx = canvas.getContext('2d');
      
      // Set up drawing
      setupCanvas();
      
      // Select characters to practice
      characters = getHangulCharacters();
      currentCharIndex = 0;
      
      // Show first character
      showCharacter();
    }
    
    function getHangulCharacters() {
      // Basic Hangul consonants and vowels
      return [
        { char: '„Ñ±', name: 'giyeok', sound: 'g/k' },
        { char: '„Ñ¥', name: 'nieun', sound: 'n' },
        { char: '„Ñ∑', name: 'digeut', sound: 'd/t' },
        { char: '„Ñπ', name: 'rieul', sound: 'r/l' },
        { char: '„ÖÅ', name: 'mieum', sound: 'm' },
        { char: '„ÖÇ', name: 'bieup', sound: 'b/p' },
        { char: '„ÖÖ', name: 'siot', sound: 's' },
        { char: '„Öá', name: 'ieung', sound: 'ng (silent at beginning)' },
        { char: '„Öà', name: 'jieut', sound: 'j' },
        { char: '„Öä', name: 'chieut', sound: 'ch' },
        { char: '„Öã', name: 'kieuk', sound: 'k' },
        { char: '„Öå', name: 'tieut', sound: 't' },
        { char: '„Öç', name: 'pieup', sound: 'p' },
        { char: '„Öé', name: 'hieut', sound: 'h' },
        { char: '„Öè', name: 'a', sound: 'a' },
        { char: '„Öë', name: 'ya', sound: 'ya' },
        { char: '„Öì', name: 'eo', sound: 'eo' },
        { char: '„Öï', name: 'yeo', sound: 'yeo' },
        { char: '„Öó', name: 'o', sound: 'o' },
        { char: '„Öõ', name: 'yo', sound: 'yo' },
        { char: '„Öú', name: 'u', sound: 'u' },
        { char: '„Ö†', name: 'yu', sound: 'yu' },
        { char: '„Ö°', name: 'eu', sound: 'eu' },
        { char: '„Ö£', name: 'i', sound: 'i' }
      ];
    }
    
    function setupCanvas() {
      // Initialize drawing state
      ctx.lineWidth = 8;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = '#000';
      
      // Clear canvas
      clearCanvas();
      
      // Set up event listeners for drawing
      let isDrawing = false;
      let lastX = 0;
      let lastY = 0;
      
      canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
      });
      
      canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        lastX = x;
        lastY = y;
      });
      
      canvas.addEventListener('mouseup', () => {
        isDrawing = false;
      });
      
      canvas.addEventListener('mouseout', () => {
        isDrawing = false;
      });
      
      // Touch support
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        lastX = touch.clientX - rect.left;
        lastY = touch.clientY - rect.top;
        isDrawing = true;
      });
      
      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        lastX = x;
        lastY = y;
      });
      
      canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        isDrawing = false;
      });
    }
    
    function showCharacter() {
      const character = characters[currentCharIndex];
      
      document.getElementById('writing-character').textContent = character.char;
      document.getElementById('writing-pronunciation').textContent = `${character.name} (${character.sound})`;
      document.getElementById('writing-progress').textContent = `Character ${currentCharIndex + 1} of ${characters.length}`;
      
      clearCanvas();
    }
    
    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Add grid lines for guidance
      ctx.strokeStyle = '#e0e0e0';
      ctx.lineWidth = 1;
      
      // Horizontal center line
      ctx.beginPath();
      ctx.moveTo(0, canvas.height / 2);
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();
      
      // Vertical center line
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.stroke();
      
      // Reset for drawing
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 8;
    }
    
    function checkWriting() {
      // In a real app, we would use ML to check the writing
      // For this demo, we'll just give positive feedback
      const feedback = document.getElementById('writing-feedback');
      feedback.textContent = "Good effort! Practice makes perfect!";
      feedback.className = 'writing-feedback correct';
      feedback.style.display = 'block';
      
      setTimeout(() => {
        feedback.style.display = 'none';
      }, 3000);
    }
    
    function prevCharacter() {
      if (currentCharIndex > 0) {
        currentCharIndex--;
        showCharacter();
      }
    }
    
    function nextCharacter() {
      if (currentCharIndex < characters.length - 1) {
        currentCharIndex++;
        showCharacter();
      }
    }
    
    function playWritingAudio() {
      const character = characters[currentCharIndex];
      playAudio(character.char);
    }
    
    function getIncorrectOptions(correctWord, field) {
      // Get 3 random words that are different from the correct word
      const incorrectOptions = [];
      const usedValues = new Set([correctWord[field]]);
      
      // Try to get words from the same category if possible
      const sameCategory = koreanDictionary.filter(word => 
        word !== correctWord && 
        word.categories.some(cat => correctWord.categories.includes(cat))
      );
      
      // If we have enough words in the same category, use them
      if (sameCategory.length >= 3) {
        for (let i = 0; i < 3; i++) {
          let randomIndex = Math.floor(Math.random() * sameCategory.length);
          let optionValue = sameCategory[randomIndex][field];
          
          // Ensure we don't use duplicates
          while (usedValues.has(optionValue)) {
            randomIndex = (randomIndex + 1) % sameCategory.length;
            optionValue = sameCategory[randomIndex][field];
          }
          
          incorrectOptions.push(optionValue);
          usedValues.add(optionValue);
        }
      } else {
        // Otherwise use random words from the dictionary
        while (incorrectOptions.length < 3) {
          const randomIndex = Math.floor(Math.random() * koreanDictionary.length);
          const optionValue = koreanDictionary[randomIndex][field];
          
          if (!usedValues.has(optionValue)) {
            incorrectOptions.push(optionValue);
            usedValues.add(optionValue);
          }
        }
      }
      
      return incorrectOptions;
    }
    
    function selectAnswer(answerElement) {
      // Clear previous selection
      document.querySelectorAll('.answer-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      // Select the new answer
      answerElement.classList.add('selected');
      selectedAnswer = answerElement.dataset.value;
    }
    
    function initializeNumbersSection() {
      // Native Korean numbers data
      const nativeNumbers = [
        { korean: "ÌïòÎÇò", pronunciation: "hana", number: "1" },
        { korean: "Îëò", pronunciation: "dul", number: "2" },
        { korean: "ÏÖã", pronunciation: "set", number: "3" },
        { korean: "ÎÑ∑", pronunciation: "net", number: "4" },
        { korean: "Îã§ÏÑØ", pronunciation: "daseot", number: "5" },
        { korean: "Ïó¨ÏÑØ", pronunciation: "yeoseot", number: "6" },
        { korean: "ÏùºÍ≥±", pronunciation: "ilgop", number: "7" },
        { korean: "Ïó¨Îçü", pronunciation: "yeodeol", number: "8" },
        { korean: "ÏïÑÌôâ", pronunciation: "ahop", number: "9" },
        { korean: "Ïó¥", pronunciation: "yeol", number: "10" },
        { korean: "Ïä§Î¨º", pronunciation: "seumul", number: "20" },
        { korean: "ÏÑúÎ•∏", pronunciation: "seoreun", number: "30" },
        { korean: "ÎßàÌùî", pronunciation: "maheun", number: "40" },
        { korean: "Ïâ∞", pronunciation: "swin", number: "50" },
        { korean: "ÏòàÏàú", pronunciation: "yesun", number: "60" },
        { korean: "ÏùºÌùî", pronunciation: "ilheun", number: "70" },
        { korean: "Ïó¨Îì†", pronunciation: "yeodeun", number: "80" },
        { korean: "ÏïÑÌùî", pronunciation: "aheun", number: "90" },
        { korean: "Î∞±", pronunciation: "baek", number: "100" }
      ];
      
      // Sino-Korean numbers data
      const sinoNumbers = [
        { korean: "ÏòÅ", pronunciation: "yeong", number: "0" },
        { korean: "Ïùº", pronunciation: "il", number: "1" },
        { korean: "Ïù¥", pronunciation: "i", number: "2" },
        { korean: "ÏÇº", pronunciation: "sam", number: "3" },
        { korean: "ÏÇ¨", pronunciation: "sa", number: "4" },
        { korean: "Ïò§", pronunciation: "o", number: "5" },
        { korean: "Ïú°", pronunciation: "yuk", number: "6" },
        { korean: "Ïπ†", pronunciation: "chil", number: "7" },
        { korean: "Ìåî", pronunciation: "pal", number: "8" },
        { korean: "Íµ¨", pronunciation: "gu", number: "9" },
        { korean: "Ïã≠", pronunciation: "ship", number: "10" },
        { korean: "Î∞±", pronunciation: "baek", number: "100" },
        { korean: "Ï≤ú", pronunciation: "cheon", number: "1,000" },
        { korean: "Îßå", pronunciation: "man", number: "10,000" },
        { korean: "Ïñµ", pronunciation: "eok", number: "100,000,000" }
      ];
      
      // Counters data
      const counters = [
        { counter: "Í∞ú", pronunciation: "gae", usage: "General objects", example: "ÏÇ¨Í≥º Îëê Í∞ú (two apples)" },
        { counter: "Î™Ö", pronunciation: "myeong", usage: "People (formal)", example: "ÌïôÏÉù ÏÑ∏ Î™Ö (three students)" },
        { counter: "Ïûî", pronunciation: "jan", usage: "Cups of liquid", example: "Ïª§Ìîº Ìïú Ïûî (one cup of coffee)" },
        { counter: "Î≥ë", pronunciation: "byeong", usage: "Bottles", example: "Îß•Ï£º Îëê Î≥ë (two bottles of beer)" },
        { counter: "Í∂å", pronunciation: "gwon", usage: "Books", example: "Ï±Ö ÏÑ∏ Í∂å (three books)" },
        { counter: "Ïû•", pronunciation: "jang", usage: "Flat objects", example: "Ï¢ÖÏù¥ Îã§ÏÑØ Ïû• (five sheets of paper)" },
        { counter: "ÎåÄ", pronunciation: "dae", usage: "Machines, vehicles", example: "ÏûêÎèôÏ∞® Ìïú ÎåÄ (one car)" },
        { counter: "Î≤à", pronunciation: "beon", usage: "Numbers, times", example: "ÏÑ∏ Î≤à (three times)" },
        { counter: "ÎßàÎ¶¨", pronunciation: "mari", usage: "Animals", example: "Í≥†ÏñëÏù¥ Îëê ÎßàÎ¶¨ (two cats)" }
      ];
      
      // Fill the native numbers table
      const nativeNumbersBody = document.getElementById('native-numbers-body');
      nativeNumbers.forEach(num => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="padding: 8px; border: 1px solid #dee2e6;">${num.korean}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${num.pronunciation}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${num.number}</td>
          <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">
            <button class="number-audio-btn" data-text="${num.korean}" style="background: none; border: none; cursor: pointer;">üîä</button>
          </td>
        `;
        nativeNumbersBody.appendChild(row);
      });
      
      // Fill the sino-korean numbers table
      const sinoNumbersBody = document.getElementById('sino-numbers-body');
      sinoNumbers.forEach(num => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="padding: 8px; border: 1px solid #dee2e6;">${num.korean}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${num.pronunciation}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${num.number}</td>
          <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">
            <button class="number-audio-btn" data-text="${num.korean}" style="background: none; border: none; cursor: pointer;">üîä</button>
          </td>
        `;
        sinoNumbersBody.appendChild(row);
      });
      
      // Fill the counters table
      const countersBody = document.getElementById('counters-body');
      counters.forEach(counter => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="padding: 8px; border: 1px solid #dee2e6;">${counter.counter}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${counter.pronunciation}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${counter.usage}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${counter.example}</td>
          <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">
            <button class="number-audio-btn" data-text="${counter.example.split(' ').slice(0, 2).join(' ')}" style="background: none; border: none; cursor: pointer;">üîä</button>
          </td>
        `;
        countersBody.appendChild(row);
      });
      
      // Add click event for all audio buttons
      document.querySelectorAll('.number-audio-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          playPlainAudio(btn.getAttribute('data-text'));
        });
      });
      
      // Set up number practice
      initializeNumberPractice();
    }
    
    function initializeNumberPractice() {
      // Native Korean number mappings for practice
      const nativeNumberMap = {
        "1": "ÌïòÎÇò", "2": "Îëò", "3": "ÏÖã", "4": "ÎÑ∑", "5": "Îã§ÏÑØ",
        "6": "Ïó¨ÏÑØ", "7": "ÏùºÍ≥±", "8": "Ïó¨Îçü", "9": "ÏïÑÌôâ", "10": "Ïó¥",
        "20": "Ïä§Î¨º", "30": "ÏÑúÎ•∏", "40": "ÎßàÌùî", "50": "Ïâ∞",
        "60": "ÏòàÏàú", "70": "ÏùºÌùî", "80": "Ïó¨Îì†", "90": "ÏïÑÌùî", "100": "Î∞±"
      };
      
      // Composite numbers for teens, etc.
      for (let i = 11; i <= 19; i++) {
        nativeNumberMap[i] = "Ïó¥" + nativeNumberMap[i-10];
      }
      for (let i = 21; i <= 29; i++) {
        nativeNumberMap[i] = "Ïä§Î¨º" + nativeNumberMap[i-20];
      }
      for (let i = 31; i <= 39; i++) {
        nativeNumberMap[i] = "ÏÑúÎ•∏" + nativeNumberMap[i-30];
      }
      for (let i = 41; i <= 49; i++) {
        nativeNumberMap[i] = "ÎßàÌùî" + nativeNumberMap[i-40];
      }
      
      // Sino-Korean number mappings for practice
      const sinoNumberMap = {
        "0": "ÏòÅ", "1": "Ïùº", "2": "Ïù¥", "3": "ÏÇº", "4": "ÏÇ¨", "5": "Ïò§",
        "6": "Ïú°", "7": "Ïπ†", "8": "Ìåî", "9": "Íµ¨", "10": "Ïã≠"
      };
      
      // Random number for number-to-Korean practice
      function getRandomNumber() {
        let num;
        if (Math.random() < 0.7) {
          // 70% chance for 1-100
          num = Math.floor(Math.random() * 100) + 1;
        } else {
          // 30% chance for common years, times, etc.
          const commonNumbers = [0, 100, 1000, 2023, 2024, 911, 119, 112];
          num = commonNumbers[Math.floor(Math.random() * commonNumbers.length)];
        }
        return num;
      }
      
      // Convert number to Korean (native system)
      function numberToKorean(num) {
        if (num <= 100 && nativeNumberMap[num]) {
          return nativeNumberMap[num];
        }
        
        // For larger numbers, use Sino-Korean system
        let result = '';
        const numStr = num.toString();
        
        for (let i = 0; i < numStr.length; i++) {
          const digit = numStr[i];
          const position = numStr.length - i - 1;
          
          if (digit === '0') continue;
          
          result += sinoNumberMap[digit];
          
          if (position === 3) {
            result += 'Ï≤ú';
          } else if (position === 2) {
            result += 'Î∞±';
          } else if (position === 1) {
            result += 'Ïã≠';
          }
        }
        
        return result;
      }
      
      // Initialize number practice
      let currentNumber = getRandomNumber();
      document.getElementById('number-practice-display').textContent = currentNumber;
      
      // Show answer button - Number to Korean
      document.getElementById('show-number-answer').addEventListener('click', () => {
        const koreanNumber = numberToKorean(currentNumber);
        document.getElementById('number-practice-answer').textContent = koreanNumber;
        playPlainAudio(koreanNumber);
      });
      
      // Next number button
      document.getElementById('next-number-practice').addEventListener('click', () => {
        currentNumber = getRandomNumber();
        document.getElementById('number-practice-display').textContent = currentNumber;
        document.getElementById('number-practice-answer').textContent = '';
      });
      
      // Korean to number practice
      const koreanNumbers = Object.entries(nativeNumberMap).map(([num, korean]) => ({ num, korean }));
      let currentKoreanIndex = Math.floor(Math.random() * koreanNumbers.length);
      
      function updateKoreanPractice() {
        const currentKorean = koreanNumbers[currentKoreanIndex];
        document.getElementById('korean-practice-display').textContent = currentKorean.korean;
        document.getElementById('korean-practice-answer').textContent = '';
      }
      
      updateKoreanPractice();
      
      // Show answer button - Korean to Number
      document.getElementById('show-korean-answer').addEventListener('click', () => {
        const currentKorean = koreanNumbers[currentKoreanIndex];
        document.getElementById('korean-practice-answer').textContent = currentKorean.num;
        playPlainAudio(currentKorean.korean);
      });
      
      // Next word button
      document.getElementById('next-korean-practice').addEventListener('click', () => {
        currentKoreanIndex = Math.floor(Math.random() * koreanNumbers.length);
        updateKoreanPractice();
      });
    }
    
    // Add new functions for progress tracking
    function initializeProgress() {
      // Load progress data
      const progressData = JSON.parse(localStorage.getItem('koreanProgress') || '{}');
      
      // Update stats
      updateProgressStats(progressData);
      
      // Load recent activity
      loadRecentActivity();
      
      // Set up export/import handlers
      setupDataHandlers();
    }
    
    function updateProgressStats(data) {
      const totalWords = koreanDictionary.length;
      const studiedWords = Object.keys(studyProgress).length;
      const completionPercentage = Math.round((studiedWords / totalWords) * 100);
      
      // Only update elements if they exist
      const totalWordsStudied = document.getElementById('total-words-studied');
      if (totalWordsStudied) {
        totalWordsStudied.textContent = `${studiedWords} / ${totalWords}`;
      }

      const completionElement = document.getElementById('completion-percentage');
      if (completionElement) {
        completionElement.textContent = `${completionPercentage}%`;
      }

      const quizAverage = document.getElementById('quiz-average');
      if (quizAverage) {
        quizAverage.textContent = `${calculateQuizAverage()}%`;
      }
      
      // Update progress bar if it exists
      const progressBar = document.getElementById('progress-bar');
      if (progressBar) {
        progressBar.style.width = `${completionPercentage}%`;
      }
    }
    
    function loadRecentActivity() {
      const activityList = document.getElementById('activity-list');
      const recentActivity = JSON.parse(localStorage.getItem('recentActivity') || '[]');
      
      activityList.innerHTML = '';
      recentActivity.forEach(activity => {
        const item = document.createElement('div');
        item.className = 'activity-item';
        item.innerHTML = `
          <span>${activity.action}</span>
          <span>${new Date(activity.timestamp).toLocaleString()}</span>
        `;
        activityList.appendChild(item);
      });
    }
    
    function addActivity(action) {
      const recentActivity = JSON.parse(localStorage.getItem('recentActivity') || '[]');
      recentActivity.unshift({
        action,
        timestamp: Date.now()
      });
      
      // Keep only last 50 activities
      if (recentActivity.length > 50) {
        recentActivity.pop();
      }
      
      localStorage.setItem('recentActivity', JSON.stringify(recentActivity));
      loadRecentActivity();
    }
    
    function setupDataHandlers() {
      document.getElementById('export-progress').addEventListener('click', exportProgress);
      document.getElementById('import-progress').addEventListener('click', () => {
        document.getElementById('import-file').click();
      });
      
      document.getElementById('import-file').addEventListener('change', importProgress);
    }
    
    function exportProgress() {
      const data = {
        studyProgress,
        recentActivity: JSON.parse(localStorage.getItem('recentActivity') || '[]'),
        settings: JSON.parse(localStorage.getItem('koreanSettings') || '{}')
      };
      
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `korean-progress-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }
    
    function importProgress(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // Validate data structure
          if (data.studyProgress) {
            localStorage.setItem('koreanStudyProgress', JSON.stringify(data.studyProgress));
            studyProgress = data.studyProgress;
          }
          
          if (data.recentActivity) {
            localStorage.setItem('recentActivity', JSON.stringify(data.recentActivity));
          }
          
          if (data.settings) {
            localStorage.setItem('koreanSettings', JSON.stringify(data.settings));
          }
          
          // Refresh displays
          loadProgress();
          loadRecentActivity();
          
          alert('Progress imported successfully!');
        } catch (error) {
          alert('Error importing progress. Please check the file format.');
        }
      };
      reader.readAsText(file);
    }
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + / to show keyboard shortcuts
      if ((e.ctrlKey || e.metaKey) && e.key === '/') {
        e.preventDefault();
        showKeyboardShortcuts();
      }
      
      // Alt + 1-4 for navigation
      if (e.altKey && /[1-4]/.test(e.key)) {
        e.preventDefault();
        const sections = ['dictionary', 'study', 'progress', 'settings'];
        const index = parseInt(e.key) - 1;
        document.querySelector(`[data-section="${sections[index]}"]`).click();
      }
    });
    
    function showKeyboardShortcuts() {
      const shortcuts = `
        Keyboard Shortcuts:
        - Ctrl/Cmd + F: Search dictionary
        - Ctrl/Cmd + /: Show this help
        - Alt + 1: Dictionary
        - Alt + 2: Study
        - Alt + 3: Progress
        - Alt + 4: Settings
        - Space: Flip flashcard
        - Left/Right: Previous/Next flashcard
      `;
      
      alert(shortcuts);
    }
    
    // Initialize progress tracking when app loads
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize dictionary first
      console.log('DOM Content Loaded');
      
      // Make sure dictionary is loaded
      function checkDictionary() {
        console.log('Checking dictionary...');
        if (window.koreanDictionary && window.koreanDictionary.length > 0) {
          console.log('Dictionary loaded with', window.koreanDictionary.length, 'words');
          initializeProgress();
        } else {
          console.log('Dictionary not loaded yet, retrying...');
          setTimeout(checkDictionary, 500);
        }
      }
      
      // Start checking for dictionary
      checkDictionary();
    });

    // Add new words quiz functionality
    let newWordsQuizWords = [];
    let newWordsCurrentQuestionIndex = 0;
    let newWordsQuizScore = 0;
    let newWordsSelectedAnswer = null;
    let newWordsQuizStartTime;

    function initializeNewWordsQuiz() {
      // Reset quiz state
      document.getElementById('new-words-quiz-feedback').style.display = 'none';
      document.getElementById('new-words-quiz-feedback').className = 'quiz-feedback';
      
      // Get all words that haven't been studied yet
      const newWords = koreanDictionary.filter(word => !studyProgress[word.korean]);
      
      // If all words have been studied, include all words
      newWordsQuizWords = newWords.length > 0 ? newWords : [...koreanDictionary];
      
      // Shuffle the words
      newWordsQuizWords = shuffleArray(newWordsQuizWords);
      
      // Reset variables
      newWordsCurrentQuestionIndex = 0;
      
      // Start the quiz
      showNewWordsQuestion();
    }

    function showNewWordsQuestion() {
      const word = newWordsQuizWords[newWordsCurrentQuestionIndex];
      
      // Clear previous selections
      newWordsSelectedAnswer = null;
      document.getElementById('next-new-words-btn').disabled = false;
      document.getElementById('check-new-words-answer-btn').disabled = false;
      
      // Clear previous feedback
      document.getElementById('new-words-quiz-feedback').style.display = 'none';
      
      // Randomly choose question type (Korean to English or English to Korean)
      const isKoreanToEnglish = Math.random() < 0.5;
      
      const questionText = document.getElementById('new-words-question-text');
      const questionHint = document.getElementById('new-words-question-hint');
      
      if (isKoreanToEnglish) {
        questionText.textContent = word.korean;
        questionHint.textContent = `What does this word mean?`;
        
        // Get incorrect options (English translations)
        const incorrectOptions = getIncorrectOptions(word, 'translation');
        const allOptions = shuffleArray([word.translation, ...incorrectOptions]);
        createNewWordsAnswerOptions(allOptions);
        
      } else {
        questionText.textContent = word.translation;
        questionHint.textContent = `What's the Korean word for this?`;
        
        // Get incorrect options (Korean words)
        const incorrectOptions = getIncorrectOptions(word, 'korean');
        const allOptions = shuffleArray([word.korean, ...incorrectOptions]);
        createNewWordsAnswerOptions(allOptions);
      }
      
      // Set up audio button
      const audioBtn = document.getElementById('new-words-audio-btn');
      audioBtn.onclick = () => playPlainAudio(word.korean);
    }

    function createNewWordsAnswerOptions(options) {
      const answersContainer = document.getElementById('new-words-answers-container');
      answersContainer.innerHTML = '';
      
      options.forEach(option => {
        const answerBtn = document.createElement('div');
        answerBtn.className = 'answer-option';
        answerBtn.textContent = option;
        answerBtn.dataset.value = option;
        answerBtn.addEventListener('click', () => selectNewWordsAnswer(answerBtn));
        answersContainer.appendChild(answerBtn);
      });
    }

    function selectNewWordsAnswer(answerElement) {
      document.querySelectorAll('.answer-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      answerElement.classList.add('selected');
      newWordsSelectedAnswer = answerElement.dataset.value;
    }

    function checkNewWordsAnswer() {
      if (!newWordsSelectedAnswer) {
        alert('Please select an answer');
        return;
      }
      
      const word = newWordsQuizWords[newWordsCurrentQuestionIndex];
      const isKoreanToEnglish = word.korean !== newWordsSelectedAnswer;
      
      const correctAnswer = isKoreanToEnglish ? word.translation : word.korean;
      const isCorrect = newWordsSelectedAnswer === correctAnswer;
      
      // Update UI
      document.querySelectorAll('.answer-option').forEach(opt => {
        if (opt.dataset.value === correctAnswer) {
          opt.classList.add('correct');
        } else if (opt.dataset.value === newWordsSelectedAnswer && !isCorrect) {
          opt.classList.add('incorrect');
        }
      });
      
      // Show feedback
      const feedback = document.getElementById('new-words-quiz-feedback');
      
      if (isCorrect) {
        feedback.className = 'quiz-feedback correct';
        feedback.textContent = 'Correct! üëç';
        newWordsQuizScore++;
        document.getElementById('new-words-quiz-score').textContent = newWordsQuizScore;
      } else {
        feedback.className = 'quiz-feedback incorrect';
        feedback.textContent = `Incorrect. The correct answer is: ${correctAnswer}`;
      }
      
      // Add detailed feedback
      const detailedDiv = document.createElement('div');
      detailedDiv.style.marginTop = '15px';
      detailedDiv.style.backgroundColor = '#f8f9fa';
      detailedDiv.style.padding = '20px';
      detailedDiv.style.borderRadius = '10px';
      detailedDiv.style.textAlign = 'left';
      
      const wordInfo = document.createElement('div');
      wordInfo.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 15px;">Word Information:</div>
        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background-color: white; border-radius: 8px; flex-wrap: wrap;">
          <div style="font-weight: bold; font-size: 28px;">${word.korean}</div>
          <div style="color: #666; font-size: 18px;">(${word.pronunciation})</div>
          <div style="font-size: 18px;">${word.translation}</div>
          <button onclick="playPlainAudio('${word.korean}')" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 24px;">üîä</button>
        </div>
      `;
      
      detailedDiv.appendChild(wordInfo);
      
      if (word.example) {
        const exampleDiv = document.createElement('div');
        exampleDiv.innerHTML = `
          <div style="font-weight: bold; margin: 15px 0 10px;">Example:</div>
          <div style="background-color: #f5f5f5; padding: 15px; border-radius: 8px;">
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 16px;">${word.example.split('(')[0]}</div>
            <div style="font-style: italic; color: #666;">${word.example.split('(')[1]?.replace(')', '') || ''}</div>
          </div>
        `;
        detailedDiv.appendChild(exampleDiv);
      }
      
      feedback.appendChild(detailedDiv);
      feedback.style.display = 'block';
      
      // Update progress for this word
      if (!studyProgress[word.korean]) {
        studyProgress[word.korean] = { count: 0, lastReview: 0 };
      }
      studyProgress[word.korean].count++;
      studyProgress[word.korean].lastReview = Date.now();
      saveProgress();
      
      // Enable next button
      document.getElementById('check-new-words-answer-btn').disabled = true;
      document.getElementById('next-new-words-btn').disabled = false;
    }

    function nextNewWordsQuestion() {
      // Move to next word, or loop back to beginning if at end
      newWordsCurrentQuestionIndex = (newWordsCurrentQuestionIndex + 1) % newWordsQuizWords.length;
      showNewWordsQuestion();
    }

    // Update event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // ... existing initialization ...
      
      // Set up new words quiz
      document.getElementById('new-words-quiz-option').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'none';
        document.querySelector('.new-words-quiz-container').style.display = 'block';
        document.querySelector('.flashcard-container').style.display = 'none';
        document.querySelector('.quiz-container').style.display = 'none';
        document.querySelector('.writing-container').style.display = 'none';
        document.querySelector('.numbers-container').style.display = 'none';
        initializeNewWordsQuiz();
      });
      
      // Set up back button for new words quiz
      document.getElementById('back-from-new-words-quiz').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'flex';
        document.querySelector('.new-words-quiz-container').style.display = 'none';
      });
      
      // New words quiz buttons
      document.getElementById('check-new-words-answer-btn').addEventListener('click', checkNewWordsAnswer);
      document.getElementById('next-new-words-btn').addEventListener('click', nextNewWordsQuestion);
    });

    // Add grammar and sentence practice functionality
    const sentenceQuizBank = [
      // Present Tense
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'I study Korean'", words: ["Ï†ÄÎäî", "ÌïúÍµ≠Ïñ¥Î•º", "Í≥µÎ∂ÄÌï¥Ïöî"], correct: "Ï†ÄÎäî ÌïúÍµ≠Ïñ¥Î•º Í≥µÎ∂ÄÌï¥Ïöî", translation: "I study Korean", wordExplanations: ["Ï†ÄÎäî = I", "ÌïúÍµ≠Ïñ¥Î•º = Korean (object)", "Í≥µÎ∂ÄÌï¥Ïöî = study"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'You play soccer'", words: ["ÎãπÏã†ÏùÄ", "Ï∂ïÍµ¨Î•º", "Ìï¥Ïöî"], correct: "ÎãπÏã†ÏùÄ Ï∂ïÍµ¨Î•º Ìï¥Ïöî", translation: "You play soccer", wordExplanations: ["ÎãπÏã†ÏùÄ = You", "Ï∂ïÍµ¨Î•º = soccer (object)", "Ìï¥Ïöî = play/do"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'She drinks milk'", words: ["Í∑∏ÎÖÄÎäî", "Ïö∞Ïú†Î•º", "ÎßàÏÖîÏöî"], correct: "Í∑∏ÎÖÄÎäî Ïö∞Ïú†Î•º ÎßàÏÖîÏöî", translation: "She drinks milk", wordExplanations: ["Í∑∏ÎÖÄÎäî = She", "Ïö∞Ïú†Î•º = milk (object)", "ÎßàÏÖîÏöî = drinks"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'We read books'", words: ["Ïö∞Î¶¨Îäî", "Ï±ÖÏùÑ", "ÏùΩÏñ¥Ïöî"], correct: "Ïö∞Î¶¨Îäî Ï±ÖÏùÑ ÏùΩÏñ¥Ïöî", translation: "We read books", wordExplanations: ["Ïö∞Î¶¨Îäî = We", "Ï±ÖÏùÑ = book (object)", "ÏùΩÏñ¥Ïöî = read"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'He eats rice'", words: ["Í∑∏Îäî", "Î∞•ÏùÑ", "Î®πÏñ¥Ïöî"], correct: "Í∑∏Îäî Î∞•ÏùÑ Î®πÏñ¥Ïöî", translation: "He eats rice", wordExplanations: ["Í∑∏Îäî = He", "Î∞•ÏùÑ = rice (object)", "Î®πÏñ¥Ïöî = eats"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'They watch TV'", words: ["Í∑∏Îì§ÏùÄ", "ÌÖîÎ†àÎπÑÏ†ÑÏùÑ", "Î¥êÏöî"], correct: "Í∑∏Îì§ÏùÄ ÌÖîÎ†àÎπÑÏ†ÑÏùÑ Î¥êÏöî", translation: "They watch TV", wordExplanations: ["Í∑∏Îì§ÏùÄ = They", "ÌÖîÎ†àÎπÑÏ†ÑÏùÑ = TV (object)", "Î¥êÏöî = watch"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'I listen to music'", words: ["Ï†ÄÎäî", "ÏùåÏïÖÏùÑ", "Îì§Ïñ¥Ïöî"], correct: "Ï†ÄÎäî ÏùåÏïÖÏùÑ Îì§Ïñ¥Ïöî", translation: "I listen to music", wordExplanations: ["Ï†ÄÎäî = I", "ÏùåÏïÖÏùÑ = music (object)", "Îì§Ïñ¥Ïöî = listen"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'You write a letter'", words: ["ÎãπÏã†ÏùÄ", "Ìé∏ÏßÄÎ•º", "Ïç®Ïöî"], correct: "ÎãπÏã†ÏùÄ Ìé∏ÏßÄÎ•º Ïç®Ïöî", translation: "You write a letter", wordExplanations: ["ÎãπÏã†ÏùÄ = You", "Ìé∏ÏßÄÎ•º = letter (object)", "Ïç®Ïöî = write"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'We make bread'", words: ["Ïö∞Î¶¨Îäî", "ÎπµÏùÑ", "ÎßåÎì§Ïñ¥Ïöî"], correct: "Ïö∞Î¶¨Îäî ÎπµÏùÑ ÎßåÎì§Ïñ¥Ïöî", translation: "We make bread", wordExplanations: ["Ïö∞Î¶¨Îäî = We", "ÎπµÏùÑ = bread (object)", "ÎßåÎì§Ïñ¥Ïöî = make"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'She opens the door'", words: ["Í∑∏ÎÖÄÎäî", "Î¨∏ÏùÑ", "Ïó¥Ïñ¥Ïöî"], correct: "Í∑∏ÎÖÄÎäî Î¨∏ÏùÑ Ïó¥Ïñ¥Ïöî", translation: "She opens the door", wordExplanations: ["Í∑∏ÎÖÄÎäî = She", "Î¨∏ÏùÑ = door (object)", "Ïó¥Ïñ¥Ïöî = opens"] },
      // Past Tense
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'I ate breakfast'", words: ["Ï†ÄÎäî", "ÏïÑÏπ®ÏùÑ", "Î®πÏóàÏñ¥Ïöî"], correct: "Ï†ÄÎäî ÏïÑÏπ®ÏùÑ Î®πÏóàÏñ¥Ïöî", translation: "I ate breakfast", wordExplanations: ["Ï†ÄÎäî = I", "ÏïÑÏπ®ÏùÑ = breakfast (object)", "Î®πÏóàÏñ¥Ïöî = ate"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'He went home'", words: ["Í∑∏Îäî", "ÏßëÏóê", "Í∞îÏñ¥Ïöî"], correct: "Í∑∏Îäî ÏßëÏóê Í∞îÏñ¥Ïöî", translation: "He went home", wordExplanations: ["Í∑∏Îäî = He", "ÏßëÏóê = home (object)", "Í∞îÏñ¥Ïöî = went"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'They watched a movie'", words: ["Í∑∏Îì§ÏùÄ", "ÏòÅÌôîÎ•º", "Î¥§Ïñ¥Ïöî"], correct: "Í∑∏Îì§ÏùÄ ÏòÅÌôîÎ•º Î¥§Ïñ¥Ïöî", translation: "They watched a movie", wordExplanations: ["Í∑∏Îì§ÏùÄ = They", "ÏòÅÌôîÎ•º = movie (object)", "Î¥§Ïñ¥Ïöî = watched"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'We met yesterday'", words: ["Ïö∞Î¶¨Îäî", "Ïñ¥Ï†ú", "ÎßåÎÇ¨Ïñ¥Ïöî"], correct: "Ïö∞Î¶¨Îäî Ïñ¥Ï†ú ÎßåÎÇ¨Ïñ¥Ïöî", translation: "We met yesterday", wordExplanations: ["Ïö∞Î¶¨Îäî = We", "Ïñ¥Ï†ú = yesterday (object)", "ÎßåÎÇ¨Ïñ¥Ïöî = met"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'She bought shoes'", words: ["Í∑∏ÎÖÄÎäî", "Ïã†Î∞úÏùÑ", "ÏÉÄÏñ¥Ïöî"], correct: "Í∑∏ÎÖÄÎäî Ïã†Î∞úÏùÑ ÏÉÄÏñ¥Ïöî", translation: "She bought shoes", wordExplanations: ["Í∑∏ÎÖÄÎäî = She", "Ïã†Î∞úÏùÑ = shoes (object)", "ÏÉÄÏñ¥Ïöî = bought"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'You wrote a letter'", words: ["ÎãπÏã†ÏùÄ", "Ìé∏ÏßÄÎ•º", "ÏçºÏñ¥Ïöî"], correct: "ÎãπÏã†ÏùÄ Ìé∏ÏßÄÎ•º ÏçºÏñ¥Ïöî", translation: "You wrote a letter", wordExplanations: ["ÎãπÏã†ÏùÄ = You", "Ìé∏ÏßÄÎ•º = letter (object)", "ÏçºÏñ¥Ïöî = wrote"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'I read a book'", words: ["Ï†ÄÎäî", "Ï±ÖÏùÑ", "ÏùΩÏóàÏñ¥Ïöî"], correct: "Ï†ÄÎäî Ï±ÖÏùÑ ÏùΩÏóàÏñ¥Ïöî", translation: "I read a book", wordExplanations: ["Ï†ÄÎäî = I", "Ï±ÖÏùÑ = book (object)", "ÏùΩÏóàÏñ¥Ïöî = read"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'We made bread'", words: ["Ïö∞Î¶¨Îäî", "ÎπµÏùÑ", "ÎßåÎì§ÏóàÏñ¥Ïöî"], correct: "Ïö∞Î¶¨Îäî ÎπµÏùÑ ÎßåÎì§ÏóàÏñ¥Ïöî", translation: "We made bread", wordExplanations: ["Ïö∞Î¶¨Îäî = We", "ÎπµÏùÑ = bread (object)", "ÎßåÎì§ÏóàÏñ¥Ïöî = made"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'He closed the door'", words: ["Í∑∏Îäî", "Î¨∏ÏùÑ", "Îã´ÏïòÏñ¥Ïöî"], correct: "Í∑∏Îäî Î¨∏ÏùÑ Îã´ÏïòÏñ¥Ïöî", translation: "He closed the door", wordExplanations: ["Í∑∏Îäî = He", "Î¨∏ÏùÑ = door (object)", "Îã´ÏïòÏñ¥Ïöî = closed"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'She drank milk'", words: ["Í∑∏ÎÖÄÎäî", "Ïö∞Ïú†Î•º", "ÎßàÏÖ®Ïñ¥Ïöî"], correct: "Í∑∏ÎÖÄÎäî Ïö∞Ïú†Î•º ÎßàÏÖ®Ïñ¥Ïöî", translation: "She drank milk", wordExplanations: ["Í∑∏ÎÖÄÎäî = She", "Ïö∞Ïú†Î•º = milk (object)", "ÎßàÏÖ®Ïñ¥Ïöî = drank"] },
      // Future Tense
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'I will call you'", words: ["Ï†úÍ∞Ä", "ÎãπÏã†ÏóêÍ≤å", "Ï†ÑÌôîÌï† Í±∞ÏòàÏöî"], correct: "Ï†úÍ∞Ä ÎãπÏã†ÏóêÍ≤å Ï†ÑÌôîÌï† Í±∞ÏòàÏöî", translation: "I will call you", wordExplanations: ["Ï†úÍ∞Ä = I", "ÎãπÏã†ÏóêÍ≤å = you (object)", "Ï†ÑÌôîÌï† Í±∞ÏòàÏöî = will call"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'She will study tomorrow'", words: ["Í∑∏ÎÖÄÎäî", "ÎÇ¥Ïùº", "Í≥µÎ∂ÄÌï† Í±∞ÏòàÏöî"], correct: "Í∑∏ÎÖÄÎäî ÎÇ¥Ïùº Í≥µÎ∂ÄÌï† Í±∞ÏòàÏöî", translation: "She will study tomorrow", wordExplanations: ["Í∑∏ÎÖÄÎäî = She", "ÎÇ¥Ïùº = tomorrow (object)", "Í≥µÎ∂ÄÌï† Í±∞ÏòàÏöî = will study"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'We will travel to Korea'", words: ["Ïö∞Î¶¨Îäî", "ÌïúÍµ≠Ïóê", "Ïó¨ÌñâÌï† Í±∞ÏòàÏöî"], correct: "Ïö∞Î¶¨Îäî ÌïúÍµ≠Ïóê Ïó¨ÌñâÌï† Í±∞ÏòàÏöî", translation: "We will travel to Korea", wordExplanations: ["Ïö∞Î¶¨Îäî = We", "ÌïúÍµ≠Ïóê = Korean (object)", "Ïó¨ÌñâÌï† Í±∞ÏòàÏöî = will travel"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'He will buy a car'", words: ["Í∑∏Îäî", "Ï∞®Î•º", "ÏÇ¥ Í±∞ÏòàÏöî"], correct: "Í∑∏Îäî Ï∞®Î•º ÏÇ¥ Í±∞ÏòàÏöî", translation: "He will buy a car", wordExplanations: ["Í∑∏Îäî = He", "Ï∞®Î•º = car (object)", "ÏÇ¥ Í±∞ÏòàÏöî = will buy"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'They will meet tomorrow'", words: ["Í∑∏Îì§ÏùÄ", "ÎÇ¥Ïùº", "ÎßåÎÇ† Í±∞ÏòàÏöî"], correct: "Í∑∏Îì§ÏùÄ ÎÇ¥Ïùº ÎßåÎÇ† Í±∞ÏòàÏöî", translation: "They will meet tomorrow", wordExplanations: ["Í∑∏Îì§ÏùÄ = They", "ÎÇ¥Ïùº = tomorrow (object)", "ÎßåÎÇ† Í±∞ÏòàÏöî = will meet"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'I will eat dinner'", words: ["Ï†ÄÎäî", "Ï†ÄÎÖÅÏùÑ", "Î®πÏùÑ Í±∞ÏòàÏöî"], correct: "Ï†ÄÎäî Ï†ÄÎÖÅÏùÑ Î®πÏùÑ Í±∞ÏòàÏöî", translation: "I will eat dinner", wordExplanations: ["Ï†ÄÎäî = I", "Ï†ÄÎÖÅÏùÑ = dinner (object)", "Î®πÏùÑ Í±∞ÏòàÏöî = will eat"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'You will write a letter'", words: ["ÎãπÏã†ÏùÄ", "Ìé∏ÏßÄÎ•º", "Ïì∏ Í±∞ÏòàÏöî"], correct: "ÎãπÏã†ÏùÄ Ìé∏ÏßÄÎ•º Ïì∏ Í±∞ÏòàÏöî", translation: "You will write a letter", wordExplanations: ["ÎãπÏã†ÏùÄ = You", "Ìé∏ÏßÄÎ•º = letter (object)", "Ïì∏ Í±∞ÏòàÏöî = will write"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'We will make bread'", words: ["Ïö∞Î¶¨Îäî", "ÎπµÏùÑ", "ÎßåÎì§ Í±∞ÏòàÏöî"], correct: "Ïö∞Î¶¨Îäî ÎπµÏùÑ ÎßåÎì§ Í±∞ÏòàÏöî", translation: "We will make bread", wordExplanations: ["Ïö∞Î¶¨Îäî = We", "ÎπµÏùÑ = bread (object)", "ÎßåÎì§ Í±∞ÏòàÏöî = will make"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'She will open the door'", words: ["Í∑∏ÎÖÄÎäî", "Î¨∏ÏùÑ", "Ïó¥ Í±∞ÏòàÏöî"], correct: "Í∑∏ÎÖÄÎäî Î¨∏ÏùÑ Ïó¥ Í±∞ÏòàÏöî", translation: "She will open the door", wordExplanations: ["Í∑∏ÎÖÄÎäî = She", "Î¨∏ÏùÑ = door (object)", "Ïó¥ Í±∞ÏòàÏöî = will open"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'He will drink milk'", words: ["Í∑∏Îäî", "Ïö∞Ïú†Î•º", "ÎßàÏã§ Í±∞ÏòàÏöî"], correct: "Í∑∏Îäî Ïö∞Ïú†Î•º ÎßàÏã§ Í±∞ÏòàÏöî", translation: "He will drink milk", wordExplanations: ["Í∑∏Îäî = He", "Ïö∞Ïú†Î•º = milk (object)", "ÎßàÏã§ Í±∞ÏòàÏöî = will drink"] },
      // Negation
      { level: 2, grammar: "Negation", prompt: "Make a sentence: 'I don't like coffee'", words: ["Ï†ÄÎäî", "Ïª§ÌîºÎ•º", "Ïïà Ï¢ãÏïÑÌï¥Ïöî"], correct: "Ï†ÄÎäî Ïª§ÌîºÎ•º Ïïà Ï¢ãÏïÑÌï¥Ïöî", translation: "I don't like coffee", wordExplanations: ["Ï†ÄÎäî = I", "Ïª§ÌîºÎ•º = coffee (object)", "Ïïà Ï¢ãÏïÑÌï¥Ïöî = don't like"] },
      { level: 2, grammar: "Negation", prompt: "Make a sentence: 'He doesn't eat meat'", words: ["Í∑∏Îäî", "Í≥†Í∏∞Î•º", "Ïïà Î®πÏñ¥Ïöî"], correct: "Í∑∏Îäî Í≥†Í∏∞Î•º Ïïà Î®πÏñ¥Ïöî", translation: "He doesn't eat meat", wordExplanations: ["Í∑∏Îäî = He", "Í≥†Í∏∞Î•º = meat (object)", "Ïïà Î®πÏñ¥Ïöî = doesn't eat"] },
      { level: 2, grammar: "Negation", prompt: "Make a sentence: 'We don't watch TV'", words: ["Ïö∞Î¶¨Îäî", "ÌÖîÎ†àÎπÑÏ†ÑÏùÑ", "Ïïà Î¥êÏöî"], correct: "Ïö∞Î¶¨Îäî ÌÖîÎ†àÎπÑÏ†ÑÏùÑ Ïïà Î¥êÏöî", translation: "We don't watch TV", wordExplanations: ["Ïö∞Î¶¨Îäî = We", "ÌÖîÎ†àÎπÑÏ†ÑÏùÑ = TV (object)", "Ïïà Î¥êÏöî = don't watch"] },
      { level: 2, grammar: "Negation", prompt: "Make a sentence: 'She doesn't drink milk'", words: ["Í∑∏ÎÖÄÎäî", "Ïö∞Ïú†Î•º", "Ïïà ÎßàÏÖîÏöî"], correct: "Í∑∏ÎÖÄÎäî Ïö∞Ïú†Î•º Ïïà ÎßàÏÖîÏöî", translation: "She doesn't drink milk", wordExplanations: ["Í∑∏ÎÖÄÎäî = She", "Ïö∞Ïú†Î•º = milk (object)", "Ïïà ÎßàÏÖîÏöî = doesn't drink"] },
      { level: 2, grammar: "Negation", prompt: "Make a sentence: 'I don't write letters'", words: ["Ï†ÄÎäî", "Ìé∏ÏßÄÎ•º", "Ïïà Ïç®Ïöî"], correct: "Ï†ÄÎäî Ìé∏ÏßÄÎ•º Ïïà Ïç®Ïöî", translation: "I don't write letters", wordExplanations: ["Ï†ÄÎäî = I", "Ìé∏ÏßÄÎ•º = letters (object)", "Ïïà Ïç®Ïöî = don't write"] },
      { level: 2, grammar: "Negation", prompt: "Make a sentence: 'They don't make bread'", words: ["Í∑∏Îì§ÏùÄ", "ÎπµÏùÑ", "Ïïà ÎßåÎì§Ïñ¥Ïöî"], correct: "Í∑∏Îì§ÏùÄ ÎπµÏùÑ Ïïà ÎßåÎì§Ïñ¥Ïöî", translation: "They don't make bread", wordExplanations: ["Í∑∏Îì§ÏùÄ = They", "ÎπµÏùÑ = bread (object)", "Ïïà ÎßåÎì§Ïñ¥Ïöî = don't make"] },
      // Questions
      { level: 2, grammar: "Questions", prompt: "Make a sentence: 'Where do you live?'", words: ["Ïñ¥ÎîîÏóê", "ÏÇ¥ÏïÑÏöî?", "ÎãπÏã†ÏùÄ"], correct: "ÎãπÏã†ÏùÄ Ïñ¥ÎîîÏóê ÏÇ¥ÏïÑÏöî?", translation: "Where do you live?", wordExplanations: ["Ïñ¥ÎîîÏóê = Where", "ÏÇ¥ÏïÑÏöî? = are you living?", "ÎãπÏã†ÏùÄ = You"] },
      { level: 2, grammar: "Questions", prompt: "Make a sentence: 'What are you doing?'", words: ["Î≠ê", "ÌïòÍ≥†", "ÏûàÏñ¥Ïöî?"], correct: "Î≠ê ÌïòÍ≥† ÏûàÏñ¥Ïöî?", translation: "What are you doing?", wordExplanations: ["Î≠ê = What", "ÌïòÍ≥† = and", "ÏûàÏñ¥Ïöî? = are you doing?"] },
      { level: 2, grammar: "Questions", prompt: "Make a sentence: 'When will you come?'", words: ["Ïñ∏Ï†ú", "Ïò¨", "Í±∞ÏòàÏöî?"], correct: "Ïñ∏Ï†ú Ïò¨ Í±∞ÏòàÏöî?", translation: "When will you come?", wordExplanations: ["Ïñ∏Ï†ú = When", "Ïò¨ = you (object)", "Í±∞ÏòàÏöî? = will you come?"] },
      { level: 2, grammar: "Questions", prompt: "Make a sentence: 'Who is coming?'", words: ["ÎàÑÍ∞Ä", "Ïò§Í≥†", "ÏûàÏñ¥Ïöî?"], correct: "ÎàÑÍ∞Ä Ïò§Í≥† ÏûàÏñ¥Ïöî?", translation: "Who is coming?", wordExplanations: ["ÎàÑÍ∞Ä = Who", "Ïò§Í≥† = are you coming?", "ÏûàÏñ¥Ïöî? = are you coming?"] },
      { level: 2, grammar: "Questions", prompt: "Make a sentence: 'Why are you laughing?'", words: ["Ïôú", "ÏõÉÍ≥†", "ÏûàÏñ¥Ïöî?"], correct: "Ïôú ÏõÉÍ≥† ÏûàÏñ¥Ïöî?", translation: "Why are you laughing?", wordExplanations: ["Ïôú = Why", "ÏõÉÍ≥† = are you laughing?", "ÏûàÏñ¥Ïöî? = are you laughing?"] },
      { level: 2, grammar: "Questions", prompt: "Make a sentence: 'How do you go to school?'", words: ["Ïñ¥ÎñªÍ≤å", "ÌïôÍµêÏóê", "Í∞ÄÏöî?"], correct: "Ïñ¥ÎñªÍ≤å ÌïôÍµêÏóê Í∞ÄÏöî?", translation: "How do you go to school?", wordExplanations: ["Ïñ¥ÎñªÍ≤å = How", "ÌïôÍµêÏóê = Korean (object)", "Í∞ÄÏöî? = do you go to school?"] },
      // Add more as needed for variety and challenge
    ];

    let userStreak = 0;
    let currentDifficulty = 1;
    let currentQuizIndex = null;

    function getNextQuizIndex() {
      // Filter questions by currentDifficulty or lower
      const available = sentenceQuizBank.filter(q => q.level <= currentDifficulty);
      // If user is doing well, increase difficulty
      if (userStreak >= 3 && currentDifficulty < 6) {
        currentDifficulty++;
        userStreak = 0;
      }
      // If user is struggling, decrease difficulty
      if (userStreak <= -2 && currentDifficulty > 1) {
        currentDifficulty--;
        userStreak = 0;
      }
      // Pick a random question from available
      const idx = Math.floor(Math.random() * available.length);
      return sentenceQuizBank.indexOf(available[idx]);
    }

    // Add a grammar explanation map for each structure
    const grammarExplanations = {
      "Present Tense": "Present tense: verb stem + -ÏïÑÏöî/-Ïñ¥Ïöî. Example: Î®πÎã§ ‚Üí Î®πÏñ¥Ïöî (eat)",
      "Past Tense": "Past tense: verb stem + -ÏïòÏñ¥Ïöî/-ÏóàÏñ¥Ïöî. Example: Í∞ÄÎã§ ‚Üí Í∞îÏñ¥Ïöî (went)",
      "Future Tense": "Future tense: verb stem + -„Ñπ/ÏùÑ Í±∞ÏòàÏöî. Example: Í∞ÄÎã§ ‚Üí Í∞à Í±∞ÏòàÏöî (will go)",
      "Negation": "Negation: Ïïà + verb or verb stem + -ÏßÄ ÏïäÏïÑÏöî. Example: Ïïà Î®πÏñ¥Ïöî (don't eat)",
      "Questions": "Questions: add a question word or ?. Example: Ïñ¥ÎîîÏóê Í∞ÄÏöî? (Where are you going?)"
    };

    function showGrammarLesson() {
      // Pick a new quiz
      currentQuizIndex = getNextQuizIndex();
      const quiz = sentenceQuizBank[currentQuizIndex];
      // Show grammar structure/point as a heading
      document.getElementById('grammar-title').textContent = quiz.grammar;
      // Show grammar explanation if available
      document.getElementById('grammar-content').innerHTML = grammarExplanations[quiz.grammar] || '';
      document.getElementById('sentence-prompt').textContent = quiz.prompt;
      // Shuffle word bank every time
      const shuffled = quiz.words.slice().sort(() => Math.random() - 0.5);
      const wordBank = document.getElementById('word-bank');
      wordBank.innerHTML = '';
      shuffled.forEach((word, idx) => {
        const wordElement = document.createElement('div');
        wordElement.className = 'word-item';
        wordElement.textContent = word;
        wordElement.onclick = function() {
          // Move word to answer area
          addWordToSentence(word, idx);
          wordElement.style.visibility = 'hidden';
        };
        wordBank.appendChild(wordElement);
      });
      document.getElementById('sentence-construction').innerHTML = '';
      document.getElementById('sentence-feedback').style.display = 'none';
    }

    function addWordToSentence(word, idx) {
      const construction = document.getElementById('sentence-construction');
      const wordElement = document.createElement('div');
      wordElement.className = 'word-item';
      wordElement.textContent = word;
      wordElement.onclick = function() {
        // Remove word from answer area and make it visible again in word bank
        construction.removeChild(wordElement);
        document.getElementById('word-bank').children[idx].style.visibility = 'visible';
      };
      construction.appendChild(wordElement);
    }

    document.getElementById('check-sentence-btn').onclick = function() {
      const construction = document.getElementById('sentence-construction');
      const userSentence = Array.from(construction.children)
        .map(word => word.textContent)
        .join(' ');
      const quiz = sentenceQuizBank[currentQuizIndex];
      const correctSentence = quiz.correct;
      const feedback = document.getElementById('sentence-feedback');
      if (userSentence === correctSentence) {
        feedback.className = 'sentence-feedback correct';
        feedback.textContent = 'Correct! Well done!';
        userStreak++;
      } else {
        feedback.className = 'sentence-feedback incorrect';
        feedback.textContent = `Incorrect. The correct sentence is: ${correctSentence}`;
        userStreak--;
      }
      feedback.style.display = 'block';
      // Show per-word explanation and translation
      let explainDiv = document.getElementById('sentence-explanation');
      if (!explainDiv) {
        explainDiv = document.createElement('div');
        explainDiv.id = 'sentence-explanation';
        feedback.parentNode.insertBefore(explainDiv, feedback.nextSibling);
      }
      explainDiv.innerHTML = `<div style='margin-top:10px;'><b>Translation:</b> ${quiz.translation || ''}</div>`;
      if (quiz.wordExplanations) {
        explainDiv.innerHTML += `<div style='margin-top:5px;'><b>Word breakdown:</b><ul style='margin:5px 0 0 20px;'>${quiz.wordExplanations.map(w => `<li>${w}</li>`).join('')}</ul></div>`;
      }
    };

    document.getElementById('clear-sentence-btn').onclick = function() {
      document.getElementById('sentence-construction').innerHTML = '';
      // Make all word bank words visible again
      Array.from(document.getElementById('word-bank').children).forEach(el => el.style.visibility = 'visible');
      document.getElementById('sentence-feedback').style.display = 'none';
    };

    document.getElementById('next-sentence-btn').onclick = function() {
      showGrammarLesson();
    };

    // Add grammar option to study options
    document.querySelector('.study-options').innerHTML += `
      <div class="study-card" onclick="showSection('grammar')">
        <h3>Grammar & Sentences</h3>
        <p>Learn Korean grammar and practice making sentences</p>
      </div>
    `;

    // Update showSection function to handle grammar section
    function showSection(section) {
      // Hide all study containers
      document.querySelector('.flashcard-container').style.display = 'none';
      document.querySelector('.quiz-container').style.display = 'none';
      document.querySelector('.writing-container').style.display = 'none';
      document.querySelector('.numbers-container').style.display = 'none';
      document.querySelector('.grammar-container').style.display = 'none';
      document.querySelector('.study-options').style.display = 'none';

      // Show the selected section
      if (section === 'flashcard') {
        document.querySelector('.flashcard-container').style.display = 'block';
      } else if (section === 'quiz') {
        document.querySelector('.quiz-container').style.display = 'block';
      } else if (section === 'writing') {
        document.querySelector('.writing-container').style.display = 'block';
      } else if (section === 'numbers') {
        document.querySelector('.numbers-container').style.display = 'block';
      } else if (section === 'grammar') {
        document.querySelector('.grammar-container').style.display = 'block';
        showGrammarLesson();
      }
    }
    // Add event listener for back button in grammar section
    document.getElementById('back-from-grammar').onclick = function(e) {
      e.preventDefault();
      document.querySelector('.grammar-container').style.display = 'none';
      document.querySelector('.study-options').style.display = 'flex';
    };

    // List of grammar topics
    const grammarTopics = [
      { key: "Present Tense", label: "Present Tense" },
      { key: "Past Tense", label: "Past Tense" },
      { key: "Future Tense", label: "Future Tense" },
      { key: "Negation", label: "Negation" },
      { key: "Questions", label: "Questions" }
    ];

    // Add a grammar topic selection UI
    const grammarContainer = document.querySelector('.grammar-container');
    let selectedGrammarTopic = null;

    function showGrammarTopicSelection() {
      selectedGrammarTopic = null;
      grammarContainer.innerHTML = `
        <div class="study-header">
          <a href="#" class="back-btn" id="back-from-grammar">‚Üê Back to Study Options</a>
          <div id="grammar-progress"></div>
        </div>
        <div class="grammar-topic-list" style="margin: 30px 0 0 0;">
          <h2 style="margin-bottom: 20px;">Choose a Grammar Topic</h2>
          <div style="display: flex; flex-wrap: nowrap; gap: 20px; overflow-x: auto;">
            ${grammarTopics.map(topic => `<button class="grammar-topic-btn" data-topic="${topic.key}" style="padding: 18px 32px; font-size: 18px; border-radius: 8px; border: 1px solid #5782BB; background: #f8f9fa; color: #5782BB; cursor: pointer; transition: background 0.2s;">${topic.label}</button>`).join('')}
          </div>
        </div>
      `;
      document.getElementById('back-from-grammar').onclick = function(e) {
        e.preventDefault();
        grammarContainer.style.display = 'none';
        document.querySelector('.study-options').style.display = 'flex';
      };
      Array.from(document.querySelectorAll('.grammar-topic-btn')).forEach(btn => {
        btn.onclick = function() {
          selectedGrammarTopic = btn.getAttribute('data-topic');
          showGrammarLesson();
        };
      });
    }

    // Update showGrammarLesson to use selectedGrammarTopic
    function showGrammarLesson() {
      if (!selectedGrammarTopic) {
        showGrammarTopicSelection();
        return;
      }
      // Filter questions by selected topic
      const topicQuestions = sentenceQuizBank.filter(q => q.grammar === selectedGrammarTopic);
      if (topicQuestions.length === 0) {
        grammarContainer.innerHTML = `<div class="study-header"><a href="#" class="back-btn" id="back-from-grammar">‚Üê Back to Topics</a></div><div style="margin: 40px 0;">No questions for this topic yet.</div>`;
        document.getElementById('back-from-grammar').onclick = function(e) {
          e.preventDefault();
          showGrammarTopicSelection();
        };
        return;
      }
      // Pick a random question from the topic
      currentQuizIndex = Math.floor(Math.random() * topicQuestions.length);
      const quiz = topicQuestions[currentQuizIndex];
      grammarContainer.innerHTML = `
        <div class="study-header">
          <a href="#" class="back-btn" id="back-from-grammar">‚Üê Back to Topics</a>
          <div id="grammar-progress"></div>
        </div>
        <div class="grammar-lesson">
          <div class="grammar-explanation">
            <h3 id="grammar-title">${quiz.grammar}</h3>
            <div class="grammar-content" id="grammar-content">${grammarExplanations[quiz.grammar] || ''}</div>
          </div>
          <div class="sentence-practice">
            <h3>Practice Making Sentences</h3>
            <div class="sentence-builder">
              <div class="sentence-prompt" id="sentence-prompt">${quiz.prompt}</div>
              <div class="word-bank" id="word-bank"></div>
              <div class="sentence-construction" id="sentence-construction"></div>
              <div class="sentence-controls">
                <button class="grammar-btn" id="check-sentence-btn">Check Sentence</button>
                <button class="grammar-btn" id="clear-sentence-btn">Clear</button>
                <button class="grammar-btn" id="next-sentence-btn">Next Practice</button>
              </div>
              <div class="sentence-feedback" id="sentence-feedback"></div>
            </div>
          </div>
        </div>
      `;
      // Set up word bank and answer area
      const shuffled = quiz.words.slice().sort(() => Math.random() - 0.5);
      const wordBank = document.getElementById('word-bank');
      shuffled.forEach((word, idx) => {
        const wordElement = document.createElement('div');
        wordElement.className = 'word-item';
        wordElement.textContent = word;
        wordElement.onclick = function() {
          addWordToSentence(word, idx);
          wordElement.style.visibility = 'hidden';
        };
        wordBank.appendChild(wordElement);
      });
      document.getElementById('sentence-construction').innerHTML = '';
      document.getElementById('sentence-feedback').style.display = 'none';
      // Button handlers
      document.getElementById('check-sentence-btn').onclick = function() {
        const construction = document.getElementById('sentence-construction');
        const userSentence = Array.from(construction.children)
          .map(word => word.textContent)
          .join(' ');
        const correctSentence = quiz.correct;
        const feedback = document.getElementById('sentence-feedback');
        if (userSentence === correctSentence) {
          feedback.className = 'sentence-feedback correct';
          feedback.textContent = 'Correct! Well done!';
        } else {
          feedback.className = 'sentence-feedback incorrect';
          feedback.textContent = `Incorrect. The correct sentence is: ${correctSentence}`;
        }
        feedback.style.display = 'block';
        // Show per-word explanation and translation
        let explainDiv = document.getElementById('sentence-explanation');
        if (!explainDiv) {
          explainDiv = document.createElement('div');
          explainDiv.id = 'sentence-explanation';
          feedback.parentNode.insertBefore(explainDiv, feedback.nextSibling);
        }
        explainDiv.innerHTML = `<div style='margin-top:10px;'><b>Translation:</b> ${quiz.translation || ''}</div>`;
        if (quiz.wordExplanations) {
          explainDiv.innerHTML += `<div style='margin-top:5px;'><b>Word breakdown:</b><ul style='margin:5px 0 0 20px;'>${quiz.wordExplanations.map(w => `<li>${w}</li>`).join('')}</ul></div>`;
        }
      };
      document.getElementById('clear-sentence-btn').onclick = function() {
        document.getElementById('sentence-construction').innerHTML = '';
        Array.from(document.getElementById('word-bank').children).forEach(el => el.style.visibility = 'visible');
        document.getElementById('sentence-feedback').style.display = 'none';
        let explainDiv = document.getElementById('sentence-explanation');
        if (explainDiv) explainDiv.innerHTML = '';
      };
      document.getElementById('next-sentence-btn').onclick = function() {
        showGrammarLesson();
      };
      document.getElementById('back-from-grammar').onclick = function(e) {
        e.preventDefault();
        showGrammarTopicSelection();
      };
    }

    // Update showSection to show topic selection first
    function showSection(section) {
      // Hide all study containers
      document.querySelector('.flashcard-container').style.display = 'none';
      document.querySelector('.quiz-container').style.display = 'none';
      document.querySelector('.writing-container').style.display = 'none';
      document.querySelector('.numbers-container').style.display = 'none';
      document.querySelector('.grammar-container').style.display = 'none';
      document.querySelector('.study-options').style.display = 'none';

      // Show the selected section
      if (section === 'flashcard') {
        document.querySelector('.flashcard-container').style.display = 'block';
      } else if (section === 'quiz') {
        document.querySelector('.quiz-container').style.display = 'block';
      } else if (section === 'writing') {
        document.querySelector('.writing-container').style.display = 'block';
      } else if (section === 'numbers') {
        document.querySelector('.numbers-container').style.display = 'block';
      } else if (section === 'grammar') {
        document.querySelector('.grammar-container').style.display = 'block';
        showGrammarTopicSelection();
      }
    }
  </script>
</body>
</html> 
