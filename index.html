<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blebleble</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #5782BB;
      --secondary-color: #e8f0fe;
      --text-color: #333;
      --light-gray: #f8f9fa;
      --border-color: #dee2e6;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Noto Sans KR', Arial, sans-serif;
      color: var(--text-color);
      line-height: 1.5;
      background-color: #f5f7fa;
    }
    
    .app-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Sidebar Styles */
    .sidebar {
      width: 200px;
      background-color: var(--primary-color);
      color: white;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    .app-logo {
      padding: 0 20px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: bold;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 20px;
    }
    
    .nav-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .nav-item:hover, .nav-item.active {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .dropdown {
      margin-top: 5px;
      margin-left: 20px;
      display: none;
    }
    
    .dropdown.active {
      display: block;
    }
    
    .dropdown-item {
      padding: 8px 20px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .dropdown-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    /* Main Content Styles */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .content-section {
      display: none;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .content-section.active {
      display: block;
    }
    
    /* Header Styles */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .section-header h2 {
      color: var(--primary-color);
      font-size: 22px;
    }
    
    /* Dictionary Styles */
    .search-bar {
      margin-bottom: 20px;
      width: 100%;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .filter {
      background-color: var(--secondary-color);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-color);
    }
    
    .filter.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .dictionary-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .word-card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
      transition: transform 0.2s ease;
      border: 1px solid var(--border-color);
    }
    
    .word-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .korean {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .pronunciation {
      color: #666;
      font-style: italic;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .translation {
      font-size: 16px;
      margin-bottom: 15px;
      color: #444;
    }
    
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .tag {
      background-color: var(--secondary-color);
      color: var(--primary-color);
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    
    .controls {
      display: flex;
      justify-content: space-between;
    }
    
    .listen-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .listen-btn:hover {
      background-color: #4a6d9d;
    }
    
    .audio-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      background-color: #4CAF50;
    }
    
    .audio-indicator.playing {
      background-color: #2196F3;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
    
    .stats {
      margin-bottom: 15px;
      color: #666;
      font-size: 14px;
    }
    
    .example {
      background-color: var(--light-gray);
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .example-korean {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .example-translation {
      color: #666;
      font-style: italic;
    }
    
    /* Study Section Styles */
    .study-options {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .study-card {
      flex: 1;
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      border: 1px solid var(--border-color);
    }
    
    .study-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .study-card h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    .flashcard-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }
    
    .flashcard {
      width: 100%;
      max-width: 500px;
      height: 300px;
      perspective: 1000px;
      margin-bottom: 20px;
    }
    
    .flashcard-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.6s;
      transform-style: preserve-3d;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    
    .flashcard.flipped .flashcard-inner {
      transform: rotateY(180deg);
    }
    
    .flashcard-front, .flashcard-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 20px;
      border-radius: 10px;
    }
    
    .flashcard-front {
      background-color: white;
      border: 1px solid var(--border-color);
    }
    
    .flashcard-back {
      background-color: var(--secondary-color);
      transform: rotateY(180deg);
      border: 1px solid var(--border-color);
    }
    
    .flashcard-word {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    
    .flashcard-hint {
      font-size: 16px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .flashcard-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px;
      font-size: 16px;
    }
    
    .flashcard-btn:hover {
      background-color: #4a6d9d;
    }
    
    .flashcard-controls {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    /* Settings Section Styles */
    .settings-container {
      max-width: 600px;
    }
    
    .settings-group {
      margin-bottom: 20px;
    }
    
    .settings-group h3 {
      margin-bottom: 10px;
      color: var(--primary-color);
    }
    
    .settings-option {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .settings-option label {
      margin-left: 10px;
    }
    
    .level-select {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      margin-top: 5px;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        padding: 10px;
      }
      
      .app-logo {
        padding: 10px;
        margin-bottom: 10px;
      }
      
      .dictionary-container {
        grid-template-columns: 1fr;
      }
      
      .study-options {
        flex-direction: column;
      }
    }
    
    /* Add new styles for study progress tracking */
    
    /* Add styles after the existing flashcard styles */
    
    .study-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      width: 100%;
      max-width: 500px;
    }
    
    .back-btn {
      background-color: transparent;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      font-size: 14px;
      padding: 5px 0;
    }
    
    #progress-counter {
      font-size: 14px;
      color: #666;
    }
    
    .card-counter {
      margin-bottom: 10px;
      color: #666;
      font-size: 14px;
      text-align: center;
      width: 100%;
      max-width: 500px;
    }
    
    .flashcard-progress {
      margin-top: 15px;
      padding: 8px 15px;
      background-color: #e8f5e9;
      border-radius: 5px;
      font-size: 14px;
      color: #388e3c;
    }
    
    .flashcard-progress.new {
      background-color: #e3f2fd;
      color: #1565c0;
    }
    
    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    /* Count bug fix */
    .stats {
      margin-bottom: 15px;
      color: #666;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }
    
    .dictionary-info {
      color: #5782BB;
      font-weight: bold;
    }
    
    /* Quiz Styles */
    .quiz-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    
    .quiz-card {
      width: 100%;
      max-width: 600px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    
    .question-container {
      margin-bottom: 20px;
      text-align: center;
    }
    
    .question-text {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .question-audio {
      margin: 10px 0;
    }
    
    .audio-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
    }
    
    .answers-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .answer-option {
      padding: 15px;
      background-color: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
    }
    
    .answer-option:hover {
      background-color: #e9e9e9;
    }
    
    .answer-option.selected {
      background-color: #d4e6f9;
      border-color: var(--primary-color);
    }
    
    .answer-option.correct {
      background-color: #d4edda;
      border-color: #28a745;
    }
    
    .answer-option.incorrect {
      background-color: #f8d7da;
      border-color: #dc3545;
    }
    
    .quiz-controls {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .quiz-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .quiz-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    
    .quiz-score {
      font-size: 16px;
      margin-bottom: 10px;
      font-weight: bold;
      align-self: flex-end;
      margin-right: 20px;
    }
    
    .quiz-feedback {
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    
    .quiz-feedback.correct {
      background-color: #d4edda;
      color: #155724;
      display: block;
    }
    
    .quiz-feedback.incorrect {
      background-color: #f8d7da;
      color: #721c24;
      display: block;
    }
    
    .quiz-results {
      width: 100%;
      max-width: 500px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 30px;
      text-align: center;
      border: 1px solid var(--border-color);
    }
    
    .quiz-results h3 {
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    
    .final-score {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    
    .quiz-stats {
      margin-bottom: 30px;
    }
    
    /* Writing Practice Styles */
    .writing-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    
    .writing-card {
      width: 100%;
      max-width: 500px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    
    .writing-prompt {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .writing-character {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .writing-pronunciation {
      font-size: 16px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .writing-area {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    #writing-canvas {
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fff;
      margin-bottom: 10px;
    }
    
    .writing-tools {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .writing-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .writing-controls {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .writing-feedback {
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    
    .progress-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .stats-card, .word-of-day-card, .recent-activity, .export-import {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .progress-stats {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    .activity-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .activity-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }

    .action-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      width: 100%;
    }

    .action-btn:hover {
      background: #4a6d9d;
    }

    .progress-bar-container {
      width: 100%;
      height: 20px;
      background-color: #f0f0f0;
      border-radius: 10px;
      margin-top: 15px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background-color: var(--primary-color);
      width: 0%;
      transition: width 0.3s ease;
    }

    .word-of-day-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .word-of-day-card .korean {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .word-of-day-card .pronunciation {
      font-size: 18px;
      color: #666;
      margin-bottom: 10px;
    }

    .word-of-day-card .translation {
      font-size: 20px;
      margin-bottom: 15px;
    }

    /* Grammar Section Styles */
    .grammar-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .grammar-lesson {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .grammar-explanation {
      margin-bottom: 30px;
    }

    .grammar-content {
      background-color: var(--light-gray);
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .sentence-practice {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .sentence-builder {
      margin-top: 20px;
    }

    .sentence-prompt {
      font-size: 18px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: var(--secondary-color);
      border-radius: 8px;
    }

    .word-bank {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: var(--light-gray);
      border-radius: 8px;
    }

    .word-item {
      background-color: white;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      border: 1px solid var(--border-color);
      transition: all 0.2s;
    }

    .word-item:hover {
      background-color: var(--primary-color);
      color: white;
    }

    .sentence-construction {
      min-height: 60px;
      padding: 15px;
      background-color: var(--light-gray);
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .sentence-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .grammar-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .grammar-btn:hover {
      background-color: #4a6d9d;
    }

    .sentence-feedback {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }

    .sentence-feedback.correct {
      background-color: #e8f5e9;
      color: #2e7d32;
      display: block;
    }

    .sentence-feedback.incorrect {
      background-color: #ffebee;
      color: #c62828;
      display: block;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="app-logo">
        <span>Blebleble</span>
      </div>
      
      <div class="nav-item active" data-section="dictionary">Dictionary</div>
      <div class="nav-item" data-section="study">Study</div>
      <div class="nav-item" data-section="settings">Settings</div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <!-- Dictionary Section -->
      <div id="dictionary-section" class="content-section active">
        <div class="section-header">
          <h2>Korean Dictionary</h2>
        </div>
        
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search for Korean words, English meanings, or pronunciation...">
        </div>
        
        <div class="filters-wrapper" style="position: relative; margin-bottom: 15px;">
          <div class="filters" id="main-filters" style="display: flex; overflow-x: auto; white-space: nowrap; padding-bottom: 10px; scrollbar-width: thin;">
            <div class="filter active" data-category="All">All</div>
            <div class="filter" data-category="Common">Common</div>
            <div class="filter" data-category="Greetings">Greetings</div>
            <div class="filter" data-category="Food">Food</div>
            <div class="filter" data-category="Places">Places</div>
            <div class="filter" data-category="Family">Family</div>
            <div class="filter" data-category="Time">Time</div>
            <div class="filter" data-category="Verbs">Verbs</div>
            <div class="filter" data-category="Adjectives">Adjectives</div>
            <div class="filter" data-category="Numbers">Numbers</div>
            <div class="filter" data-category="Transportation">Transportation</div>
            <div class="filter" data-category="Emotions">Emotions</div>
            <div class="filter" data-category="Weather">Weather</div>
            <div class="filter" data-category="Education">Education</div>
            <div class="filter" data-category="Technology">Technology</div>
            <div class="filter" data-category="Shopping">Shopping</div>
            <div class="filter" data-category="Travel">Travel</div>
            <div class="filter" data-category="Health">Health</div>
            <div class="filter" data-category="MZ">Modern Slang</div>
            <div class="filter" data-category="Responses">Responses</div>
          </div>
          <div class="scroll-indicators" style="position: absolute; top: 0; right: 0; bottom: 10px; pointer-events: none; display: flex; align-items: center;">
            <div class="scroll-right-indicator" style="background: linear-gradient(to right, transparent, white); width: 30px; height: 100%;"></div>
          </div>
        </div>
        
        <div class="stats">
          <span><span id="word-count">0</span> words found</span>
          <span class="dictionary-info">Total: <span id="total-words"></span> words in dictionary</span>
        </div>
        
        <div class="dictionary-container" id="dictionary-container">
          <!-- Words will be added here dynamically -->
        </div>
      </div>
      
      <!-- Study Section -->
      <div id="study-section" class="content-section">
        <div class="section-header">
          <h2>Study Korean</h2>
        </div>
        
        <div class="study-options">
          <div class="study-card" id="flashcards-option">
            <h3>Flashcards</h3>
            <p>Practice vocabulary with interactive flashcards</p>
          </div>
          
          <div class="study-card" id="quiz-option">
            <h3>Quiz</h3>
            <p>Test your knowledge with multiple choice questions</p>
          </div>
          
          <div class="study-card" id="new-words-quiz-option">
            <h3>New Words Quiz</h3>
            <p>Test your memory of recently learned words</p>
          </div>
          
          <div class="study-card" id="writing-option">
            <h3>Writing Practice</h3>
            <p>Practice writing Korean characters</p>
          </div>
          
          <div class="study-card" id="numbers-option">
            <h3>Numbers</h3>
            <p>Learn and practice Korean number systems</p>
          </div>
        </div>

        <!-- Add New Words Quiz Container -->
        <div class="new-words-quiz-container" style="display: none;">
          <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
            <div class="study-header">
              <button class="back-btn" id="back-from-new-words-quiz">← Back to Study Options</button>
            </div>
            
            <div class="quiz-card" style="margin: 20px 0; text-align: center;">
              <div class="question-container">
                <div class="question-text" id="new-words-question-text" style="font-size: 32px; font-weight: bold; margin-bottom: 15px;"></div>
                <div class="question-hint" id="new-words-question-hint" style="color: #666; font-style: italic; margin: 10px 0; font-size: 16px;"></div>
                <div class="question-audio" style="margin: 15px 0;">
                  <button id="new-words-audio-btn" class="audio-btn" style="width: 50px; height: 50px; font-size: 24px;">🔊</button>
                </div>
              </div>
              
              <div class="answers-container" id="new-words-answers-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px auto; max-width: 600px; padding: 0 20px;">
                <!-- Answer options will be added here dynamically -->
              </div>
            </div>
            
            <div class="quiz-controls" style="text-align: center; margin-top: 20px;">
              <button class="quiz-btn" id="check-new-words-answer-btn">Check Answer</button>
              <button class="quiz-btn" id="next-new-words-btn" style="margin-left: 10px;">Next Word</button>
            </div>
            
            <div class="quiz-feedback" id="new-words-quiz-feedback" style="max-width: 600px; margin: 20px auto;"></div>
          </div>
        </div>

        <div class="flashcard-container" style="display: none;">
          <div class="study-header">
            <button class="back-btn" id="back-to-study">← Back to Study Options</button>
            <div id="progress-counter">0/0 words studied</div>
          </div>
          
          <div class="card-counter" id="card-counter">Card 1 of 0</div>
          
          <div class="flashcard">
            <div class="flashcard-inner">
              <div class="flashcard-front">
                <div class="flashcard-word" id="flashcard-front-word"></div>
                <div class="flashcard-hint" id="flashcard-front-hint">Click to reveal answer</div>
              </div>
              <div class="flashcard-back">
                <div class="flashcard-word" id="flashcard-back-word"></div>
                <div class="flashcard-hint" id="flashcard-back-hint"></div>
                <div class="flashcard-progress" id="flashcard-progress-status">New Word</div>
              </div>
            </div>
          </div>
          
          <div class="flashcard-controls">
            <button class="flashcard-btn" id="prev-btn">Previous</button>
            <button class="flashcard-btn" id="flip-btn">Flip Card</button>
            <button class="flashcard-btn" id="play-audio-btn">🔊 Play Audio</button>
            <button class="flashcard-btn" id="next-btn">Next</button>
          </div>
        </div>
        
        <div class="quiz-container" style="display: none;">
          <div class="study-header">
            <button class="back-btn" id="back-from-quiz">← Back to Study Options</button>
            <div id="quiz-progress">Question 1 of 10</div>
          </div>
          
          <div class="quiz-score">Score: <span id="quiz-score">0</span>/10</div>
          
          <div class="quiz-card">
            <div class="question-container">
              <div class="question-text" id="question-text"></div>
              <div class="question-image" id="question-image"></div>
              <div class="question-audio">
                <button id="question-audio-btn" class="audio-btn">🔊</button>
              </div>
            </div>
            
            <div class="answers-container" id="answers-container">
              <!-- Answer options will be added here dynamically -->
            </div>
          </div>
          
          <div class="quiz-controls">
            <button class="quiz-btn" id="check-answer-btn">Check Answer</button>
            <button class="quiz-btn" id="next-question-btn" disabled>Next Question</button>
          </div>
          
          <div class="quiz-feedback" id="quiz-feedback"></div>
          
          <div class="quiz-results" style="display: none;" id="quiz-results">
            <h3>Quiz Complete!</h3>
            <div class="final-score">Your score: <span id="final-score">0</span>/10</div>
            <div class="quiz-stats">
              <div>Correct answers: <span id="correct-answers">0</span></div>
              <div>Time taken: <span id="time-taken">0:00</span></div>
            </div>
            <button class="quiz-btn" id="restart-quiz-btn">Take Another Quiz</button>
          </div>
        </div>

        <div class="writing-container" style="display: none;">
          <div class="study-header">
            <button class="back-btn" id="back-from-writing">← Back to Study Options</button>
            <div id="writing-progress">Character 1 of 10</div>
          </div>
          
          <div class="writing-card">
            <div class="writing-prompt">
              <div class="writing-character" id="writing-character"></div>
              <div class="writing-pronunciation" id="writing-pronunciation"></div>
              <button id="writing-audio-btn" class="audio-btn">🔊</button>
            </div>
            
            <div class="writing-area">
              <canvas id="writing-canvas" width="400" height="400"></canvas>
              <div class="writing-tools">
                <button id="clear-canvas-btn" class="writing-btn">Clear</button>
                <button id="check-writing-btn" class="writing-btn">Check</button>
              </div>
            </div>
          </div>
          
          <div class="writing-controls">
            <button class="writing-btn" id="prev-char-btn">Previous</button>
            <button class="writing-btn" id="next-char-btn">Next</button>
          </div>
          
          <div class="writing-feedback" id="writing-feedback"></div>
        </div>
        
        <div class="numbers-container" style="display: none;">
          <div class="study-header">
            <button class="back-btn" id="back-from-numbers">← Back to Study Options</button>
          </div>
          
          <!-- Rest of the numbers content (from the numbers section) -->
          <div class="numbers-explanation" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p>Korean has two number systems:</p>
            <ol>
              <li><strong>Native Korean numbers</strong> (하나, 둘, 셋...) - Used for counting items, age, time, etc.</li>
              <li><strong>Sino-Korean numbers</strong> (일, 이, 삼...) - Used for dates, money, phone numbers, etc.</li>
            </ol>
          </div>
          
          <div class="numbers-tables" style="display: flex; gap: 20px; flex-wrap: wrap;">
            <!-- Native Korean Numbers -->
            <div class="number-table" style="flex: 1; min-width: 280px;">
              <h3>Native Korean Numbers</h3>
              <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                  <tr style="background-color: #5782BB; color: white;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Korean</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Pronunciation</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Number</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">Listen</th>
                  </tr>
                </thead>
                <tbody id="native-numbers-body">
                  <!-- Will be filled dynamically -->
                </tbody>
              </table>
            </div>
            
            <!-- Sino-Korean Numbers -->
            <div class="number-table" style="flex: 1; min-width: 280px;">
              <h3>Sino-Korean Numbers</h3>
              <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                  <tr style="background-color: #5782BB; color: white;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Korean</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Pronunciation</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Number</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">Listen</th>
                  </tr>
                </thead>
                <tbody id="sino-numbers-body">
                  <!-- Will be filled dynamically -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="numbers-counters" style="margin-top: 30px;">
            <h3>Common Counters</h3>
            <p>Korean uses counters (also called measure words) after numbers when counting objects.</p>
            
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
              <thead>
                <tr style="background-color: #5782BB; color: white;">
                  <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Counter</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Pronunciation</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Usage</th>
                  <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Example</th>
                  <th style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">Listen</th>
                </tr>
              </thead>
              <tbody id="counters-body">
                <!-- Will be filled dynamically -->
              </tbody>
            </table>
          </div>
          
          <div class="numbers-practice" style="margin-top: 30px;">
            <h3>Practice with Numbers</h3>
            <div class="numbers-practice-container" style="display: flex; gap: 20px; flex-wrap: wrap;">
              <div class="practice-card" style="flex: 1; min-width: 250px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #dee2e6;">
                <h4>Number to Korean</h4>
                <div id="number-practice-display" style="font-size: 48px; text-align: center; margin: 20px 0;">42</div>
                <div id="number-practice-answer" style="font-size: 24px; text-align: center; margin-bottom: 20px; color: #666; height: 30px;"></div>
                <button id="show-number-answer" style="background-color: #5782BB; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%;">Show Answer</button>
                <button id="next-number-practice" style="background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px;">Next Number</button>
              </div>
              
              <div class="practice-card" style="flex: 1; min-width: 250px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #dee2e6;">
                <h4>Korean to Number</h4>
                <div id="korean-practice-display" style="font-size: 36px; text-align: center; margin: 20px 0;">마흔둘</div>
                <div id="korean-practice-answer" style="font-size: 24px; text-align: center; margin-bottom: 20px; color: #666; height: 30px;"></div>
                <button id="show-korean-answer" style="background-color: #5782BB; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%;">Show Answer</button>
                <button id="next-korean-practice" style="background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px;">Next Word</button>
              </div>
            </div>
          </div>
        </div>

        <div class="grammar-container" style="display: none;">
          <div class="study-header">
            <a href="#" class="back-btn" id="back-from-grammar">← Back to Study Options</a>
            <div id="grammar-progress">Lesson 1 of 10</div>
          </div>
          <div class="grammar-lesson">
            <div class="grammar-explanation">
              <h3 id="grammar-title">Basic Sentence Structure</h3>
              <div class="grammar-content" id="grammar-content">
                <!-- Grammar content will be loaded dynamically -->
              </div>
            </div>
            <div class="sentence-practice">
              <h3>Practice Making Sentences</h3>
              <div class="sentence-builder">
                <div class="sentence-prompt" id="sentence-prompt">
                  <!-- Sentence prompt will be shown here -->
                </div>
                <div class="word-bank" id="word-bank">
                  <!-- Available words will be shown here -->
                </div>
                <div class="sentence-construction" id="sentence-construction">
                  <!-- User's sentence will be built here -->
                </div>
                <div class="sentence-controls">
                  <button class="grammar-btn" id="check-sentence-btn">Check Sentence</button>
                  <button class="grammar-btn" id="clear-sentence-btn">Clear</button>
                  <button class="grammar-btn" id="next-sentence-btn">Next Practice</button>
                </div>
                <div class="sentence-feedback" id="sentence-feedback"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Settings Section -->
      <div id="settings-section" class="content-section">
        <div class="section-header">
          <h2>Settings</h2>
        </div>
        
        <div class="settings-container">
          <div class="settings-group">
            <h3>Proficiency Level</h3>
            <select class="level-select" id="proficiency-level">
              <option value="beginner">Beginner</option>
              <option value="intermediate">Intermediate</option>
              <option value="advanced">Advanced</option>
            </select>
          </div>
          
          <div class="settings-group">
            <h3>Audio Settings</h3>
            <div class="settings-option">
              <input type="checkbox" id="auto-play" checked>
              <label for="auto-play">Auto-play pronunciation when viewing words</label>
            </div>
          </div>
          
          <div class="settings-group">
            <h3>Display Settings</h3>
            <div class="settings-option">
              <input type="checkbox" id="show-translations" checked>
              <label for="show-translations">Show translations for example sentences</label>
            </div>
            <div class="settings-option">
              <input type="checkbox" id="show-romanization" checked>
              <label for="show-romanization">Show romanization</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Include the Korean words dictionary -->
  <script src="korean-words.js"></script>
  <script>
    // Initialize all app functionality
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM Content Loaded - Starting initialization');
      
      // Initialize speech synthesis first
      if ('speechSynthesis' in window) {
        console.log('Speech synthesis available, loading voices...');
        // Load voices
        function loadVoices() {
          return new Promise((resolve) => {
            let voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
              console.log('Voices loaded immediately');
              resolve(voices);
            } else {
              console.log('Waiting for voices to load...');
              window.speechSynthesis.onvoiceschanged = () => {
                voices = window.speechSynthesis.getVoices();
                console.log('Voices loaded via event');
                resolve(voices);
              };
            }
          });
        }
        
        loadVoices().then(voices => {
          console.log('Available voices:', voices.length);
          const koreanVoice = voices.find(voice => voice.lang.includes('ko'));
          if (koreanVoice) {
            console.log('Found Korean voice:', koreanVoice.name);
          } else {
            console.log('No Korean voice found, will use fallback');
          }
        });
      } else {
        console.log('Speech synthesis not available, will use fallback');
      }
      
      // Initialize the dictionary
      if (typeof koreanDictionary !== 'undefined') {
        window.koreanDictionary = koreanDictionary;
        console.log('Dictionary loaded successfully with', window.koreanDictionary.length, 'words');
        
        // Initialize UI elements
        const totalWordsElement = document.getElementById('total-words');
        if (totalWordsElement) {
          totalWordsElement.textContent = window.koreanDictionary.length;
        }

        // Initialize dictionary display
      filterDictionary();
      
        // Initialize study mode UI
        console.log('Initializing study mode UI...');
        
        // Initialize study mode UI
        const flipBtn = document.getElementById('flip-btn');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const playAudioBtn = document.getElementById('play-audio-btn');
        const flashcard = document.querySelector('.flashcard');
        
        if (flipBtn) flipBtn.addEventListener('click', flipCard);
        if (nextBtn) nextBtn.addEventListener('click', nextCard);
        if (prevBtn) prevBtn.addEventListener('click', prevCard);
        if (playAudioBtn) playAudioBtn.addEventListener('click', () => {
          const currentWord = studyWords[currentCardIndex];
          playCardAudio(currentWord.korean);
        });
        if (flashcard) flashcard.addEventListener('click', flipCard);
        
        // Set up quiz
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        if (checkAnswerBtn) checkAnswerBtn.addEventListener('click', checkAnswer);
        if (nextQuestionBtn) nextQuestionBtn.addEventListener('click', nextQuestion);
        
        // Set up writing practice
        const checkWritingBtn = document.getElementById('check-writing-btn');
        const nextWritingBtn = document.getElementById('next-writing-btn');
        if (checkWritingBtn && typeof checkWritingAnswer !== 'undefined') {
          checkWritingBtn.addEventListener('click', checkWritingAnswer);
        }
        if (nextWritingBtn && typeof nextWritingQuestion !== 'undefined') {
          nextWritingBtn.addEventListener('click', nextWritingQuestion);
        }
        
        // Set up numbers practice
        const checkNumberBtn = document.getElementById('check-number-btn');
        const nextNumberBtn = document.getElementById('next-number-btn');
        if (checkNumberBtn) checkNumberBtn.addEventListener('click', checkNumberAnswer);
        if (nextNumberBtn) nextNumberBtn.addEventListener('click', nextNumberQuestion);
        
        // Set up new words quiz
        const newWordsQuizOption = document.getElementById('new-words-quiz-option');
        if (newWordsQuizOption) {
          newWordsQuizOption.addEventListener('click', () => {
            document.querySelector('.study-options').style.display = 'none';
            document.querySelector('.new-words-quiz-container').style.display = 'block';
            document.querySelector('.flashcard-container').style.display = 'none';
            document.querySelector('.quiz-container').style.display = 'none';
            document.querySelector('.writing-container').style.display = 'none';
            document.querySelector('.numbers-container').style.display = 'none';
            startNewWordsQuiz();
          });
        }
        
        // Set up navigation
        document.querySelectorAll('.nav-link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = link.getAttribute('href').substring(1);
            showSection(targetId);
          });
        });
        
        // Set up keyboard shortcuts
        document.addEventListener('keydown', handleKeyboardShortcuts);
        
        // Initialize the first section
        showSection('dictionary');
        
        // Set up search functionality
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            filterDictionary();
          });
        }
        
        // Set up filter functionality
        const filterSelect = document.getElementById('filter-select');
        if (filterSelect) {
          filterSelect.addEventListener('change', (e) => {
            currentFilter = e.target.value;
            filterDictionary();
          });
        }
        
        // Set up sort functionality
        const sortSelect = document.getElementById('sort-select');
        if (sortSelect) {
          sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            filterDictionary();
          });
        }
        
        // Set up settings
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        if (saveSettingsBtn) {
          saveSettingsBtn.addEventListener('click', saveSettings);
        }
        
        // Load and apply saved settings
        loadSettings();
        
        // Initialize progress last (after all UI elements are ready)
        setTimeout(() => {
          try {
            initializeProgress();
            console.log('Progress initialized successfully');
          } catch (error) {
            console.error('Error initializing progress:', error);
          }
        }, 100);
        
        console.log('All initialization completed successfully');
      } else {
        console.error('Dictionary failed to load');
      }
    });
  </script>
  
  <script>
    
    // Navigation
    const navItems = document.querySelectorAll('.nav-item');
    const contentSections = document.querySelectorAll('.content-section');
    
    navItems.forEach(item => {
      item.addEventListener('click', () => {
        // Update active nav item
        navItems.forEach(navItem => navItem.classList.remove('active'));
        item.classList.add('active');
        
        // Show corresponding section
        const sectionId = item.getAttribute('data-section');
        contentSections.forEach(section => {
          section.classList.remove('active');
          if (section.id === `${sectionId}-section`) {
            section.classList.add('active');
          }
        });
      });
    });
    
    // Dictionary Functionality
    // Audio system setup and management
    let audioQueue = [];
    let isPlaying = false;
    let audioPool = [];
    const MAX_POOL_SIZE = 5;

    // Handle keyboard shortcuts
    function handleKeyboardShortcuts(event) {
      // Space to play current word
      if (event.code === 'Space' && !event.ctrlKey && !event.altKey && !event.metaKey) {
        event.preventDefault();
        const currentWord = document.querySelector('.current-word');
        if (currentWord) {
          const audioButton = currentWord.querySelector('.audio-button');
          if (audioButton) {
            audioButton.click();
          }
        }
      }
      
      // Right arrow for next word
      if (event.code === 'ArrowRight' && !event.ctrlKey && !event.altKey && !event.metaKey) {
        event.preventDefault();
        const nextButton = document.querySelector('.next-button');
        if (nextButton) {
          nextButton.click();
        }
      }
      
      // Left arrow for previous word
      if (event.code === 'ArrowLeft' && !event.ctrlKey && !event.altKey && !event.metaKey) {
        event.preventDefault();
        const prevButton = document.querySelector('.prev-button');
        if (prevButton) {
          prevButton.click();
        }
      }
    }

    // Quiz functionality
    function startNewWordsQuiz() {
      // Get words that haven't been studied yet
      const unstudiedWords = koreanDictionary.filter(word => !studyProgress[word.korean]);
      
      if (unstudiedWords.length === 0) {
        alert('Congratulations! You have studied all words. Try reviewing them instead.');
        return;
      }

      // Randomly select 10 words or all unstudied words if less than 10
      const quizWords = [];
      const numWords = Math.min(10, unstudiedWords.length);
      const wordsCopy = [...unstudiedWords];

      for (let i = 0; i < numWords; i++) {
        const randomIndex = Math.floor(Math.random() * wordsCopy.length);
        quizWords.push(wordsCopy.splice(randomIndex, 1)[0]);
      }

      // Start quiz with these words
      startQuiz(quizWords);
    }

    // Initialize audio system
    function initAudioSystem() {
      // Pre-create audio elements pool
      while (audioPool.length < MAX_POOL_SIZE) {
        const audio = new Audio();
        audio.crossOrigin = 'anonymous';
        audioPool.push({
          element: audio,
          inUse: false
        });
      }

      // Setup audio resume on visibility change
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          resumeAudioSystem();
        }
      });

      // Setup audio resume on user interaction
      const resumeOnInteraction = () => {
        resumeAudioSystem();
        ['click', 'touchstart', 'keydown'].forEach(event => {
          document.removeEventListener(event, resumeOnInteraction);
        });
      };

      ['click', 'touchstart', 'keydown'].forEach(event => {
        document.addEventListener(event, resumeOnInteraction);
      });

      console.log('Audio system initialized with pool size:', MAX_POOL_SIZE);
    }

    // Resume audio system
    function resumeAudioSystem() {
      audioPool.forEach(({ element }) => {
        if (element.paused && element.src) {
          element.play().catch(error => {
            console.log('Auto-resume failed, waiting for user interaction');
          });
        }
      });
    }

    // Get available audio element from pool
    function getAudioElement() {
      // Try to find an unused element
      let audioEntry = audioPool.find(entry => !entry.inUse);
      
      if (!audioEntry) {
        // If all are in use, create a new one
        const audio = new Audio();
        audio.crossOrigin = 'anonymous';
        audioEntry = { element: audio, inUse: false };
        audioPool.push(audioEntry);
        console.log('Audio pool expanded to:', audioPool.length);
      }

      audioEntry.inUse = true;
      return audioEntry;
    }

    // Release audio element back to pool
    function releaseAudioElement(audioEntry) {
      audioEntry.inUse = false;
      audioEntry.element.src = '';
      audioEntry.element.onended = null;
      audioEntry.element.onerror = null;
      audioEntry.element.oncanplaythrough = null;
    }

    // Process audio queue
    async function processAudioQueue() {
      if (isPlaying || audioQueue.length === 0) return;
      
      isPlaying = true;
      const nextAudio = audioQueue.shift();
      
      try {
        await playAudioItem(nextAudio);
        // Call onComplete callback if provided
        if (nextAudio.onComplete) {
          nextAudio.onComplete();
        }
      } catch (error) {
        console.error('Error playing queued audio:', error);
        // Call onError callback if provided
        if (nextAudio.onError) {
          nextAudio.onError(error);
        }
      } finally {
        isPlaying = false;
        processAudioQueue(); // Process next item if any
      }
    }

    // Add audio to queue
    function queueAudio(audioData) {
      audioQueue.push(audioData);
      processAudioQueue();
    }

    // Play a single audio item
    async function playAudioItem(audioData) {
      const { text, button } = audioData;
      
      // Use Web Speech API as primary method
      if ('speechSynthesis' in window) {
        return new Promise((resolve, reject) => {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'ko-KR';
          utterance.rate = 0.9;
          
          // Get Korean voices if available
          const voices = speechSynthesis.getVoices();
          const koreanVoice = voices.find(voice => voice.lang.includes('ko'));
          if (koreanVoice) {
            utterance.voice = koreanVoice;
          }
          
          utterance.onend = () => {
            console.log('Speech synthesis completed');
            resolve();
          };
          
          utterance.onerror = (error) => {
            console.error('Speech synthesis failed:', error);
            reject(error);
          };
          
          // Cancel any ongoing speech and speak
          speechSynthesis.cancel();
          speechSynthesis.speak(utterance);
        });
      } else {
        console.error('Web Speech API not available');
        return Promise.reject('No TTS method available');
      }
    }

    // Main audio play function
    function playAudio(text, button) {
      console.log('Starting playAudio for text:', text);
      
      // If no button is provided, use playPlainAudio instead
      if (!button) {
        console.log('No button provided, using playPlainAudio');
        return playPlainAudio(text);
      }
      
      // Update button state
      console.log('Updating button state...');
      const indicator = button.querySelector('.audio-indicator');
      if (!indicator) {
        console.error('Could not find audio indicator in button');
        return;
      }
      
      // Reset button state function
      const resetButton = () => {
        indicator.classList.remove('playing');
        button.innerHTML = '<span class="audio-indicator"></span>Listen';
        button.disabled = false;
      };

      // Update button to playing state
      indicator.classList.add('playing');
      button.textContent = 'Playing...';
      button.disabled = true;
      
      // Queue the audio with callbacks
      queueAudio({ 
        text, 
        button,
        onComplete: () => {
          console.log('Audio playback completed');
          resetButton();
        },
        onError: () => {
          console.error('Audio playback failed');
          resetButton();
        }
      });
    }
    
    function tryWebSpeech() {
        if ('speechSynthesis' in window) {
          console.log('Trying Web Speech API...');
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'ko-KR';
          utterance.rate = 0.9;
          utterance.pitch = 1;
          utterance.volume = 1;
          
          utterance.onend = () => {
            console.log('Speech synthesis completed');
            resetButton();
          };
          
          utterance.onerror = (e) => {
            console.error('Speech synthesis failed:', e);
            resetButton();
          };
          
          window.speechSynthesis.cancel(); // Cancel any ongoing speech
          window.speechSynthesis.speak(utterance);
        } else {
          console.error('No audio playback method available');
          resetButton();
        }
    }
    
    // Separate function for playing audio without button UI updates
    // Try fallback methods for audio playback
    async function tryFallbackMethods(text, button) {
      console.log('Trying fallback methods for audio playback');
      
      // Try Web Speech API as fallback
      try {
        await tryWebSpeech(text);
      } catch (error) {
        console.error('Web Speech API failed:', error);
        console.log('All audio playback methods failed');
        // Don't throw error, just log it
      }
    }

    // Try playing audio with Web Speech API
    function tryWebSpeech(text) {
      return new Promise((resolve, reject) => {
        if (!('speechSynthesis' in window)) {
          reject(new Error('Web Speech API not available'));
          return;
        }

        // Cancel any ongoing speech
        window.speechSynthesis.cancel();

        // Create utterance with optimal settings for Korean
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.rate = 0.9; // Slightly slower for clarity
        utterance.pitch = 1;
        utterance.volume = 1;
        
        // Setup event handlers
        utterance.onend = () => {
          console.log('Speech synthesis completed');
          resolve();
        };
        
        utterance.onerror = (error) => {
          console.error('Speech synthesis failed:', error);
          reject(error);
        };

        // Attempt to find a Korean voice
        let voices = window.speechSynthesis.getVoices();
        let koreanVoice = voices.find(voice => voice.lang.includes('ko'));
        
        if (koreanVoice) {
          utterance.voice = koreanVoice;
        }

        // If voices aren't loaded yet, wait for them
        if (voices.length === 0) {
          window.speechSynthesis.onvoiceschanged = () => {
            voices = window.speechSynthesis.getVoices();
            koreanVoice = voices.find(voice => voice.lang.includes('ko'));
            if (koreanVoice) {
              utterance.voice = koreanVoice;
            }
            window.speechSynthesis.speak(utterance);
          };
        } else {
          window.speechSynthesis.speak(utterance);
        }
      });
    }

    // Play audio without button UI
    function playPlainAudio(text) {
      console.log('Starting playPlainAudio for text:', text);
      queueAudio({ 
        text,
        onComplete: () => console.log('Plain audio completed'),
        onError: (error) => console.error('Plain audio failed:', error)
        });
    }
    
    // Helper: detect if a word is a verb (ends with '다')
    function isVerb(word) {
      return word.korean && word.korean.endsWith('다');
    }
    // Helper: conjugate verb (very basic, regular verbs only)
    function conjugateVerb(base) {
      // Remove '다'
      const stem = base.slice(0, -1);
      // Present: -어요/-아요
      let present = '';
      if (stem.endsWith('하')) {
        present = stem + '여요';
      } else if (/[ㅏㅗ]$/.test(stem[stem.length - 1])) {
        present = stem + '아요';
      } else {
        present = stem + '어요';
      }
      // Past: -었어요/-았어요
      let past = '';
      if (stem.endsWith('하')) {
        past = stem + '였어요';
      } else if (/[ㅏㅗ]$/.test(stem[stem.length - 1])) {
        past = stem + '았어요';
      } else {
        past = stem + '었어요';
      }
      // Future: -(으)ㄹ 거예요
      let future = '';
      if (/[ㄹ]$/.test(stem[stem.length - 1])) {
        future = stem + ' 거예요';
      } else if (/[aeiou]$/.test(stem)) {
        future = stem + 'ㄹ 거예요';
      } else {
        future = stem + '을 거예요';
      }
      return { present, past, future };
    }
    // Helper: generate a simple example sentence
    function generateExample(word) {
      if (isVerb(word)) {
        // Use present tense for example
        const conj = conjugateVerb(word.korean);
        return `${conj.present} (I ${word.translation})`;
      } else if (word.categories && word.categories.includes('Adjectives')) {
        return `${word.korean} 사람이에요. (He/She is ${word.translation})`;
      } else {
        // Noun or other
        return `${word.korean}이/가 있어요. (There is a ${word.translation})`;
      }
    }

    function createWordCard(word) {
      const card = document.createElement('div');
      card.className = 'word-card';
      
      // Korean word
      const korean = document.createElement('div');
      korean.className = 'korean';
      korean.textContent = word.korean;
      
      // Pronunciation
      const pronunciation = document.createElement('div');
      pronunciation.className = 'pronunciation';
      pronunciation.textContent = word.pronunciation;
      
      // Translation
      const translation = document.createElement('div');
      translation.className = 'translation';
      translation.textContent = word.translation;
      
      // Categories as tags
      const tags = document.createElement('div');
      tags.className = 'tags';
      
      word.categories.forEach(category => {
        const tag = document.createElement('span');
        tag.className = 'tag';
        tag.textContent = category;
        tags.appendChild(tag);
      });
      
      // Example if available, or auto-generate
      let example = null;
      let exampleText = word.example;
      if (!exampleText || exampleText.trim() === '') {
        exampleText = generateExample(word);
      }
      if (exampleText) {
        example = document.createElement('div');
        example.className = 'example';
        // Parse Korean and translation parts
        let koreanText = exampleText;
        let translationText = '';
        if (exampleText.includes('(') && exampleText.includes(')')) {
          const parts = exampleText.split(/\(|\)/);
          koreanText = parts[0].trim();
          translationText = parts[1].trim();
        }
        const exampleKorean = document.createElement('div');
        exampleKorean.className = 'example-korean';
        exampleKorean.textContent = koreanText;
        const exampleTranslation = document.createElement('div');
        exampleTranslation.className = 'example-translation';
        exampleTranslation.textContent = translationText;
        example.appendChild(exampleKorean);
        example.appendChild(exampleTranslation);
      }
      
      // Conjugations for verbs
      let conjugationDiv = null;
      if (isVerb(word)) {
        const conj = conjugateVerb(word.korean);
        conjugationDiv = document.createElement('div');
        conjugationDiv.className = 'conjugations';
        conjugationDiv.style.margin = '10px 0';
        conjugationDiv.innerHTML = `<b>Present:</b> ${conj.present}<br><b>Past:</b> ${conj.past}<br><b>Future:</b> ${conj.future}`;
      }
      
      // Controls
      const controls = document.createElement('div');
      controls.className = 'controls';
      
      const listenBtn = document.createElement('button');
      listenBtn.className = 'listen-btn';
      listenBtn.innerHTML = '<span class="audio-indicator"></span>Listen';
      listenBtn.addEventListener('click', () => {
        playAudio(word.korean, listenBtn);
      });
      
      controls.appendChild(listenBtn);
      
      // Assemble the card
      card.appendChild(korean);
      card.appendChild(pronunciation);
      card.appendChild(translation);
      card.appendChild(tags);
      if (conjugationDiv) card.appendChild(conjugationDiv);
      if (example) card.appendChild(example);
      card.appendChild(controls);
      
      // Add to study feature - click to add to flashcards
      card.addEventListener('dblclick', () => {
        // Logic to add to study list would go here
        alert(`Added "${word.korean}" to your study list!`);
      });
      
      return card;
    }
    
    function filterDictionary() {
      const container = document.getElementById('dictionary-container');
      container.innerHTML = '';
      
      const searchTerm = document.querySelector('.search-input').value.toLowerCase();
      const activeFilter = document.querySelector('.filter.active');
      const selectedCategory = activeFilter.getAttribute('data-category');
      
      // Filter words
      const filteredWords = koreanDictionary.filter(word => {
        // Check if matches search term
        const matchesSearch = 
          !searchTerm || 
          word.korean.toLowerCase().includes(searchTerm) ||
          word.pronunciation.toLowerCase().includes(searchTerm) ||
          word.translation.toLowerCase().includes(searchTerm);
        
        // Check if matches category
        const matchesCategory = 
          selectedCategory === 'All' ||
          word.categories.includes(selectedCategory);
        
        return matchesSearch && matchesCategory;
      });
      
      // Sort by difficulty level from beginner to master
      filteredWords.sort((a, b) => {
        // Define categories in order of difficulty (beginner to master)
        const difficultyOrder = [
          "Greetings", 
          "Common", 
          "Numbers", 
          "Food", 
          "Family", 
          "Places", 
          "Time", 
          "Responses", 
          "Transportation", 
          "Weather", 
          "Shopping", 
          "Emotions", 
          "Education", 
          "Travel", 
          "Verbs", 
          "Adjectives", 
          "Health", 
          "Technology", 
          "MZ"
        ];
        
        // If we're filtering by a specific category, prioritize words where the 
        // selected category is their primary (first) category
        if (selectedCategory !== 'All') {
          const aPrimaryCategory = a.categories[0];
          const bPrimaryCategory = b.categories[0];
          
          const aHasSelectedAsPrimary = aPrimaryCategory === selectedCategory;
          const bHasSelectedAsPrimary = bPrimaryCategory === selectedCategory;
          
          if (aHasSelectedAsPrimary && !bHasSelectedAsPrimary) return -1;
          if (!aHasSelectedAsPrimary && bHasSelectedAsPrimary) return 1;
        }
        
        // Get the most basic category for each word (first match in difficultyOrder)
        let aDifficultyCategory = a.categories.find(cat => difficultyOrder.includes(cat));
        let bDifficultyCategory = b.categories.find(cat => difficultyOrder.includes(cat));
        
        // If no matching categories, default to the end
        const aDifficultyIndex = aDifficultyCategory ? difficultyOrder.indexOf(aDifficultyCategory) : 999;
        const bDifficultyIndex = bDifficultyCategory ? difficultyOrder.indexOf(bDifficultyCategory) : 999;
        
        // Sort by difficulty index
        if (aDifficultyIndex !== bDifficultyIndex) {
          return aDifficultyIndex - bDifficultyIndex;
        }
        
        // If same difficulty, sort by length of Korean word (shorter is usually simpler)
        if (a.korean.length !== b.korean.length) {
          return a.korean.length - b.korean.length;
        }
        
        // If same length, sort alphabetically
        return a.korean.localeCompare(b.korean);
      });
      
      // Display count
      document.getElementById('word-count').textContent = filteredWords.length;
      
      // Create cards
      filteredWords.forEach(word => {
        const card = createWordCard(word);
        container.appendChild(card);
      });
      
      // If no words found, show message
      if (filteredWords.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.style.textAlign = 'center';
        noResults.style.padding = '40px';
        noResults.style.color = '#666';
        noResults.textContent = 'No words matching your search or filter were found.';
        container.appendChild(noResults);
      }
    }
    
    // Study Functionality
    let currentCardIndex = 0;
    let studyWords = [];
    let studyProgress = {};
    
    // Try to load saved progress from localStorage
    function loadProgress() {
      const savedProgress = localStorage.getItem('koreanStudyProgress');
      if (savedProgress) {
        studyProgress = JSON.parse(savedProgress);
      }
    }
    
    // Save progress to localStorage
    function saveProgress() {
      localStorage.setItem('koreanStudyProgress', JSON.stringify(studyProgress));
    }
    
    function initializeFlashcards() {
      // Load progress first
      loadProgress();
      
      // Get all words from dictionary
      studyWords = [...koreanDictionary];
      
      // Sort by progress (unlearned first, then by last review date)
      studyWords.sort((a, b) => {
        const progressA = studyProgress[a.korean] || { count: 0, lastReview: 0 };
        const progressB = studyProgress[b.korean] || { count: 0, lastReview: 0 };
        
        if (progressA.count === 0 && progressB.count > 0) return -1;
        if (progressA.count > 0 && progressB.count === 0) return 1;
        
        return progressA.lastReview - progressB.lastReview;
      });
      
      currentCardIndex = 0;
      updateFlashcard();
      
      // Update progress counter
      updateProgressCounter();
    }
    
    function updateProgressCounter() {
      const totalWords = koreanDictionary.length;
      const studiedWords = Object.keys(studyProgress).length;
      document.getElementById('progress-counter').textContent = `${studiedWords}/${totalWords} words studied`;
    }
    
    function updateFlashcard() {
      if (studyWords.length === 0) return;
      
      const currentWord = studyWords[currentCardIndex];
      
      // Update front
      document.getElementById('flashcard-front-word').textContent = currentWord.korean;
      
      // Update back
      document.getElementById('flashcard-back-word').textContent = currentWord.translation;
      document.getElementById('flashcard-back-hint').textContent = currentWord.pronunciation;
      
      // Update progress info
      const progress = studyProgress[currentWord.korean] || { count: 0, lastReview: 0 };
      const progressStatus = document.getElementById('flashcard-progress-status');
      
      if (progress.count === 0) {
        progressStatus.textContent = 'New Word';
        progressStatus.className = 'flashcard-progress new';
      } else {
        const lastReviewed = new Date(progress.lastReview);
        const today = new Date();
        const daysDiff = Math.floor((today - lastReviewed) / (1000 * 60 * 60 * 24));
        
        progressStatus.textContent = `Studied ${progress.count} time${progress.count > 1 ? 's' : ''}, last ${daysDiff === 0 ? 'today' : daysDiff === 1 ? 'yesterday' : daysDiff + ' days ago'}`;
        progressStatus.className = 'flashcard-progress';
      }
      
      // Reset flip state
      document.querySelector('.flashcard').classList.remove('flipped');
      
      // Update current card counter
      document.getElementById('card-counter').textContent = `Card ${currentCardIndex + 1} of ${studyWords.length}`;
    }
    
    function markAsReviewed() {
      if (studyWords.length === 0) return;
      
      const currentWord = studyWords[currentCardIndex];
      
      // Update progress for this word
      if (!studyProgress[currentWord.korean]) {
        studyProgress[currentWord.korean] = { count: 0, lastReview: 0 };
      }
      
      studyProgress[currentWord.korean].count++;
      studyProgress[currentWord.korean].lastReview = Date.now();
      
      // Save progress
      saveProgress();
    }
    
    function nextCard() {
      if (studyWords.length === 0) return;
      
      markAsReviewed();
      
      currentCardIndex = (currentCardIndex + 1) % studyWords.length;
      updateFlashcard();
    }
    
    function prevCard() {
      if (studyWords.length === 0) return;
      
      currentCardIndex = (currentCardIndex - 1 + studyWords.length) % studyWords.length;
      updateFlashcard();
    }
    
    function flipCard() {
      const flashcard = document.querySelector('.flashcard');
      flashcard.classList.toggle('flipped');
      
      // Play audio when flipping to back (showing Korean word)
      if (!flashcard.classList.contains('flipped')) {
        const currentWord = studyWords[currentCardIndex];
        playCardAudio(currentWord.korean);
      }
    }
    
    function playCardAudio(text) {
      // Use the same audio function for consistency
      playPlainAudio(text);
    }
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize speech synthesis
      if ('speechSynthesis' in window) {
        // Load voices
        function loadVoices() {
          return new Promise((resolve) => {
            let voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
              resolve(voices);
            } else {
              window.speechSynthesis.onvoiceschanged = () => {
                voices = window.speechSynthesis.getVoices();
                resolve(voices);
              };
            }
          });
        }

        // Load voices and set up fallback
        loadVoices().then(voices => {
          const koreanVoices = voices.filter(voice => voice.lang.includes('ko-'));
          console.log('Available voices:', voices.length);
          console.log('Korean voices:', koreanVoices.map(v => v.name));
          
          // If no Korean voices, use Microsoft Azure or Amazon Polly
          if (koreanVoices.length === 0) {
            console.log('No Korean voices found, will use alternative TTS service');
            // The audio will still work, just with a non-Korean voice
          }
        });
      }

      // Display total word count
      document.getElementById('total-words').textContent = koreanDictionary.length;
      
      // Set up dictionary search and filters
      const searchInput = document.querySelector('.search-input');
      searchInput.addEventListener('input', filterDictionary);
      
      const filters = document.querySelectorAll('.filter');
      filters.forEach(filter => {
        filter.addEventListener('click', () => {
          // Update active filter
          document.querySelector('.filter.active').classList.remove('active');
          filter.classList.add('active');
          
          // Refilter the dictionary
          filterDictionary();
        });
      });
      
      // Horizontal scroll for filters with mouse wheel
      const filtersContainer = document.getElementById('main-filters');
      filtersContainer.addEventListener('wheel', (e) => {
        if (e.deltaY !== 0) {
          e.preventDefault();
          filtersContainer.scrollLeft += e.deltaY;
        }
      });
      
      // Initial dictionary display - filter immediately to load words
      filterDictionary();
      
      // Display word count in dictionary section
      document.getElementById('word-count').textContent = koreanDictionary.length;
      
      // Add keyboard shortcut for search
      document.addEventListener('keydown', function(e) {
        // Ctrl+F or Cmd+F opens and focuses the search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          // If we're in the dictionary section
          if (document.getElementById('dictionary-section').classList.contains('active')) {
            e.preventDefault(); // Prevent the browser's find functionality
            searchInput.focus();
          }
        }
      });
      
      // Initialize numbers section
      initializeNumbersSection();
      
      // Set up flashcards
      document.getElementById('flashcards-option').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'none';
        document.querySelector('.flashcard-container').style.display = 'flex';
        document.querySelector('.quiz-container').style.display = 'none';
        document.querySelector('.writing-container').style.display = 'none';
        document.querySelector('.numbers-container').style.display = 'none';
        initializeFlashcards();
      });
      
      // Set up back button for flashcards
      document.getElementById('back-to-study').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'flex';
        document.querySelector('.flashcard-container').style.display = 'none';
      });
      
      document.getElementById('flip-btn').addEventListener('click', flipCard);
      document.getElementById('next-btn').addEventListener('click', nextCard);
      document.getElementById('prev-btn').addEventListener('click', prevCard);
      document.getElementById('play-audio-btn').addEventListener('click', () => {
        const currentWord = studyWords[currentCardIndex];
        playCardAudio(currentWord.korean);
      });
      
      document.querySelector('.flashcard').addEventListener('click', flipCard);
      
      // Set up quiz
      document.getElementById('quiz-option').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'none';
        document.querySelector('.quiz-container').style.display = 'flex';
        document.querySelector('.flashcard-container').style.display = 'none';
        document.querySelector('.writing-container').style.display = 'none';
        document.querySelector('.numbers-container').style.display = 'none';
        initializeQuiz();
      });
      
      // Set up back button for quiz
      document.getElementById('back-from-quiz').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'flex';
        document.querySelector('.quiz-container').style.display = 'none';
      });
      
      // Quiz buttons
      document.getElementById('check-answer-btn').addEventListener('click', checkAnswer);
      document.getElementById('next-question-btn').addEventListener('click', nextQuestion);
      document.getElementById('restart-quiz-btn').addEventListener('click', initializeQuiz);
      
      // Set up writing practice
      document.getElementById('writing-option').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'none';
        document.querySelector('.writing-container').style.display = 'flex';
        document.querySelector('.flashcard-container').style.display = 'none';
        document.querySelector('.quiz-container').style.display = 'none';
        document.querySelector('.numbers-container').style.display = 'none';
        initializeWriting();
      });
      
      // Set up back button for writing
      document.getElementById('back-from-writing').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'flex';
        document.querySelector('.writing-container').style.display = 'none';
      });
      
      // Writing buttons
      document.getElementById('clear-canvas-btn').addEventListener('click', clearCanvas);
      document.getElementById('check-writing-btn').addEventListener('click', checkWriting);
      document.getElementById('prev-char-btn').addEventListener('click', prevCharacter);
      document.getElementById('next-char-btn').addEventListener('click', nextCharacter);
      document.getElementById('writing-audio-btn').addEventListener('click', playWritingAudio);
      
      // Set up numbers practice
      document.getElementById('numbers-option').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'none';
        document.querySelector('.numbers-container').style.display = 'block';
        document.querySelector('.flashcard-container').style.display = 'none';
        document.querySelector('.quiz-container').style.display = 'none';
        document.querySelector('.writing-container').style.display = 'none';
      });
      
      // Set up back button for numbers
      document.getElementById('back-from-numbers').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'flex';
        document.querySelector('.numbers-container').style.display = 'none';
      });
    });
    
    // Quiz variables
    let quizWords = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let selectedAnswer = null;
    let quizStartTime;
    let quizTimer;
    
    // Quiz types
    const quizTypes = [
      { type: 'translate-korean', question: 'What does this Korean word mean?', answerField: 'translation' },
      { type: 'translate-english', question: 'What is the Korean word for:', answerField: 'korean' },
      { type: 'pronunciation', question: 'How do you pronounce this Korean word?', answerField: 'pronunciation' },
      { type: 'listening', question: 'Listen and select the correct Korean word:', answerField: 'korean' },
      { type: 'sentence-meaning', question: 'What does this Korean sentence mean?', answerField: 'translation' },
      { type: 'word-in-context', question: 'Choose the best word to complete this sentence:', answerField: 'korean' }
    ];
    
    // Add sentences for sentence-based quizzes
    const koreanSentences = [
      {
        korean: "오늘 날씨가 좋아요.",
        pronunciation: "oneul nalsiga joayo",
        translation: "Today's weather is good.",
        words: [
          { korean: "오늘", pronunciation: "oneul", translation: "today" },
          { korean: "날씨", pronunciation: "nalssi", translation: "weather" },
          { korean: "가", pronunciation: "ga", translation: "subject particle" },
          { korean: "좋아요", pronunciation: "joayo", translation: "is good" }
        ]
      },
      {
        korean: "학교에 같이 가요.",
        pronunciation: "hakgyoe gachi gayo",
        translation: "Let's go to school together.",
        words: [
          { korean: "학교", pronunciation: "hakgyo", translation: "school" },
          { korean: "에", pronunciation: "e", translation: "to (direction particle)" },
          { korean: "같이", pronunciation: "gachi", translation: "together" },
          { korean: "가요", pronunciation: "gayo", translation: "let's go" }
        ]
      },
      {
        korean: "이 음식은 맛있어요.",
        pronunciation: "i eumsigen massisseoyo",
        translation: "This food is delicious.",
        words: [
          { korean: "이", pronunciation: "i", translation: "this" },
          { korean: "음식", pronunciation: "eumsik", translation: "food" },
          { korean: "은", pronunciation: "eun", translation: "topic particle" },
          { korean: "맛있어요", pronunciation: "massisseoyo", translation: "is delicious" }
        ]
      },
      {
        korean: "커피를 마셔요.",
        pronunciation: "keopireul masyeoyo",
        translation: "I drink coffee.",
        words: [
          { korean: "커피", pronunciation: "keopi", translation: "coffee" },
          { korean: "를", pronunciation: "reul", translation: "object particle" },
          { korean: "마셔요", pronunciation: "masyeoyo", translation: "drink" }
        ]
      },
      {
        korean: "책을 읽고 있어요.",
        pronunciation: "chaekeul ilkgo isseoyo",
        translation: "I am reading a book.",
        words: [
          { korean: "책", pronunciation: "chaek", translation: "book" },
          { korean: "을", pronunciation: "eul", translation: "object particle" },
          { korean: "읽고", pronunciation: "ilkgo", translation: "reading" },
          { korean: "있어요", pronunciation: "isseoyo", translation: "am (progressive)" }
        ]
      },
      {
        korean: "내일 친구를 만나요.",
        pronunciation: "naeil chingureul mannayo",
        translation: "I'm meeting a friend tomorrow.",
        words: [
          { korean: "내일", pronunciation: "naeil", translation: "tomorrow" },
          { korean: "친구", pronunciation: "chingu", translation: "friend" },
          { korean: "를", pronunciation: "reul", translation: "object particle" },
          { korean: "만나요", pronunciation: "mannayo", translation: "meet" }
        ]
      },
      {
        korean: "한국어를 배우고 있어요.",
        pronunciation: "hangugeo-reul baeugo isseoyo",
        translation: "I am learning Korean.",
        words: [
          { korean: "한국어", pronunciation: "hangugeo", translation: "Korean language" },
          { korean: "를", pronunciation: "reul", translation: "object particle" },
          { korean: "배우고", pronunciation: "baeugo", translation: "learning" },
          { korean: "있어요", pronunciation: "isseoyo", translation: "am (progressive)" }
        ]
      },
      {
        korean: "저는 학생이에요.",
        pronunciation: "jeoneun haksaeng-ieyo",
        translation: "I am a student.",
        words: [
          { korean: "저", pronunciation: "jeo", translation: "I (formal)" },
          { korean: "는", pronunciation: "neun", translation: "topic particle" },
          { korean: "학생", pronunciation: "haksaeng", translation: "student" },
          { korean: "이에요", pronunciation: "ieyo", translation: "am (formal)" }
        ]
      },
      {
        korean: "집에 가고 싶어요.",
        pronunciation: "jibe gago sipeoyo",
        translation: "I want to go home.",
        words: [
          { korean: "집", pronunciation: "jip", translation: "home" },
          { korean: "에", pronunciation: "e", translation: "to (direction particle)" },
          { korean: "가고", pronunciation: "gago", translation: "go" },
          { korean: "싶어요", pronunciation: "sipeoyo", translation: "want to" }
        ]
      },
      {
        korean: "몇 시에 만날까요?",
        pronunciation: "myeot sie mannalkayo",
        translation: "What time shall we meet?",
        words: [
          { korean: "몇 시", pronunciation: "myeot si", translation: "what time" },
          { korean: "에", pronunciation: "e", translation: "at (time particle)" },
          { korean: "만날까요", pronunciation: "mannalkayo", translation: "shall we meet" }
        ]
      }
    ];
    
    function initializeQuiz() {
      // Reset quiz state
      document.getElementById('quiz-results').style.display = 'none';
      document.querySelector('.quiz-card').style.display = 'block';
      document.querySelector('.quiz-controls').style.display = 'flex';
      document.getElementById('quiz-feedback').style.display = 'none';
      document.getElementById('quiz-feedback').className = 'quiz-feedback';
      
      // Reset variables
      quizWords = getRandomWords(10);
      currentQuestionIndex = 0;
      score = 0;
      quizStartTime = new Date();
      
      // Update display
      document.getElementById('quiz-score').textContent = score;
      
      // Start the quiz
      showQuestion();
    }
    
    function getRandomWords(count) {
      // Create a copy of the dictionary and shuffle it
      const shuffled = [...koreanDictionary];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      
      // Return the specified number of words
      return shuffled.slice(0, count);
    }
    
    function showQuestion() {
      // Get current question data
      const word = quizWords[currentQuestionIndex];
      
      // Randomly select quiz type, but give higher weight to basic types for newer users
      let quizType;
      const randomValue = Math.random();
      
      if (randomValue < 0.7) {
        // 70% chance for basic quiz types (first 4 types)
        const basicTypeIndex = Math.floor(Math.random() * 4);
        quizType = quizTypes[basicTypeIndex];
      } else {
        // 30% chance for advanced quiz types (sentence types)
        const advancedTypeIndex = Math.floor(Math.random() * 2) + 4; // indices 4 and 5
        quizType = quizTypes[advancedTypeIndex];
      }
      
      // Update question text
      document.getElementById('quiz-progress').textContent = `Question ${currentQuestionIndex + 1} of ${quizWords.length}`;
      
      // Clear previous selections
      selectedAnswer = null;
      document.getElementById('next-question-btn').disabled = true;
      document.getElementById('check-answer-btn').disabled = false;
      
      // Clear previous feedback
      document.getElementById('quiz-feedback').style.display = 'none';
      
      // Create question based on quiz type
      const questionText = document.getElementById('question-text');
      
      // Set up audio button for all question types
      const questionAudioBtn = document.getElementById('question-audio-btn');
      questionAudioBtn.style.display = 'inline-block';
      
      // Handle different quiz types
      if (quizType.type === 'listening') {
        questionText.textContent = quizType.question;
        
        // Set audio playback for listening questions
        questionAudioBtn.onclick = function() {
          playPlainAudio(word.korean);
        };
        
        // Play audio automatically after a short delay
        setTimeout(() => {
          playPlainAudio(word.korean);
        }, 500);
        
      } else if (quizType.type === 'translate-english') {
        questionText.textContent = `${quizType.question} "${word.translation}"`;
        
        // Set audio button for English-to-Korean
        questionAudioBtn.onclick = function() {
          // Play pronunciation of the correct Korean answer
          playPlainAudio(word.korean);
        };
        
      } else if (quizType.type === 'sentence-meaning') {
        // Get a random sentence
        const sentenceIndex = Math.floor(Math.random() * koreanSentences.length);
        const sentence = koreanSentences[sentenceIndex];
        currentQuizSentence = sentence; // Store for explanation later
        
        // Create Korean text with pronunciation
        const koreanWithPronunciation = document.createElement('div');
        koreanWithPronunciation.innerHTML = `
          <div style="font-size: 22px; font-weight: bold; margin-bottom: 5px;">${sentence.korean}</div>
          <div style="color: #666; font-size: 14px; margin-bottom: 15px;">${sentence.pronunciation}</div>
        `;
        
        questionText.textContent = quizType.question;
        questionText.appendChild(koreanWithPronunciation);
        
        // Set audio button for sentence
        questionAudioBtn.onclick = function() {
          playPlainAudio(sentence.korean);
        };
        
        // Play audio automatically after a short delay
        setTimeout(() => {
          playPlainAudio(sentence.korean);
        }, 500);
        
        // Get incorrect options (other sentence translations)
        const otherSentences = koreanSentences
          .filter((s, i) => i !== sentenceIndex)
          .map(s => s.translation);
        
        // Shuffle and take 3
        const incorrectOptions = shuffleArray(otherSentences).slice(0, 3);
        
        // Combine correct and incorrect answers
        const allOptions = [sentence.translation, ...incorrectOptions];
        const shuffledOptions = shuffleArray(allOptions);
        
        // Create answer buttons
        createAnswerOptions(shuffledOptions);
        
        return; // We've handled this special case
        
      } else if (quizType.type === 'word-in-context') {
        // Get a random sentence and a word to remove
        const sentenceIndex = Math.floor(Math.random() * koreanSentences.length);
        const sentence = koreanSentences[sentenceIndex];
        currentQuizSentence = sentence; // Store for explanation later
        
        // Choose a word to blank out (excluding particles if possible)
        const contentWords = sentence.words.filter(w => 
          !['가', '는', '을', '를', '에', '의', '이', '과', '와'].includes(w.korean)
        );
        
        // If no content words, use any word
        const wordsToChooseFrom = contentWords.length > 0 ? contentWords : sentence.words;
        const blankWordIndex = Math.floor(Math.random() * wordsToChooseFrom.length);
        const blankWord = wordsToChooseFrom[blankWordIndex];
        currentQuizBlankWord = blankWord; // Store for explanation later
        
        // Create the sentence with a blank
        const sentenceWithBlank = sentence.korean.replace(blankWord.korean, "_____");
        const pronunciationWithBlank = sentence.pronunciation.replace(blankWord.pronunciation, "_____");
        
        // Create Korean text with pronunciation
        const koreanWithPronunciation = document.createElement('div');
        koreanWithPronunciation.innerHTML = `
          <div style="font-size: 22px; font-weight: bold; margin-bottom: 5px;">${sentenceWithBlank}</div>
          <div style="color: #666; font-size: 14px; margin-bottom: 15px;">${pronunciationWithBlank}</div>
        `;
        
        questionText.textContent = quizType.question;
        questionText.appendChild(koreanWithPronunciation);
        
        // Set audio button for sentence
        questionAudioBtn.onclick = function() {
          // Play full sentence even though we show with blank
          playPlainAudio(sentence.korean);
        };
        
        // Play audio of the full sentence after a short delay
        setTimeout(() => {
          playPlainAudio(sentence.korean);
        }, 500);
        
        // Get incorrect options (other words that could fit grammatically)
        const incorrectOptions = koreanDictionary
          .filter(w => w.korean !== blankWord.korean)
          .filter(w => w.categories.some(cat => blankWord.korean.length < 2 || cat === "Common"))
          .map(w => w.korean);
        
        // Shuffle and take 3
        const shuffledIncorrectOptions = shuffleArray(incorrectOptions).slice(0, 3);
        
        // Combine correct and incorrect answers
        const allOptions = [blankWord.korean, ...shuffledIncorrectOptions];
        const shuffledOptions = shuffleArray(allOptions);
        
        // Create answer buttons
        createAnswerOptions(shuffledOptions);
        
        return; // We've handled this special case
      } else {
        // Create Korean text with pronunciation for standard questions
        const koreanWithPronunciation = document.createElement('div');
        
        if (quizType.type === 'translate-korean') {
          koreanWithPronunciation.innerHTML = `
            <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${word.korean}</div>
            <div style="color: #666; font-size: 14px; margin-bottom: 15px;">${word.pronunciation}</div>
          `;
          
          questionText.textContent = quizType.question;
          questionText.appendChild(koreanWithPronunciation);
          
          // Set audio button for Korean word
          questionAudioBtn.onclick = function() {
            playPlainAudio(word.korean);
          };
          
          // Play audio automatically after a short delay
          setTimeout(() => {
            playPlainAudio(word.korean);
          }, 500);
        } else {
          questionText.textContent = `${quizType.question} "${word.korean}"`;
          
          // Set audio button for Korean word
          questionAudioBtn.onclick = function() {
            playPlainAudio(word.korean);
          };
          
          // Play audio automatically after a short delay
          setTimeout(() => {
            playPlainAudio(word.korean);
          }, 500);
        }
      }
      
      // Get incorrect options
      const otherWords = getIncorrectOptions(word, quizType.answerField);
      
      // Combine correct answer with incorrect options and shuffle
      const allOptions = [word[quizType.answerField], ...otherWords];
      const shuffledOptions = shuffleArray(allOptions);
      
      // Create answer buttons
      createAnswerOptions(shuffledOptions);
    }
    
    // Helper function to create answer options
    function createAnswerOptions(options) {
      const answersContainer = document.getElementById('answers-container');
      answersContainer.innerHTML = '';
      
      options.forEach((option, index) => {
        const answerBtn = document.createElement('div');
        answerBtn.className = 'answer-option';
        answerBtn.textContent = option;
        answerBtn.dataset.value = option;
        answerBtn.addEventListener('click', () => selectAnswer(answerBtn));
        answersContainer.appendChild(answerBtn);
      });
    }
    
    // Helper function to shuffle array
    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }
    
    // Add variables to track current sentence quiz data
    let currentQuizSentence = null;
    let currentQuizBlankWord = null;
    
    function checkAnswer() {
      if (!selectedAnswer) {
        alert('Please select an answer');
        return;
      }
      
      // Get current question data
      const word = quizWords[currentQuestionIndex];
      const quizType = quizTypes.find(type => {
        if (type.type === 'listening') {
          return document.getElementById('question-text').textContent === type.question;
        } else if (type.type === 'translate-english') {
          return document.getElementById('question-text').textContent.includes(type.question);
        } else if (type.type === 'sentence-meaning') {
          return document.getElementById('question-text').textContent.includes(type.question);
        } else if (type.type === 'word-in-context') {
          return document.getElementById('question-text').textContent.includes(type.question);
        } else {
          return document.getElementById('question-text').textContent.includes(type.question);
        }
      });
      
      // Check if the answer is correct
      let isCorrect = false;
      let correctAnswer = '';
      
      if (quizType.type === 'sentence-meaning') {
        correctAnswer = currentQuizSentence.translation;
        isCorrect = selectedAnswer === correctAnswer;
      } else if (quizType.type === 'word-in-context') {
        correctAnswer = currentQuizBlankWord.korean;
        isCorrect = selectedAnswer === correctAnswer;
      } else {
        correctAnswer = word[quizType.answerField];
        isCorrect = selectedAnswer === correctAnswer;
      }
      
      // Update UI
      document.querySelectorAll('.answer-option').forEach(opt => {
        if (opt.dataset.value === correctAnswer) {
          opt.classList.add('correct');
        } else if (opt.dataset.value === selectedAnswer && !isCorrect) {
          opt.classList.add('incorrect');
        }
      });
      
      // Show feedback
      const feedback = document.getElementById('quiz-feedback');
      
      if (isCorrect) {
        feedback.className = 'quiz-feedback correct';
        feedback.textContent = 'Correct! 👍';
        score++;
        document.getElementById('quiz-score').textContent = score;
      } else {
        feedback.className = 'quiz-feedback incorrect';
        feedback.textContent = `Incorrect. The correct answer is: ${correctAnswer}`;
      }
      
      // Add detailed feedback with pronunciation for all quiz types
      const detailedDiv = document.createElement('div');
      detailedDiv.className = 'detailed-feedback';
      detailedDiv.style.marginTop = '15px';
      detailedDiv.style.backgroundColor = '#f8f9fa';
      detailedDiv.style.padding = '15px';
      detailedDiv.style.borderRadius = '5px';
      
      if (quizType.type === 'sentence-meaning' || quizType.type === 'word-in-context') {
        // Sentence breakdown explanation
        const explanationTitle = document.createElement('div');
        explanationTitle.textContent = 'Sentence Breakdown:';
        explanationTitle.style.fontWeight = 'bold';
        explanationTitle.style.marginBottom = '10px';
        
        detailedDiv.appendChild(explanationTitle);
        
        // Add each word with its meaning
        currentQuizSentence.words.forEach(word => {
          const wordDiv = document.createElement('div');
          wordDiv.style.margin = '8px 0';
          wordDiv.style.padding = '5px';
          wordDiv.style.borderRadius = '4px';
          
          const koreanSpan = document.createElement('span');
          koreanSpan.textContent = word.korean;
          koreanSpan.style.fontWeight = 'bold';
          koreanSpan.style.fontSize = '18px';
          
          const pronunciationSpan = document.createElement('span');
          pronunciationSpan.textContent = ` (${word.pronunciation}) `;
          pronunciationSpan.style.color = '#666';
          
          const translationSpan = document.createElement('span');
          translationSpan.textContent = `- ${word.translation}`;
          
          const soundButton = document.createElement('button');
          soundButton.textContent = '🔊';
          soundButton.style.marginLeft = '8px';
          soundButton.style.background = 'transparent';
          soundButton.style.border = 'none';
          soundButton.style.cursor = 'pointer';
          soundButton.style.fontSize = '16px';
          soundButton.addEventListener('click', (e) => {
            e.stopPropagation();
            playPlainAudio(word.korean);
          });
          
          wordDiv.appendChild(koreanSpan);
          wordDiv.appendChild(pronunciationSpan);
          wordDiv.appendChild(translationSpan);
          wordDiv.appendChild(soundButton);
          
          // Highlight the blank word in word-in-context quiz
          if (quizType.type === 'word-in-context' && word.korean === currentQuizBlankWord.korean) {
            wordDiv.style.backgroundColor = '#e8f0fe';
          }
          
          detailedDiv.appendChild(wordDiv);
        });
        
        // Play full sentence audio
        const sentenceAudioDiv = document.createElement('div');
        sentenceAudioDiv.style.marginTop = '15px';
        sentenceAudioDiv.style.textAlign = 'center';
        
        const sentenceAudioBtn = document.createElement('button');
        sentenceAudioBtn.innerHTML = '🔊 Play Full Sentence';
        sentenceAudioBtn.style.padding = '8px 15px';
        sentenceAudioBtn.style.backgroundColor = '#5782BB';
        sentenceAudioBtn.style.color = 'white';
        sentenceAudioBtn.style.border = 'none';
        sentenceAudioBtn.style.borderRadius = '5px';
        sentenceAudioBtn.style.cursor = 'pointer';
        sentenceAudioBtn.addEventListener('click', () => {
          playPlainAudio(currentQuizSentence.korean);
        });
        
        sentenceAudioDiv.appendChild(sentenceAudioBtn);
        detailedDiv.appendChild(sentenceAudioDiv);
        
      } else {
        // Standard word explanation
        const wordInfoTitle = document.createElement('div');
        wordInfoTitle.textContent = 'Word Information:';
        wordInfoTitle.style.fontWeight = 'bold';
        wordInfoTitle.style.marginBottom = '10px';
        
        const wordInfoContainer = document.createElement('div');
        wordInfoContainer.style.display = 'flex';
        wordInfoContainer.style.alignItems = 'center';
        wordInfoContainer.style.gap = '10px';
        wordInfoContainer.style.padding = '10px';
        wordInfoContainer.style.backgroundColor = 'white';
        wordInfoContainer.style.borderRadius = '5px';
        wordInfoContainer.style.border = '1px solid #e0e0e0';
        wordInfoContainer.style.marginBottom = '15px';
        
        const koreanText = document.createElement('div');
        koreanText.textContent = word.korean;
        koreanText.style.fontWeight = 'bold';
        koreanText.style.fontSize = '24px';
        
        const pronunciationText = document.createElement('div');
        pronunciationText.textContent = `(${word.pronunciation})`;
        pronunciationText.style.color = '#666';
        pronunciationText.style.fontSize = '16px';
        
        const translationText = document.createElement('div');
        translationText.textContent = word.translation;
        translationText.style.fontSize = '16px';
        
        const soundButton = document.createElement('button');
        soundButton.textContent = '🔊';
        soundButton.style.marginLeft = 'auto';
        soundButton.style.background = 'transparent';
        soundButton.style.border = 'none';
        soundButton.style.cursor = 'pointer';
        soundButton.style.fontSize = '20px';
        soundButton.addEventListener('click', (e) => {
          e.stopPropagation();
          playPlainAudio(word.korean);
        });
        
        wordInfoContainer.appendChild(koreanText);
        wordInfoContainer.appendChild(pronunciationText);
        wordInfoContainer.appendChild(translationText);
        wordInfoContainer.appendChild(soundButton);
        
        detailedDiv.appendChild(wordInfoTitle);
        detailedDiv.appendChild(wordInfoContainer);
        
        // Add example if available
        if (word.example) {
          const exampleTitle = document.createElement('div');
          exampleTitle.textContent = 'Example:';
          exampleTitle.style.fontWeight = 'bold';
          exampleTitle.style.marginBottom = '5px';
          exampleTitle.style.marginTop = '10px';
          
          const exampleContainer = document.createElement('div');
          exampleContainer.style.backgroundColor = '#f5f5f5';
          exampleContainer.style.padding = '10px';
          exampleContainer.style.borderRadius = '5px';
          
          // Parse Korean and translation parts
          let koreanText = word.example;
          let translationText = '';
          
          if (word.example.includes('(') && word.example.includes(')')) {
            const parts = word.example.split(/\(|\)/);
            koreanText = parts[0].trim();
            translationText = parts[1].trim();
          }
          
          const exampleKorean = document.createElement('div');
          exampleKorean.textContent = koreanText;
          exampleKorean.style.fontWeight = 'bold';
          exampleKorean.style.marginBottom = '5px';
          
          const exampleTranslation = document.createElement('div');
          exampleTranslation.textContent = translationText;
          exampleTranslation.style.fontStyle = 'italic';
          exampleTranslation.style.color = '#666';
          
          const exampleAudioBtn = document.createElement('button');
          exampleAudioBtn.textContent = '🔊';
          exampleAudioBtn.style.marginLeft = '10px';
          exampleAudioBtn.style.background = 'transparent';
          exampleAudioBtn.style.border = 'none';
          exampleAudioBtn.style.cursor = 'pointer';
          exampleAudioBtn.style.fontSize = '16px';
          exampleAudioBtn.addEventListener('click', () => {
            playPlainAudio(koreanText);
          });
          
          const exampleKoreanContainer = document.createElement('div');
          exampleKoreanContainer.style.display = 'flex';
          exampleKoreanContainer.style.alignItems = 'center';
          exampleKoreanContainer.appendChild(exampleKorean);
          exampleKoreanContainer.appendChild(exampleAudioBtn);
          
          exampleContainer.appendChild(exampleKoreanContainer);
          exampleContainer.appendChild(exampleTranslation);
          
          detailedDiv.appendChild(exampleTitle);
          detailedDiv.appendChild(exampleContainer);
        }
        
        // Add categories
        if (word.categories && word.categories.length > 0) {
          const categoriesTitle = document.createElement('div');
          categoriesTitle.textContent = 'Categories:';
          categoriesTitle.style.fontWeight = 'bold';
          categoriesTitle.style.marginBottom = '5px';
          categoriesTitle.style.marginTop = '10px';
          
          const categoriesContainer = document.createElement('div');
          categoriesContainer.style.display = 'flex';
          categoriesContainer.style.flexWrap = 'wrap';
          categoriesContainer.style.gap = '5px';
          
          word.categories.forEach(category => {
            const categoryTag = document.createElement('span');
            categoryTag.textContent = category;
            categoryTag.style.backgroundColor = '#e8f0fe';
            categoryTag.style.color = '#5782BB';
            categoryTag.style.padding = '3px 10px';
            categoryTag.style.borderRadius = '12px';
            categoryTag.style.fontSize = '12px';
            
            categoriesContainer.appendChild(categoryTag);
          });
          
          detailedDiv.appendChild(categoriesTitle);
          detailedDiv.appendChild(categoriesContainer);
        }
      }
      
      // Automatically play the audio
      setTimeout(() => {
        if (quizType.type === 'sentence-meaning' || quizType.type === 'word-in-context') {
          playPlainAudio(currentQuizSentence.korean);
        } else {
          playPlainAudio(word.korean);
        }
      }, 500);
      
      feedback.appendChild(detailedDiv);
      feedback.style.display = 'block';
      
      // Disable check button and enable next button
      document.getElementById('check-answer-btn').disabled = true;
      document.getElementById('next-question-btn').disabled = false;
    }
    
    function nextQuestion() {
      currentQuestionIndex++;
      
      // Check if the quiz is complete
      if (currentQuestionIndex >= quizWords.length) {
        finishQuiz();
        return;
      }
      
      // Show next question
      showQuestion();
    }
    
    function finishQuiz() {
      // Calculate time taken
      const endTime = new Date();
      const timeTaken = Math.floor((endTime - quizStartTime) / 1000); // in seconds
      const minutes = Math.floor(timeTaken / 60);
      const seconds = timeTaken % 60;
      
      // Update results
      document.getElementById('final-score').textContent = score;
      document.getElementById('correct-answers').textContent = score;
      document.getElementById('time-taken').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Show results
      document.querySelector('.quiz-card').style.display = 'none';
      document.querySelector('.quiz-controls').style.display = 'none';
      document.getElementById('quiz-results').style.display = 'block';
      
      // Save progress
      for (let i = 0; i < quizWords.length; i++) {
        const word = quizWords[i];
        if (!studyProgress[word.korean]) {
          studyProgress[word.korean] = { count: 0, lastReview: 0 };
        }
        studyProgress[word.korean].count++;
        studyProgress[word.korean].lastReview = Date.now();
      }
      saveProgress();
      
      // Add activity
      addActivity(`Completed quiz with score: ${score}/${quizWords.length}`);
    }
    
    // Writing practice variables
    let characters = [];
    let currentCharIndex = 0;
    let canvas, ctx;
    
    function initializeWriting() {
      // Set up canvas
      canvas = document.getElementById('writing-canvas');
      ctx = canvas.getContext('2d');
      
      // Set up drawing
      setupCanvas();
      
      // Select characters to practice
      characters = getHangulCharacters();
      currentCharIndex = 0;
      
      // Show first character
      showCharacter();
    }
    
    function getHangulCharacters() {
      // Basic Hangul consonants and vowels
      return [
        { char: 'ㄱ', name: 'giyeok', sound: 'g/k' },
        { char: 'ㄴ', name: 'nieun', sound: 'n' },
        { char: 'ㄷ', name: 'digeut', sound: 'd/t' },
        { char: 'ㄹ', name: 'rieul', sound: 'r/l' },
        { char: 'ㅁ', name: 'mieum', sound: 'm' },
        { char: 'ㅂ', name: 'bieup', sound: 'b/p' },
        { char: 'ㅅ', name: 'siot', sound: 's' },
        { char: 'ㅇ', name: 'ieung', sound: 'ng (silent at beginning)' },
        { char: 'ㅈ', name: 'jieut', sound: 'j' },
        { char: 'ㅊ', name: 'chieut', sound: 'ch' },
        { char: 'ㅋ', name: 'kieuk', sound: 'k' },
        { char: 'ㅌ', name: 'tieut', sound: 't' },
        { char: 'ㅍ', name: 'pieup', sound: 'p' },
        { char: 'ㅎ', name: 'hieut', sound: 'h' },
        { char: 'ㅏ', name: 'a', sound: 'a' },
        { char: 'ㅑ', name: 'ya', sound: 'ya' },
        { char: 'ㅓ', name: 'eo', sound: 'eo' },
        { char: 'ㅕ', name: 'yeo', sound: 'yeo' },
        { char: 'ㅗ', name: 'o', sound: 'o' },
        { char: 'ㅛ', name: 'yo', sound: 'yo' },
        { char: 'ㅜ', name: 'u', sound: 'u' },
        { char: 'ㅠ', name: 'yu', sound: 'yu' },
        { char: 'ㅡ', name: 'eu', sound: 'eu' },
        { char: 'ㅣ', name: 'i', sound: 'i' }
      ];
    }
    
    function setupCanvas() {
      // Initialize drawing state
      ctx.lineWidth = 8;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = '#000';
      
      // Clear canvas
      clearCanvas();
      
      // Set up event listeners for drawing
      let isDrawing = false;
      let lastX = 0;
      let lastY = 0;
      
      canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
      });
      
      canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        lastX = x;
        lastY = y;
      });
      
      canvas.addEventListener('mouseup', () => {
        isDrawing = false;
      });
      
      canvas.addEventListener('mouseout', () => {
        isDrawing = false;
      });
      
      // Touch support
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        lastX = touch.clientX - rect.left;
        lastY = touch.clientY - rect.top;
        isDrawing = true;
      });
      
      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        lastX = x;
        lastY = y;
      });
      
      canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        isDrawing = false;
      });
    }
    
    function showCharacter() {
      const character = characters[currentCharIndex];
      
      document.getElementById('writing-character').textContent = character.char;
      document.getElementById('writing-pronunciation').textContent = `${character.name} (${character.sound})`;
      document.getElementById('writing-progress').textContent = `Character ${currentCharIndex + 1} of ${characters.length}`;
      
      clearCanvas();
    }
    
    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Add grid lines for guidance
      ctx.strokeStyle = '#e0e0e0';
      ctx.lineWidth = 1;
      
      // Horizontal center line
      ctx.beginPath();
      ctx.moveTo(0, canvas.height / 2);
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();
      
      // Vertical center line
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.stroke();
      
      // Reset for drawing
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 8;
    }
    
    function checkWriting() {
      // In a real app, we would use ML to check the writing
      // For this demo, we'll just give positive feedback
      const feedback = document.getElementById('writing-feedback');
      feedback.textContent = "Good effort! Practice makes perfect!";
      feedback.className = 'writing-feedback correct';
      feedback.style.display = 'block';
      
      setTimeout(() => {
        feedback.style.display = 'none';
      }, 3000);
    }
    
    function prevCharacter() {
      if (currentCharIndex > 0) {
        currentCharIndex--;
        showCharacter();
      }
    }
    
    function nextCharacter() {
      if (currentCharIndex < characters.length - 1) {
        currentCharIndex++;
        showCharacter();
      }
    }
    
    function playWritingAudio() {
      const character = characters[currentCharIndex];
      playAudio(character.char);
    }
    
    function getIncorrectOptions(correctWord, field) {
      // Get 3 random words that are different from the correct word
      const incorrectOptions = [];
      const usedValues = new Set([correctWord[field]]);
      
      // Try to get words from the same category if possible
      const sameCategory = koreanDictionary.filter(word => 
        word !== correctWord && 
        word.categories.some(cat => correctWord.categories.includes(cat))
      );
      
      // If we have enough words in the same category, use them
      if (sameCategory.length >= 3) {
        for (let i = 0; i < 3; i++) {
          let randomIndex = Math.floor(Math.random() * sameCategory.length);
          let optionValue = sameCategory[randomIndex][field];
          
          // Ensure we don't use duplicates
          while (usedValues.has(optionValue)) {
            randomIndex = (randomIndex + 1) % sameCategory.length;
            optionValue = sameCategory[randomIndex][field];
          }
          
          incorrectOptions.push(optionValue);
          usedValues.add(optionValue);
        }
      } else {
        // Otherwise use random words from the dictionary
        while (incorrectOptions.length < 3) {
          const randomIndex = Math.floor(Math.random() * koreanDictionary.length);
          const optionValue = koreanDictionary[randomIndex][field];
          
          if (!usedValues.has(optionValue)) {
            incorrectOptions.push(optionValue);
            usedValues.add(optionValue);
          }
        }
      }
      
      return incorrectOptions;
    }
    
    function selectAnswer(answerElement) {
      // Clear previous selection
      document.querySelectorAll('.answer-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      // Select the new answer
      answerElement.classList.add('selected');
      selectedAnswer = answerElement.dataset.value;
    }
    
    function initializeNumbersSection() {
      // Native Korean numbers data
      const nativeNumbers = [
        { korean: "하나", pronunciation: "hana", number: "1" },
        { korean: "둘", pronunciation: "dul", number: "2" },
        { korean: "셋", pronunciation: "set", number: "3" },
        { korean: "넷", pronunciation: "net", number: "4" },
        { korean: "다섯", pronunciation: "daseot", number: "5" },
        { korean: "여섯", pronunciation: "yeoseot", number: "6" },
        { korean: "일곱", pronunciation: "ilgop", number: "7" },
        { korean: "여덟", pronunciation: "yeodeol", number: "8" },
        { korean: "아홉", pronunciation: "ahop", number: "9" },
        { korean: "열", pronunciation: "yeol", number: "10" },
        { korean: "스물", pronunciation: "seumul", number: "20" },
        { korean: "서른", pronunciation: "seoreun", number: "30" },
        { korean: "마흔", pronunciation: "maheun", number: "40" },
        { korean: "쉰", pronunciation: "swin", number: "50" },
        { korean: "예순", pronunciation: "yesun", number: "60" },
        { korean: "일흔", pronunciation: "ilheun", number: "70" },
        { korean: "여든", pronunciation: "yeodeun", number: "80" },
        { korean: "아흔", pronunciation: "aheun", number: "90" },
        { korean: "백", pronunciation: "baek", number: "100" }
      ];
      
      // Sino-Korean numbers data
      const sinoNumbers = [
        { korean: "영", pronunciation: "yeong", number: "0" },
        { korean: "일", pronunciation: "il", number: "1" },
        { korean: "이", pronunciation: "i", number: "2" },
        { korean: "삼", pronunciation: "sam", number: "3" },
        { korean: "사", pronunciation: "sa", number: "4" },
        { korean: "오", pronunciation: "o", number: "5" },
        { korean: "육", pronunciation: "yuk", number: "6" },
        { korean: "칠", pronunciation: "chil", number: "7" },
        { korean: "팔", pronunciation: "pal", number: "8" },
        { korean: "구", pronunciation: "gu", number: "9" },
        { korean: "십", pronunciation: "ship", number: "10" },
        { korean: "백", pronunciation: "baek", number: "100" },
        { korean: "천", pronunciation: "cheon", number: "1,000" },
        { korean: "만", pronunciation: "man", number: "10,000" },
        { korean: "억", pronunciation: "eok", number: "100,000,000" }
      ];
      
      // Counters data
      const counters = [
        { counter: "개", pronunciation: "gae", usage: "General objects", example: "사과 두 개 (two apples)" },
        { counter: "명", pronunciation: "myeong", usage: "People (formal)", example: "학생 세 명 (three students)" },
        { counter: "잔", pronunciation: "jan", usage: "Cups of liquid", example: "커피 한 잔 (one cup of coffee)" },
        { counter: "병", pronunciation: "byeong", usage: "Bottles", example: "맥주 두 병 (two bottles of beer)" },
        { counter: "권", pronunciation: "gwon", usage: "Books", example: "책 세 권 (three books)" },
        { counter: "장", pronunciation: "jang", usage: "Flat objects", example: "종이 다섯 장 (five sheets of paper)" },
        { counter: "대", pronunciation: "dae", usage: "Machines, vehicles", example: "자동차 한 대 (one car)" },
        { counter: "번", pronunciation: "beon", usage: "Numbers, times", example: "세 번 (three times)" },
        { counter: "마리", pronunciation: "mari", usage: "Animals", example: "고양이 두 마리 (two cats)" }
      ];
      
      // Fill the native numbers table
      const nativeNumbersBody = document.getElementById('native-numbers-body');
      nativeNumbers.forEach(num => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="padding: 8px; border: 1px solid #dee2e6;">${num.korean}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${num.pronunciation}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${num.number}</td>
          <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">
            <button class="number-audio-btn" data-text="${num.korean}" style="background: none; border: none; cursor: pointer;">🔊</button>
          </td>
        `;
        nativeNumbersBody.appendChild(row);
      });
      
      // Fill the sino-korean numbers table
      const sinoNumbersBody = document.getElementById('sino-numbers-body');
      sinoNumbers.forEach(num => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="padding: 8px; border: 1px solid #dee2e6;">${num.korean}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${num.pronunciation}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${num.number}</td>
          <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">
            <button class="number-audio-btn" data-text="${num.korean}" style="background: none; border: none; cursor: pointer;">🔊</button>
          </td>
        `;
        sinoNumbersBody.appendChild(row);
      });
      
      // Fill the counters table
      const countersBody = document.getElementById('counters-body');
      counters.forEach(counter => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="padding: 8px; border: 1px solid #dee2e6;">${counter.counter}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${counter.pronunciation}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${counter.usage}</td>
          <td style="padding: 8px; border: 1px solid #dee2e6;">${counter.example}</td>
          <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">
            <button class="number-audio-btn" data-text="${counter.example.split(' ').slice(0, 2).join(' ')}" style="background: none; border: none; cursor: pointer;">🔊</button>
          </td>
        `;
        countersBody.appendChild(row);
      });
      
      // Add click event for all audio buttons
      document.querySelectorAll('.number-audio-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          playPlainAudio(btn.getAttribute('data-text'));
        });
      });
      
      // Set up number practice
      initializeNumberPractice();
    }
    
    function initializeNumberPractice() {
      // Native Korean number mappings for practice
      const nativeNumberMap = {
        "1": "하나", "2": "둘", "3": "셋", "4": "넷", "5": "다섯",
        "6": "여섯", "7": "일곱", "8": "여덟", "9": "아홉", "10": "열",
        "20": "스물", "30": "서른", "40": "마흔", "50": "쉰",
        "60": "예순", "70": "일흔", "80": "여든", "90": "아흔", "100": "백"
      };
      
      // Composite numbers for teens, etc.
      for (let i = 11; i <= 19; i++) {
        nativeNumberMap[i] = "열" + nativeNumberMap[i-10];
      }
      for (let i = 21; i <= 29; i++) {
        nativeNumberMap[i] = "스물" + nativeNumberMap[i-20];
      }
      for (let i = 31; i <= 39; i++) {
        nativeNumberMap[i] = "서른" + nativeNumberMap[i-30];
      }
      for (let i = 41; i <= 49; i++) {
        nativeNumberMap[i] = "마흔" + nativeNumberMap[i-40];
      }
      
      // Sino-Korean number mappings for practice
      const sinoNumberMap = {
        "0": "영", "1": "일", "2": "이", "3": "삼", "4": "사", "5": "오",
        "6": "육", "7": "칠", "8": "팔", "9": "구", "10": "십"
      };
      
      // Random number for number-to-Korean practice
      function getRandomNumber() {
        let num;
        if (Math.random() < 0.7) {
          // 70% chance for 1-100
          num = Math.floor(Math.random() * 100) + 1;
        } else {
          // 30% chance for common years, times, etc.
          const commonNumbers = [0, 100, 1000, 2023, 2024, 911, 119, 112];
          num = commonNumbers[Math.floor(Math.random() * commonNumbers.length)];
        }
        return num;
      }
      
      // Convert number to Korean (native system)
      function numberToKorean(num) {
        if (num <= 100 && nativeNumberMap[num]) {
          return nativeNumberMap[num];
        }
        
        // For larger numbers, use Sino-Korean system
        let result = '';
        const numStr = num.toString();
        
        for (let i = 0; i < numStr.length; i++) {
          const digit = numStr[i];
          const position = numStr.length - i - 1;
          
          if (digit === '0') continue;
          
          result += sinoNumberMap[digit];
          
          if (position === 3) {
            result += '천';
          } else if (position === 2) {
            result += '백';
          } else if (position === 1) {
            result += '십';
          }
        }
        
        return result;
      }
      
      // Initialize number practice
      let currentNumber = getRandomNumber();
      document.getElementById('number-practice-display').textContent = currentNumber;
      
      // Show answer button - Number to Korean
      document.getElementById('show-number-answer').addEventListener('click', () => {
        const koreanNumber = numberToKorean(currentNumber);
        document.getElementById('number-practice-answer').textContent = koreanNumber;
        playPlainAudio(koreanNumber);
      });
      
      // Next number button
      document.getElementById('next-number-practice').addEventListener('click', () => {
        currentNumber = getRandomNumber();
        document.getElementById('number-practice-display').textContent = currentNumber;
        document.getElementById('number-practice-answer').textContent = '';
      });
      
      // Korean to number practice
      const koreanNumbers = Object.entries(nativeNumberMap).map(([num, korean]) => ({ num, korean }));
      let currentKoreanIndex = Math.floor(Math.random() * koreanNumbers.length);
      
      function updateKoreanPractice() {
        const currentKorean = koreanNumbers[currentKoreanIndex];
        document.getElementById('korean-practice-display').textContent = currentKorean.korean;
        document.getElementById('korean-practice-answer').textContent = '';
      }
      
      updateKoreanPractice();
      
      // Show answer button - Korean to Number
      document.getElementById('show-korean-answer').addEventListener('click', () => {
        const currentKorean = koreanNumbers[currentKoreanIndex];
        document.getElementById('korean-practice-answer').textContent = currentKorean.num;
        playPlainAudio(currentKorean.korean);
      });
      
      // Next word button
      document.getElementById('next-korean-practice').addEventListener('click', () => {
        currentKoreanIndex = Math.floor(Math.random() * koreanNumbers.length);
        updateKoreanPractice();
      });
    }
    
    // Add new functions for progress tracking
    function initializeProgress() {
      try {
        console.log('Initializing progress tracking...');
        
        // Create progress container if it doesn't exist
        let progressContainer = document.querySelector('.progress-stats');
        if (!progressContainer) {
          console.log('Creating progress stats container...');
          progressContainer = document.createElement('div');
          progressContainer.className = 'progress-stats';
          const mainContent = document.querySelector('.main-content');
          if (mainContent) {
            mainContent.appendChild(progressContainer);
          } else {
            console.error('Main content container not found');
            return;
          }
        }
        
        // Create activity list container if it doesn't exist
        if (!document.getElementById('activity-list')) {
          console.log('Creating activity list container...');
          const activityList = document.createElement('div');
          activityList.id = 'activity-list';
          activityList.className = 'activity-list';
          progressContainer.appendChild(activityList);
        }
        
      // Load progress data
      const progressData = JSON.parse(localStorage.getItem('koreanProgress') || '{}');
        console.log('Loaded progress data:', progressData);
      
      // Update stats
      updateProgressStats(progressData);
      
      // Load recent activity
      loadRecentActivity();
      
      // Set up export/import handlers
        console.log('Progress tracking initialized successfully');
      } catch (error) {
        console.error('Error initializing progress:', error);
      }
      setupDataHandlers();
    }
    
    function updateProgressStats(data) {
      const totalWords = koreanDictionary.length;
      const studiedWords = Object.keys(studyProgress).length;
      const completionPercentage = Math.round((studiedWords / totalWords) * 100);
      
      // Only update elements if they exist
      const totalWordsStudied = document.getElementById('total-words-studied');
      if (totalWordsStudied) {
        totalWordsStudied.textContent = `${studiedWords} / ${totalWords}`;
      }

      const completionElement = document.getElementById('completion-percentage');
      if (completionElement) {
        completionElement.textContent = `${completionPercentage}%`;
      }

      const quizAverage = document.getElementById('quiz-average');
      if (quizAverage) {
        quizAverage.textContent = `${calculateQuizAverage()}%`;
      }
      
      // Update progress bar if it exists
      const progressBar = document.getElementById('progress-bar');
      if (progressBar) {
      progressBar.style.width = `${completionPercentage}%`;
      }
    }
    
    function loadRecentActivity() {
      try {
        console.log('Loading recent activity...');
      const activityList = document.getElementById('activity-list');
        if (!activityList) {
          console.error('Activity list container not found');
          return;
        }

      const recentActivity = JSON.parse(localStorage.getItem('recentActivity') || '[]');
        console.log('Loaded recent activity:', recentActivity);
      
      activityList.innerHTML = '';
        
        if (recentActivity.length === 0) {
          const emptyMessage = document.createElement('div');
          emptyMessage.className = 'activity-item empty';
          emptyMessage.textContent = 'No recent activity';
          activityList.appendChild(emptyMessage);
          return;
        }
        
      recentActivity.forEach(activity => {
          if (!activity) return;
        const item = document.createElement('div');
        item.className = 'activity-item';
          try {
        item.innerHTML = `
              <span>${activity.action || ''}</span>
              <span>${activity.timestamp ? new Date(activity.timestamp).toLocaleString() : ''}</span>
        `;
        activityList.appendChild(item);
          } catch (error) {
            console.error('Error creating activity item:', error, activity);
          }
      });
      } catch (error) {
        console.error('Error loading recent activity:', error);
      }
    }
    
    function addActivity(action) {
      const recentActivity = JSON.parse(localStorage.getItem('recentActivity') || '[]');
      recentActivity.unshift({
        action,
        timestamp: Date.now()
      });
      
      // Keep only last 50 activities
      if (recentActivity.length > 50) {
        recentActivity.pop();
      }
      
      localStorage.setItem('recentActivity', JSON.stringify(recentActivity));
      loadRecentActivity();
    }
    
    function setupDataHandlers() {
      const exportBtn = document.getElementById('export-progress');
      const importBtn = document.getElementById('import-progress');
      const importFile = document.getElementById('import-file');

      if (exportBtn && importBtn && importFile) {
        exportBtn.addEventListener('click', exportProgress);
        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', importProgress);
        console.log('Data handlers setup complete');
      } else {
        console.log('Some data handler elements not found, skipping setup');
      }
    }
    
    function exportProgress() {
      const data = {
        studyProgress,
        recentActivity: JSON.parse(localStorage.getItem('recentActivity') || '[]'),
        settings: JSON.parse(localStorage.getItem('koreanSettings') || '{}')
      };
      
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `korean-progress-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }
    
    function importProgress(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // Validate data structure
          if (data.studyProgress) {
            localStorage.setItem('koreanStudyProgress', JSON.stringify(data.studyProgress));
            studyProgress = data.studyProgress;
          }
          
          if (data.recentActivity) {
            localStorage.setItem('recentActivity', JSON.stringify(data.recentActivity));
          }
          
          if (data.settings) {
            localStorage.setItem('koreanSettings', JSON.stringify(data.settings));
          }
          
          // Refresh displays
          loadProgress();
          loadRecentActivity();
          
          alert('Progress imported successfully!');
        } catch (error) {
          alert('Error importing progress. Please check the file format.');
        }
      };
      reader.readAsText(file);
    }
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + / to show keyboard shortcuts
      if ((e.ctrlKey || e.metaKey) && e.key === '/') {
        e.preventDefault();
        showKeyboardShortcuts();
      }
      
      // Alt + 1-4 for navigation
      if (e.altKey && /[1-4]/.test(e.key)) {
        e.preventDefault();
        const sections = ['dictionary', 'study', 'progress', 'settings'];
        const index = parseInt(e.key) - 1;
        document.querySelector(`[data-section="${sections[index]}"]`).click();
      }
    });
    
    function showKeyboardShortcuts() {
      const shortcuts = `
        Keyboard Shortcuts:
        - Ctrl/Cmd + F: Search dictionary
        - Ctrl/Cmd + /: Show this help
        - Alt + 1: Dictionary
        - Alt + 2: Study
        - Alt + 3: Progress
        - Alt + 4: Settings
        - Space: Flip flashcard
        - Left/Right: Previous/Next flashcard
      `;
      
      alert(shortcuts);
    }
    
    // Initialize progress tracking when app loads
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize dictionary first
      console.log('DOM Content Loaded');
      
      // Make sure dictionary is loaded
      function checkDictionary() {
        console.log('Checking dictionary...');
        if (window.koreanDictionary && window.koreanDictionary.length > 0) {
          console.log('Dictionary loaded with', window.koreanDictionary.length, 'words');
      initializeProgress();
        } else {
          console.log('Dictionary not loaded yet, retrying...');
          setTimeout(checkDictionary, 500);
        }
      }
      
      // Start checking for dictionary
      checkDictionary();
    });

    // Add new words quiz functionality
    let newWordsQuizWords = [];
    let newWordsCurrentQuestionIndex = 0;
    let newWordsQuizScore = 0;
    let newWordsSelectedAnswer = null;
    let newWordsQuizStartTime;

    function initializeNewWordsQuiz() {
      // Reset quiz state
      document.getElementById('new-words-quiz-feedback').style.display = 'none';
      document.getElementById('new-words-quiz-feedback').className = 'quiz-feedback';
      
      // Get all words that haven't been studied yet
      const newWords = koreanDictionary.filter(word => !studyProgress[word.korean]);
      
      // If all words have been studied, include all words
      newWordsQuizWords = newWords.length > 0 ? newWords : [...koreanDictionary];
      
      // Shuffle the words
      newWordsQuizWords = shuffleArray(newWordsQuizWords);
      
      // Reset variables
      newWordsCurrentQuestionIndex = 0;
      
      // Start the quiz
      showNewWordsQuestion();
    }

    function showNewWordsQuestion() {
      const word = newWordsQuizWords[newWordsCurrentQuestionIndex];
      
      // Clear previous selections
      newWordsSelectedAnswer = null;
      document.getElementById('next-new-words-btn').disabled = false;
      document.getElementById('check-new-words-answer-btn').disabled = false;
      
      // Clear previous feedback
      document.getElementById('new-words-quiz-feedback').style.display = 'none';
      
      // Randomly choose question type (Korean to English or English to Korean)
      const isKoreanToEnglish = Math.random() < 0.5;
      
      const questionText = document.getElementById('new-words-question-text');
      const questionHint = document.getElementById('new-words-question-hint');
      
      if (isKoreanToEnglish) {
        questionText.textContent = word.korean;
        questionHint.textContent = `What does this word mean?`;
        
        // Get incorrect options (English translations)
        const incorrectOptions = getIncorrectOptions(word, 'translation');
        const allOptions = shuffleArray([word.translation, ...incorrectOptions]);
        createNewWordsAnswerOptions(allOptions);
        
      } else {
        questionText.textContent = word.translation;
        questionHint.textContent = `What's the Korean word for this?`;
        
        // Get incorrect options (Korean words)
        const incorrectOptions = getIncorrectOptions(word, 'korean');
        const allOptions = shuffleArray([word.korean, ...incorrectOptions]);
        createNewWordsAnswerOptions(allOptions);
      }
      
      // Set up audio button
      const audioBtn = document.getElementById('new-words-audio-btn');
      audioBtn.onclick = () => playPlainAudio(word.korean);
    }

    function createNewWordsAnswerOptions(options) {
      const answersContainer = document.getElementById('new-words-answers-container');
      answersContainer.innerHTML = '';
      
      options.forEach(option => {
        const answerBtn = document.createElement('div');
        answerBtn.className = 'answer-option';
        answerBtn.textContent = option;
        answerBtn.dataset.value = option;
        answerBtn.addEventListener('click', () => selectNewWordsAnswer(answerBtn));
        answersContainer.appendChild(answerBtn);
      });
    }

    function selectNewWordsAnswer(answerElement) {
      document.querySelectorAll('.answer-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      answerElement.classList.add('selected');
      newWordsSelectedAnswer = answerElement.dataset.value;
    }

    function checkNewWordsAnswer() {
      if (!newWordsSelectedAnswer) {
        alert('Please select an answer');
        return;
      }
      
      const word = newWordsQuizWords[newWordsCurrentQuestionIndex];
      const isKoreanToEnglish = word.korean !== newWordsSelectedAnswer;
      
      const correctAnswer = isKoreanToEnglish ? word.translation : word.korean;
      const isCorrect = newWordsSelectedAnswer === correctAnswer;
      
      // Update UI
      document.querySelectorAll('.answer-option').forEach(opt => {
        if (opt.dataset.value === correctAnswer) {
          opt.classList.add('correct');
        } else if (opt.dataset.value === newWordsSelectedAnswer && !isCorrect) {
          opt.classList.add('incorrect');
        }
      });
      
      // Show feedback
      const feedback = document.getElementById('new-words-quiz-feedback');
      
      if (isCorrect) {
        feedback.className = 'quiz-feedback correct';
        feedback.textContent = 'Correct! 👍';
        newWordsQuizScore++;
        document.getElementById('new-words-quiz-score').textContent = newWordsQuizScore;
      } else {
        feedback.className = 'quiz-feedback incorrect';
        feedback.textContent = `Incorrect. The correct answer is: ${correctAnswer}`;
      }
      
      // Add detailed feedback
      const detailedDiv = document.createElement('div');
      detailedDiv.style.marginTop = '15px';
      detailedDiv.style.backgroundColor = '#f8f9fa';
      detailedDiv.style.padding = '20px';
      detailedDiv.style.borderRadius = '10px';
      detailedDiv.style.textAlign = 'left';
      
      const wordInfo = document.createElement('div');
      wordInfo.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 15px;">Word Information:</div>
        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background-color: white; border-radius: 8px; flex-wrap: wrap;">
          <div style="font-weight: bold; font-size: 28px;">${word.korean}</div>
          <div style="color: #666; font-size: 18px;">(${word.pronunciation})</div>
          <div style="font-size: 18px;">${word.translation}</div>
          <button onclick="playPlainAudio('${word.korean}')" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 24px;">🔊</button>
        </div>
      `;
      
      detailedDiv.appendChild(wordInfo);
      
      if (word.example) {
        const exampleDiv = document.createElement('div');
        exampleDiv.innerHTML = `
          <div style="font-weight: bold; margin: 15px 0 10px;">Example:</div>
          <div style="background-color: #f5f5f5; padding: 15px; border-radius: 8px;">
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 16px;">${word.example.split('(')[0]}</div>
            <div style="font-style: italic; color: #666;">${word.example.split('(')[1]?.replace(')', '') || ''}</div>
          </div>
        `;
        detailedDiv.appendChild(exampleDiv);
      }
      
      feedback.appendChild(detailedDiv);
      feedback.style.display = 'block';
      
      // Update progress for this word
      if (!studyProgress[word.korean]) {
        studyProgress[word.korean] = { count: 0, lastReview: 0 };
      }
      studyProgress[word.korean].count++;
      studyProgress[word.korean].lastReview = Date.now();
      saveProgress();
      
      // Enable next button
      document.getElementById('check-new-words-answer-btn').disabled = true;
      document.getElementById('next-new-words-btn').disabled = false;
    }

    function nextNewWordsQuestion() {
      // Move to next word, or loop back to beginning if at end
      newWordsCurrentQuestionIndex = (newWordsCurrentQuestionIndex + 1) % newWordsQuizWords.length;
      showNewWordsQuestion();
    }

    // Update event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // ... existing initialization ...
      
      // Set up new words quiz
      document.getElementById('new-words-quiz-option').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'none';
        document.querySelector('.new-words-quiz-container').style.display = 'block';
        document.querySelector('.flashcard-container').style.display = 'none';
        document.querySelector('.quiz-container').style.display = 'none';
        document.querySelector('.writing-container').style.display = 'none';
        document.querySelector('.numbers-container').style.display = 'none';
        initializeNewWordsQuiz();
      });
      
      // Set up back button for new words quiz
      document.getElementById('back-from-new-words-quiz').addEventListener('click', () => {
        document.querySelector('.study-options').style.display = 'flex';
        document.querySelector('.new-words-quiz-container').style.display = 'none';
      });
      
      // New words quiz buttons
      document.getElementById('check-new-words-answer-btn').addEventListener('click', checkNewWordsAnswer);
      document.getElementById('next-new-words-btn').addEventListener('click', nextNewWordsQuestion);
    });

    // Add grammar and sentence practice functionality
    const sentenceQuizBank = [
      // Present Tense
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'I study Korean'", words: ["저는", "한국어를", "공부해요"], correct: "저는 한국어를 공부해요", translation: "I study Korean", wordExplanations: ["저는 = I", "한국어를 = Korean (object)", "공부해요 = study"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'You play soccer'", words: ["당신은", "축구를", "해요"], correct: "당신은 축구를 해요", translation: "You play soccer", wordExplanations: ["당신은 = You", "축구를 = soccer (object)", "해요 = play/do"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'She drinks milk'", words: ["그녀는", "우유를", "마셔요"], correct: "그녀는 우유를 마셔요", translation: "She drinks milk", wordExplanations: ["그녀는 = She", "우유를 = milk (object)", "마셔요 = drinks"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'We read books'", words: ["우리는", "책을", "읽어요"], correct: "우리는 책을 읽어요", translation: "We read books", wordExplanations: ["우리는 = We", "책을 = book (object)", "읽어요 = read"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'He eats rice'", words: ["그는", "밥을", "먹어요"], correct: "그는 밥을 먹어요", translation: "He eats rice", wordExplanations: ["그는 = He", "밥을 = rice (object)", "먹어요 = eats"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'They watch TV'", words: ["그들은", "텔레비전을", "봐요"], correct: "그들은 텔레비전을 봐요", translation: "They watch TV", wordExplanations: ["그들은 = They", "텔레비전을 = TV (object)", "봐요 = watch"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'I listen to music'", words: ["저는", "음악을", "들어요"], correct: "저는 음악을 들어요", translation: "I listen to music", wordExplanations: ["저는 = I", "음악을 = music (object)", "들어요 = listen"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'You write a letter'", words: ["당신은", "편지를", "써요"], correct: "당신은 편지를 써요", translation: "You write a letter", wordExplanations: ["당신은 = You", "편지를 = letter (object)", "써요 = write"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'We make bread'", words: ["우리는", "빵을", "만들어요"], correct: "우리는 빵을 만들어요", translation: "We make bread", wordExplanations: ["우리는 = We", "빵을 = bread (object)", "만들어요 = make"] },
      { level: 1, grammar: "Present Tense", prompt: "Make a sentence: 'She opens the door'", words: ["그녀는", "문을", "열어요"], correct: "그녀는 문을 열어요", translation: "She opens the door", wordExplanations: ["그녀는 = She", "문을 = door (object)", "열어요 = opens"] },
      // Past Tense
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'I ate breakfast'", words: ["저는", "아침을", "먹었어요"], correct: "저는 아침을 먹었어요", translation: "I ate breakfast", wordExplanations: ["저는 = I", "아침을 = breakfast (object)", "먹었어요 = ate"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'He went home'", words: ["그는", "집에", "갔어요"], correct: "그는 집에 갔어요", translation: "He went home", wordExplanations: ["그는 = He", "집에 = home (object)", "갔어요 = went"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'They watched a movie'", words: ["그들은", "영화를", "봤어요"], correct: "그들은 영화를 봤어요", translation: "They watched a movie", wordExplanations: ["그들은 = They", "영화를 = movie (object)", "봤어요 = watched"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'We met yesterday'", words: ["우리는", "어제", "만났어요"], correct: "우리는 어제 만났어요", translation: "We met yesterday", wordExplanations: ["우리는 = We", "어제 = yesterday (object)", "만났어요 = met"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'She bought shoes'", words: ["그녀는", "신발을", "샀어요"], correct: "그녀는 신발을 샀어요", translation: "She bought shoes", wordExplanations: ["그녀는 = She", "신발을 = shoes (object)", "샀어요 = bought"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'You wrote a letter'", words: ["당신은", "편지를", "썼어요"], correct: "당신은 편지를 썼어요", translation: "You wrote a letter", wordExplanations: ["당신은 = You", "편지를 = letter (object)", "썼어요 = wrote"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'I read a book'", words: ["저는", "책을", "읽었어요"], correct: "저는 책을 읽었어요", translation: "I read a book", wordExplanations: ["저는 = I", "책을 = book (object)", "읽었어요 = read"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'We made bread'", words: ["우리는", "빵을", "만들었어요"], correct: "우리는 빵을 만들었어요", translation: "We made bread", wordExplanations: ["우리는 = We", "빵을 = bread (object)", "만들었어요 = made"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'He closed the door'", words: ["그는", "문을", "닫았어요"], correct: "그는 문을 닫았어요", translation: "He closed the door", wordExplanations: ["그는 = He", "문을 = door (object)", "닫았어요 = closed"] },
      { level: 2, grammar: "Past Tense", prompt: "Make a sentence: 'She drank milk'", words: ["그녀는", "우유를", "마셨어요"], correct: "그녀는 우유를 마셨어요", translation: "She drank milk", wordExplanations: ["그녀는 = She", "우유를 = milk (object)", "마셨어요 = drank"] },
      // Future Tense
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'I will call you'", words: ["제가", "당신에게", "전화할 거예요"], correct: "제가 당신에게 전화할 거예요", translation: "I will call you", wordExplanations: ["제가 = I", "당신에게 = you (object)", "전화할 거예요 = will call"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'She will study tomorrow'", words: ["그녀는", "내일", "공부할 거예요"], correct: "그녀는 내일 공부할 거예요", translation: "She will study tomorrow", wordExplanations: ["그녀는 = She", "내일 = tomorrow (object)", "공부할 거예요 = will study"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'We will travel to Korea'", words: ["우리는", "한국에", "여행할 거예요"], correct: "우리는 한국에 여행할 거예요", translation: "We will travel to Korea", wordExplanations: ["우리는 = We", "한국에 = Korean (object)", "여행할 거예요 = will travel"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'He will buy a car'", words: ["그는", "차를", "살 거예요"], correct: "그는 차를 살 거예요", translation: "He will buy a car", wordExplanations: ["그는 = He", "차를 = car (object)", "살 거예요 = will buy"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'They will meet tomorrow'", words: ["그들은", "내일", "만날 거예요"], correct: "그들은 내일 만날 거예요", translation: "They will meet tomorrow", wordExplanations: ["그들은 = They", "내일 = tomorrow (object)", "만날 거예요 = will meet"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'I will eat dinner'", words: ["저는", "저녁을", "먹을 거예요"], correct: "저는 저녁을 먹을 거예요", translation: "I will eat dinner", wordExplanations: ["저는 = I", "저녁을 = dinner (object)", "먹을 거예요 = will eat"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'You will write a letter'", words: ["당신은", "편지를", "쓸 거예요"], correct: "당신은 편지를 쓸 거예요", translation: "You will write a letter", wordExplanations: ["당신은 = You", "편지를 = letter (object)", "쓸 거예요 = will write"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'We will make bread'", words: ["우리는", "빵을", "만들 거예요"], correct: "우리는 빵을 만들 거예요", translation: "We will make bread", wordExplanations: ["우리는 = We", "빵을 = bread (object)", "만들 거예요 = will make"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'She will open the door'", words: ["그녀는", "문을", "열 거예요"], correct: "그녀는 문을 열 거예요", translation: "She will open the door", wordExplanations: ["그녀는 = She", "문을 = door (object)", "열 거예요 = will open"] },
      { level: 3, grammar: "Future Tense", prompt: "Make a sentence: 'He will drink milk'", words: ["그는", "우유를", "마실 거예요"], correct: "그는 우유를 마실 거예요", translation: "He will drink milk", wordExplanations: ["그는 = He", "우유를 = milk (object)", "마실 거예요 = will drink"] },
      // Negation
      { level: 2, grammar: "Negation", prompt: "Make a sentence: 'I don't like coffee'", words: ["저는", "커피를", "안 좋아해요"], correct: "저는 커피를 안 좋아해요", translation: "I don't like coffee", wordExplanations: ["저는 = I", "커피를 = coffee (object)", "안 좋아해요 = don't like"] },
      { level: 2, grammar: "Negation", prompt: "Make a sentence: 'He doesn't eat meat'", words: ["그는", "고기를", "안 먹어요"], correct: "그는 고기를 안 먹어요", translation: "He doesn't eat meat", wordExplanations: ["그는 = He", "고기를 = meat (object)", "안 먹어요 = doesn't eat"] },
      { level: 2, grammar: "Negation", prompt: "Make a sentence: 'We don't watch TV'", words: ["우리는", "텔레비전을", "안 봐요"], correct: "우리는 텔레비전을 안 봐요", translation: "We don't watch TV", wordExplanations: ["우리는 = We", "텔레비전을 = TV (object)", "안 봐요 = don't watch"] },
      { level: 2, grammar: "Negation", prompt: "Make a sentence: 'She doesn't drink milk'", words: ["그녀는", "우유를", "안 마셔요"], correct: "그녀는 우유를 안 마셔요", translation: "She doesn't drink milk", wordExplanations: ["그녀는 = She", "우유를 = milk (object)", "안 마셔요 = doesn't drink"] },
      { level: 2, grammar: "Negation", prompt: "Make a sentence: 'I don't write letters'", words: ["저는", "편지를", "안 써요"], correct: "저는 편지를 안 써요", translation: "I don't write letters", wordExplanations: ["저는 = I", "편지를 = letters (object)", "안 써요 = don't write"] },
      { level: 2, grammar: "Negation", prompt: "Make a sentence: 'They don't make bread'", words: ["그들은", "빵을", "안 만들어요"], correct: "그들은 빵을 안 만들어요", translation: "They don't make bread", wordExplanations: ["그들은 = They", "빵을 = bread (object)", "안 만들어요 = don't make"] },
      // Questions
      { level: 2, grammar: "Questions", prompt: "Make a sentence: 'Where do you live?'", words: ["어디에", "살아요?", "당신은"], correct: "당신은 어디에 살아요?", translation: "Where do you live?", wordExplanations: ["어디에 = Where", "살아요? = are you living?", "당신은 = You"] },
      { level: 2, grammar: "Questions", prompt: "Make a sentence: 'What are you doing?'", words: ["뭐", "하고", "있어요?"], correct: "뭐 하고 있어요?", translation: "What are you doing?", wordExplanations: ["뭐 = What", "하고 = and", "있어요? = are you doing?"] },
      { level: 2, grammar: "Questions", prompt: "Make a sentence: 'When will you come?'", words: ["언제", "올", "거예요?"], correct: "언제 올 거예요?", translation: "When will you come?", wordExplanations: ["언제 = When", "올 = you (object)", "거예요? = will you come?"] },
      { level: 2, grammar: "Questions", prompt: "Make a sentence: 'Who is coming?'", words: ["누가", "오고", "있어요?"], correct: "누가 오고 있어요?", translation: "Who is coming?", wordExplanations: ["누가 = Who", "오고 = are you coming?", "있어요? = are you coming?"] },
      { level: 2, grammar: "Questions", prompt: "Make a sentence: 'Why are you laughing?'", words: ["왜", "웃고", "있어요?"], correct: "왜 웃고 있어요?", translation: "Why are you laughing?", wordExplanations: ["왜 = Why", "웃고 = are you laughing?", "있어요? = are you laughing?"] },
      { level: 2, grammar: "Questions", prompt: "Make a sentence: 'How do you go to school?'", words: ["어떻게", "학교에", "가요?"], correct: "어떻게 학교에 가요?", translation: "How do you go to school?", wordExplanations: ["어떻게 = How", "학교에 = Korean (object)", "가요? = do you go to school?"] },
      // Add more as needed for variety and challenge
    ];

    let userStreak = 0;
    let currentDifficulty = 1;
    let currentQuizIndex = null;

    function getNextQuizIndex() {
      // Filter questions by currentDifficulty or lower
      const available = sentenceQuizBank.filter(q => q.level <= currentDifficulty);
      // If user is doing well, increase difficulty
      if (userStreak >= 3 && currentDifficulty < 6) {
        currentDifficulty++;
        userStreak = 0;
      }
      // If user is struggling, decrease difficulty
      if (userStreak <= -2 && currentDifficulty > 1) {
        currentDifficulty--;
        userStreak = 0;
      }
      // Pick a random question from available
      const idx = Math.floor(Math.random() * available.length);
      return sentenceQuizBank.indexOf(available[idx]);
    }

    // Add a grammar explanation map for each structure
    const grammarExplanations = {
      "Present Tense": "Present tense: verb stem + -아요/-어요. Example: 먹다 → 먹어요 (eat)",
      "Past Tense": "Past tense: verb stem + -았어요/-었어요. Example: 가다 → 갔어요 (went)",
      "Future Tense": "Future tense: verb stem + -ㄹ/을 거예요. Example: 가다 → 갈 거예요 (will go)",
      "Negation": "Negation: 안 + verb or verb stem + -지 않아요. Example: 안 먹어요 (don't eat)",
      "Questions": "Questions: add a question word or ?. Example: 어디에 가요? (Where are you going?)"
    };

    function showGrammarLesson() {
      // Pick a new quiz
      currentQuizIndex = getNextQuizIndex();
      const quiz = sentenceQuizBank[currentQuizIndex];
      // Show grammar structure/point as a heading
      document.getElementById('grammar-title').textContent = quiz.grammar;
      // Show grammar explanation if available
      document.getElementById('grammar-content').innerHTML = grammarExplanations[quiz.grammar] || '';
      document.getElementById('sentence-prompt').textContent = quiz.prompt;
      // Shuffle word bank every time
      const shuffled = quiz.words.slice().sort(() => Math.random() - 0.5);
      const wordBank = document.getElementById('word-bank');
      wordBank.innerHTML = '';
      shuffled.forEach((word, idx) => {
        const wordElement = document.createElement('div');
        wordElement.className = 'word-item';
        wordElement.textContent = word;
        wordElement.onclick = function() {
          // Move word to answer area
          addWordToSentence(word, idx);
          wordElement.style.visibility = 'hidden';
        };
        wordBank.appendChild(wordElement);
      });
      document.getElementById('sentence-construction').innerHTML = '';
      document.getElementById('sentence-feedback').style.display = 'none';
    }

    function addWordToSentence(word, idx) {
      const construction = document.getElementById('sentence-construction');
      const wordElement = document.createElement('div');
      wordElement.className = 'word-item';
      wordElement.textContent = word;
      wordElement.onclick = function() {
        // Remove word from answer area and make it visible again in word bank
        construction.removeChild(wordElement);
        document.getElementById('word-bank').children[idx].style.visibility = 'visible';
      };
      construction.appendChild(wordElement);
    }

    document.getElementById('check-sentence-btn').onclick = function() {
      const construction = document.getElementById('sentence-construction');
      const userSentence = Array.from(construction.children)
        .map(word => word.textContent)
        .join(' ');
      const quiz = sentenceQuizBank[currentQuizIndex];
      const correctSentence = quiz.correct;
      const feedback = document.getElementById('sentence-feedback');
      if (userSentence === correctSentence) {
        feedback.className = 'sentence-feedback correct';
        feedback.textContent = 'Correct! Well done!';
        userStreak++;
      } else {
        feedback.className = 'sentence-feedback incorrect';
        feedback.textContent = `Incorrect. The correct sentence is: ${correctSentence}`;
        userStreak--;
      }
      feedback.style.display = 'block';
      // Show per-word explanation and translation
      let explainDiv = document.getElementById('sentence-explanation');
      if (!explainDiv) {
        explainDiv = document.createElement('div');
        explainDiv.id = 'sentence-explanation';
        feedback.parentNode.insertBefore(explainDiv, feedback.nextSibling);
      }
      explainDiv.innerHTML = `<div style='margin-top:10px;'><b>Translation:</b> ${quiz.translation || ''}</div>`;
      if (quiz.wordExplanations) {
        explainDiv.innerHTML += `<div style='margin-top:5px;'><b>Word breakdown:</b><ul style='margin:5px 0 0 20px;'>${quiz.wordExplanations.map(w => `<li>${w}</li>`).join('')}</ul></div>`;
      }
    };

    document.getElementById('clear-sentence-btn').onclick = function() {
      document.getElementById('sentence-construction').innerHTML = '';
      // Make all word bank words visible again
      Array.from(document.getElementById('word-bank').children).forEach(el => el.style.visibility = 'visible');
      document.getElementById('sentence-feedback').style.display = 'none';
    };

    document.getElementById('next-sentence-btn').onclick = function() {
      showGrammarLesson();
    };

    // Add grammar option to study options
    document.querySelector('.study-options').innerHTML += `
      <div class="study-card" onclick="showSection('grammar')">
        <h3>Grammar & Sentences</h3>
        <p>Learn Korean grammar and practice making sentences</p>
      </div>
    `;

    // Update showSection function to handle grammar section
    function showSection(section) {
      // Hide all study containers
      document.querySelector('.flashcard-container').style.display = 'none';
      document.querySelector('.quiz-container').style.display = 'none';
      document.querySelector('.writing-container').style.display = 'none';
      document.querySelector('.numbers-container').style.display = 'none';
      document.querySelector('.grammar-container').style.display = 'none';
      document.querySelector('.study-options').style.display = 'none';

      // Show the selected section
      if (section === 'flashcard') {
        document.querySelector('.flashcard-container').style.display = 'block';
      } else if (section === 'quiz') {
        document.querySelector('.quiz-container').style.display = 'block';
      } else if (section === 'writing') {
        document.querySelector('.writing-container').style.display = 'block';
      } else if (section === 'numbers') {
        document.querySelector('.numbers-container').style.display = 'block';
      } else if (section === 'grammar') {
        document.querySelector('.grammar-container').style.display = 'block';
        showGrammarLesson();
      }
    }
    // Add event listener for back button in grammar section
    document.getElementById('back-from-grammar').onclick = function(e) {
      e.preventDefault();
      document.querySelector('.grammar-container').style.display = 'none';
      document.querySelector('.study-options').style.display = 'flex';
    };

    // List of grammar topics
    const grammarTopics = [
      { key: "Present Tense", label: "Present Tense" },
      { key: "Past Tense", label: "Past Tense" },
      { key: "Future Tense", label: "Future Tense" },
      { key: "Negation", label: "Negation" },
      { key: "Questions", label: "Questions" }
    ];

    // Add a grammar topic selection UI
    const grammarContainer = document.querySelector('.grammar-container');
    let selectedGrammarTopic = null;

    function showGrammarTopicSelection() {
      selectedGrammarTopic = null;
      grammarContainer.innerHTML = `
        <div class="study-header">
          <a href="#" class="back-btn" id="back-from-grammar">← Back to Study Options</a>
          <div id="grammar-progress"></div>
        </div>
        <div class="grammar-topic-list" style="margin: 30px 0 0 0;">
          <h2 style="margin-bottom: 20px;">Choose a Grammar Topic</h2>
          <div style="display: flex; flex-wrap: nowrap; gap: 20px; overflow-x: auto;">
            ${grammarTopics.map(topic => `<button class="grammar-topic-btn" data-topic="${topic.key}" style="padding: 18px 32px; font-size: 18px; border-radius: 8px; border: 1px solid #5782BB; background: #f8f9fa; color: #5782BB; cursor: pointer; transition: background 0.2s;">${topic.label}</button>`).join('')}
          </div>
        </div>
      `;
      document.getElementById('back-from-grammar').onclick = function(e) {
        e.preventDefault();
        grammarContainer.style.display = 'none';
        document.querySelector('.study-options').style.display = 'flex';
      };
      Array.from(document.querySelectorAll('.grammar-topic-btn')).forEach(btn => {
        btn.onclick = function() {
          selectedGrammarTopic = btn.getAttribute('data-topic');
          showGrammarLesson();
        };
      });
    }

    // Update showGrammarLesson to use selectedGrammarTopic
    function showGrammarLesson() {
      if (!selectedGrammarTopic) {
        showGrammarTopicSelection();
        return;
      }
      // Filter questions by selected topic
      const topicQuestions = sentenceQuizBank.filter(q => q.grammar === selectedGrammarTopic);
      if (topicQuestions.length === 0) {
        grammarContainer.innerHTML = `<div class="study-header"><a href="#" class="back-btn" id="back-from-grammar">← Back to Topics</a></div><div style="margin: 40px 0;">No questions for this topic yet.</div>`;
        document.getElementById('back-from-grammar').onclick = function(e) {
          e.preventDefault();
          showGrammarTopicSelection();
        };
        return;
      }
      // Pick a random question from the topic
      currentQuizIndex = Math.floor(Math.random() * topicQuestions.length);
      const quiz = topicQuestions[currentQuizIndex];
      grammarContainer.innerHTML = `
        <div class="study-header">
          <a href="#" class="back-btn" id="back-from-grammar">← Back to Topics</a>
          <div id="grammar-progress"></div>
        </div>
        <div class="grammar-lesson">
          <div class="grammar-explanation">
            <h3 id="grammar-title">${quiz.grammar}</h3>
            <div class="grammar-content" id="grammar-content">${grammarExplanations[quiz.grammar] || ''}</div>
          </div>
          <div class="sentence-practice">
            <h3>Practice Making Sentences</h3>
            <div class="sentence-builder">
              <div class="sentence-prompt" id="sentence-prompt">${quiz.prompt}</div>
              <div class="word-bank" id="word-bank"></div>
              <div class="sentence-construction" id="sentence-construction"></div>
              <div class="sentence-controls">
                <button class="grammar-btn" id="check-sentence-btn">Check Sentence</button>
                <button class="grammar-btn" id="clear-sentence-btn">Clear</button>
                <button class="grammar-btn" id="next-sentence-btn">Next Practice</button>
              </div>
              <div class="sentence-feedback" id="sentence-feedback"></div>
            </div>
          </div>
        </div>
      `;
      // Set up word bank and answer area
      const shuffled = quiz.words.slice().sort(() => Math.random() - 0.5);
      const wordBank = document.getElementById('word-bank');
      shuffled.forEach((word, idx) => {
        const wordElement = document.createElement('div');
        wordElement.className = 'word-item';
        wordElement.textContent = word;
        wordElement.onclick = function() {
          addWordToSentence(word, idx);
          wordElement.style.visibility = 'hidden';
        };
        wordBank.appendChild(wordElement);
      });
      document.getElementById('sentence-construction').innerHTML = '';
      document.getElementById('sentence-feedback').style.display = 'none';
      // Button handlers
      document.getElementById('check-sentence-btn').onclick = function() {
        const construction = document.getElementById('sentence-construction');
        const userSentence = Array.from(construction.children)
          .map(word => word.textContent)
          .join(' ');
        const correctSentence = quiz.correct;
        const feedback = document.getElementById('sentence-feedback');
        if (userSentence === correctSentence) {
          feedback.className = 'sentence-feedback correct';
          feedback.textContent = 'Correct! Well done!';
        } else {
          feedback.className = 'sentence-feedback incorrect';
          feedback.textContent = `Incorrect. The correct sentence is: ${correctSentence}`;
        }
        feedback.style.display = 'block';
        // Show per-word explanation and translation
        let explainDiv = document.getElementById('sentence-explanation');
        if (!explainDiv) {
          explainDiv = document.createElement('div');
          explainDiv.id = 'sentence-explanation';
          feedback.parentNode.insertBefore(explainDiv, feedback.nextSibling);
        }
        explainDiv.innerHTML = `<div style='margin-top:10px;'><b>Translation:</b> ${quiz.translation || ''}</div>`;
        if (quiz.wordExplanations) {
          explainDiv.innerHTML += `<div style='margin-top:5px;'><b>Word breakdown:</b><ul style='margin:5px 0 0 20px;'>${quiz.wordExplanations.map(w => `<li>${w}</li>`).join('')}</ul></div>`;
        }
      };
      document.getElementById('clear-sentence-btn').onclick = function() {
        document.getElementById('sentence-construction').innerHTML = '';
        Array.from(document.getElementById('word-bank').children).forEach(el => el.style.visibility = 'visible');
        document.getElementById('sentence-feedback').style.display = 'none';
        let explainDiv = document.getElementById('sentence-explanation');
        if (explainDiv) explainDiv.innerHTML = '';
      };
      document.getElementById('next-sentence-btn').onclick = function() {
        showGrammarLesson();
      };
      document.getElementById('back-from-grammar').onclick = function(e) {
        e.preventDefault();
        showGrammarTopicSelection();
      };
    }

    // Update showSection to show topic selection first
    function showSection(section) {
      // Hide all study containers
      document.querySelector('.flashcard-container').style.display = 'none';
      document.querySelector('.quiz-container').style.display = 'none';
      document.querySelector('.writing-container').style.display = 'none';
      document.querySelector('.numbers-container').style.display = 'none';
      document.querySelector('.grammar-container').style.display = 'none';
      document.querySelector('.study-options').style.display = 'none';

      // Show the selected section
      if (section === 'flashcard') {
        document.querySelector('.flashcard-container').style.display = 'block';
      } else if (section === 'quiz') {
        document.querySelector('.quiz-container').style.display = 'block';
      } else if (section === 'writing') {
        document.querySelector('.writing-container').style.display = 'block';
      } else if (section === 'numbers') {
        document.querySelector('.numbers-container').style.display = 'block';
      } else if (section === 'grammar') {
        document.querySelector('.grammar-container').style.display = 'block';
        showGrammarTopicSelection();
      }
    }
  </script>
</body>
    // Quiz functionality
    function startQuiz(quizWords) {
      const quizContainer = document.getElementById('quiz-container');
      if (!quizContainer) {
        console.error('Quiz container not found');
        return;
      }

      let currentWordIndex = 0;
      let score = 0;

      function showNextWord() {
        if (currentWordIndex >= quizWords.length) {
          // Quiz finished
          quizContainer.innerHTML = `
            <h2>Quiz Complete!</h2>
            <p>Your score: ${score} out of ${quizWords.length}</p>
            <button onclick="startNewWordsQuiz()">Try Another Quiz</button>
          `;
          return;
        }

        const currentWord = quizWords[currentWordIndex];
        const otherWords = koreanDictionary
          .filter(w => w.korean !== currentWord.korean)
          .sort(() => Math.random() - 0.5)
          .slice(0, 3);
        
        const allOptions = [...otherWords, currentWord]
          .sort(() => Math.random() - 0.5);

        quizContainer.innerHTML = `
          <div class="quiz-word">
            <h3>${currentWord.korean}</h3>
            <button class="audio-button" onclick="playPlainAudio('${currentWord.korean}')">
              <span class="audio-indicator"></span>Listen
            </button>
          </div>
          <div class="quiz-options">
            ${allOptions.map((word, index) => `
              <button class="quiz-option" onclick="checkAnswer(${index}, '${currentWord.english.replace(/'/g, "\\'")}')"}>
                ${word.english}
              </button>
            `).join('')}
          </div>
          <p>Question ${currentWordIndex + 1} of ${quizWords.length}</p>
        `;
      }

      window.checkAnswer = function(index, correctAnswer) {
        const selectedOption = document.querySelectorAll('.quiz-option')[index];
        const allOptions = document.querySelectorAll('.quiz-option');
        
        allOptions.forEach(opt => opt.disabled = true);
        
        if (selectedOption.textContent.trim() === correctAnswer) {
          selectedOption.classList.add('correct');
          score++;
        } else {
          selectedOption.classList.add('incorrect');
          Array.from(allOptions).find(opt => 
            opt.textContent.trim() === correctAnswer
          ).classList.add('correct');
        }

        setTimeout(() => {
          currentWordIndex++;
          showNextWord();
        }, 1500);
      };

      showNextWord();
    }
  </script>
</body>
</html> 
